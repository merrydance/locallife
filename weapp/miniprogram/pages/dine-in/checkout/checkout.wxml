<!--堂食/预订结算页面 - 使用 TDesign 组件-->
<custom-navbar title="{{orderType === 'dine_in' ? '堂食结账' : '预订结算'}}" showBack="{{true}}" bind:navheight="onNavHeight" />

<view class="page-container" style="padding-top: {{navBarHeight}}px;">
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-wrapper">
    <t-loading theme="circular" size="48rpx" text="加载订单中..." />
  </view>

  <!-- 主内容 -->
  <scroll-view wx:else scroll-y class="main-scroll" enhanced show-scrollbar="{{false}}">
    
    <!-- 商户信息 -->
    <view class="section-card merchant-section" wx:if="{{merchantInfo}}">
      <view class="merchant-row">
        <t-image 
          src="{{merchantInfo.logo_url}}" 
          mode="aspectFill" 
          width="100rpx" 
          height="100rpx" 
          shape="round"
          class="merchant-logo"
        />
        <view class="merchant-info">
          <text class="merchant-name">{{merchantInfo.name}}</text>
          <text class="merchant-address">{{merchantInfo.address || ''}}</text>
        </view>
      </view>
    </view>

    <!-- 用餐信息 -->
    <view class="section-card">
      <view class="section-title">用餐信息</view>
      <t-cell-group theme="card">
        <t-cell 
          title="桌台编号" 
          note="{{tableInfo.table_number || tableInfo.table_no || '待分配'}}" 
          t-class-title="cell-label"
          t-class-note="cell-value"
        />
        
        <!-- 预订场景显示预约信息 -->
        <block wx:if="{{orderType === 'reservation' && reservationInfo}}">
          <t-cell title="预约日期" note="{{reservationInfo.reservation_date}}" t-class-title="cell-label" t-class-note="cell-value" />
          <t-cell title="预约时间" note="{{reservationInfo.reservation_time}}" t-class-title="cell-label" t-class-note="cell-value" />
          <t-cell title="联系人" note="{{reservationInfo.contact_name}}" t-class-title="cell-label" t-class-note="cell-value" />
          <t-cell title="联系电话" note="{{reservationInfo.contact_phone}}" t-class-title="cell-label" t-class-note="cell-value" />
        </block>

        <t-cell title="就餐人数" t-class-title="cell-label">
          <t-stepper 
            slot="note"
            value="{{diningInfo.guest_count}}" 
            min="{{1}}" 
            max="{{20}}"
            theme="filled"
            size="small"
            bind:change="onGuestCountChange"
          />
        </t-cell>
      </t-cell-group>
    </view>

    <!-- 已选菜品 -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">已选菜品</text>
        <text class="item-count">共 {{cart.total_count || 0}} 件</text>
      </view>
      
      <view class="items-list">
        <view wx:for="{{cart.items}}" wx:key="id" class="order-item">
          <t-image 
            src="{{item.dish_image || item.image_url}}" 
            mode="aspectFill" 
            width="120rpx" 
            height="120rpx" 
            shape="round"
          />
          <view class="item-content">
            <view class="item-top-row">
              <text class="item-name">{{item.name}}</text>
              <text class="item-price">¥{{item.priceDisplay}}</text>
            </view>
            <view class="item-bottom-row">
              <text class="item-spec">{{item.spec_text || '标准'}}</text>
              <text class="item-qty">×{{item.quantity}}</text>
            </view>
          </view>
        </view>
        
        <t-empty wx:if="{{!cart.items || cart.items.length === 0}}" description="暂无菜品" />
      </view>
    </view>

    <!-- 优惠券 -->
    <view class="section-card">
      <t-cell 
        title="优惠券" 
        arrow 
        hover 
        bind:click="onShowVouchers"
        note="{{selectedVoucher ? selectedVoucher.title : '选择可用优惠券'}}"
        t-class-note="{{selectedVoucher ? 'voucher-selected' : 'voucher-placeholder'}}"
      />
    </view>

    <!-- 费用明细 -->
    <view class="section-card price-section">
      <view class="section-title">费用明细</view>
      <view class="price-row">
        <text class="price-label">商品合计</text>
        <text class="price-value">¥{{calculation.subtotalDisplay || '0.00'}}</text>
      </view>
      <view class="price-row" wx:if="{{calculation.discount_amount > 0}}">
        <text class="price-label">优惠减免</text>
        <text class="price-value discount">-¥{{calculation.discountDisplay}}</text>
      </view>
      <view class="price-row total-row">
        <text class="price-label bold">应付金额</text>
        <text class="price-value total">¥{{calculation.totalDisplay || '0.00'}}</text>
      </view>
    </view>

    <!-- 备注 -->
    <view class="section-card">
      <view class="section-title">订单备注</view>
      <t-textarea 
        placeholder="有什么特殊要求吗？(选填)"
        value="{{remark}}"
        maxlength="{{200}}"
        disableDefaultPadding="{{true}}"
        indicator
        bind:change="onRemarkChange"
        t-class="remark-textarea"
      />
    </view>

    <!-- 支付方式 -->
    <view class="section-card">
      <view class="section-title">支付方式</view>
      <t-radio-group value="{{selectedPaymentMethod}}" bind:change="onPaymentMethodChange">
        <t-cell-group theme="card">
          <t-cell 
            wx:for="{{paymentMethods}}" 
            wx:key="id" 
            title="{{item.name}}"
            leftIcon="{{item.icon}}"
            hover
          >
            <t-radio slot="right-icon" value="{{item.id}}" icon="circle" />
          </t-cell>
        </t-cell-group>
      </t-radio-group>
    </view>

    <!-- 底部占位 -->
    <view class="bottom-placeholder"></view>
  </scroll-view>

  <!-- 底部提交栏 -->
  <view class="submit-bar" wx:if="{{!loading}}">
    <view class="submit-left">
      <text class="submit-label">应付：</text>
      <text class="submit-price">¥{{calculation.totalDisplay || '0.00'}}</text>
    </view>
    <t-button 
      theme="primary" 
      size="large" 
      shape="round"
      loading="{{submitting}}"
      disabled="{{!cart.items || cart.items.length === 0}}"
      bind:tap="onSubmitOrder"
      class="submit-btn"
    >
      提交订单
    </t-button>
  </view>
</view>

<!-- 优惠券选择弹窗 -->
<t-popup 
  visible="{{voucherVisible}}" 
  placement="bottom" 
  bind:visible-change="onVoucherPopupChange"
>
  <view class="voucher-popup">
    <view class="popup-header">
      <text class="popup-title">选择优惠券</text>
      <t-icon name="close" size="44rpx" bind:click="closeVoucherPopup" />
    </view>
    
    <scroll-view scroll-y class="voucher-scroll">
      <!-- 加载中 -->
      <view wx:if="{{voucherLoading}}" class="voucher-loading">
        <t-loading theme="circular" size="40rpx" text="加载中..." />
      </view>
      
      <block wx:else>
        <!-- 不使用优惠券选项 -->
        <view 
          class="voucher-item {{!selectedVoucher ? 'selected' : ''}}"
          bind:tap="onClearVoucher"
        >
          <view class="voucher-content">
            <text class="voucher-title">不使用优惠券</text>
          </view>
          <t-icon wx:if="{{!selectedVoucher}}" name="check" color="#0052d9" size="40rpx" />
        </view>
        
        <!-- 优惠券列表 -->
        <view 
          wx:for="{{vouchers}}" 
          wx:key="id" 
          class="voucher-item {{selectedVoucher && selectedVoucher.id === item.id ? 'selected' : ''}}"
          bind:tap="onSelectVoucher"
          data-voucher="{{item}}"
        >
          <view class="voucher-amount">
            <text class="currency">¥</text>
            <text class="amount">{{item.value / 100}}</text>
          </view>
          <view class="voucher-content">
            <text class="voucher-title">{{item.title}}</text>
            <text class="voucher-condition">满{{item.min_spend / 100}}元可用</text>
          </view>
          <t-icon wx:if="{{selectedVoucher && selectedVoucher.id === item.id}}" name="check" color="#0052d9" size="40rpx" />
        </view>
        
        <t-empty wx:if="{{vouchers.length === 0}}" description="暂无可用优惠券" />
      </block>
    </scroll-view>
  </view>
</t-popup>