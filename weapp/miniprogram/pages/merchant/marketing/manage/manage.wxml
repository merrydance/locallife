<!--营销活动管理页面-->
<!-- 手机端引导 -->
<match-media max-width="749">
  <view class="lds-mobile-guidance lds-root">
    <view class="guidance-box">
      <t-icon name="discount" size="100px" color="var(--lds-primary)" />
      <view class="lds-text-lg lds-m-b-2">营销管理中心</view>
      <view class="lds-text-secondary lds-m-b-4">优惠券和会员充值规则的创建与管理建议在平板或电脑端操作。</view>
      <t-button block theme="primary" variant="outline" shape="round" bindtap="onBack">返回工作台</t-button>
    </view>
  </view>
</match-media>

<!-- 平板及桌面端：完整营销管理界面 -->
<match-media min-width="750">
<view class="marketing-container">

  <!-- 加载状态 -->
  <t-loading wx:if="{{loading}}" theme="circular" size="40rpx" text="正在加载..." class="loading-container" />

  <!-- 主要内容 -->
  <view wx:else class="main-content">
    <!-- Tab导航 -->
    <t-tabs value="{{currentTab}}" bind:change="onTabChange" class="marketing-tabs">
      <t-tab-panel label="优惠券管理" value="voucher" />
      <t-tab-panel label="充值规则" value="recharge" />
      <t-tab-panel label="会员设置" value="membership" />
    </t-tabs>

    <!-- 优惠券管理 -->
    <view wx:if="{{currentTab === 'voucher'}}" class="tab-content">
      <view class="action-bar">
        <t-button theme="primary" size="medium" icon="add" bind:tap="showCreateVoucherModal">
          创建优惠券
        </t-button>
      </view>

      <scroll-view class="voucher-list" scroll-y="true">
        <t-empty wx:if="{{vouchers.length === 0}}" description="暂无优惠券" />

        <view wx:else class="voucher-items">
          <view wx:for="{{vouchers}}" wx:key="id" class="voucher-card">
            <view class="card-header">
              <view class="voucher-info">
                <text class="voucher-name">{{item.name}}</text>
                <t-tag 
                  theme="{{getVoucherStatusColor(item) === '#52c41a' ? 'success' : 'default'}}"
                  size="small"
                >
                  {{getVoucherStatusText(item)}}
                </t-tag>
              </view>
              <text class="voucher-value">{{formatDiscountValue(item.discount_type, item.discount_value)}}</text>
            </view>

            <view class="card-body">
              <view class="info-row">
                <text class="label">最低消费：</text>
                <text class="value">¥{{formatAmount(item.min_order_amount)}}</text>
              </view>
              <view class="info-row">
                <text class="label">适用类型：</text>
                <text class="value">{{formatOrderTypes(item.applicable_order_types)}}</text>
              </view>
              <view class="info-row">
                <text class="label">发行量：</text>
                <text class="value">{{item.total_quantity}}张</text>
              </view>
              <view class="info-row">
                <text class="label">已领取：</text>
                <text class="value">{{item.claimed_quantity}}张</text>
              </view>
              <view class="info-row">
                <text class="label">有效期：</text>
                <text class="value">{{item.valid_from}} 至 {{item.valid_until}}</text>
              </view>
            </view>

            <view class="card-footer">
              <t-button 
                theme="danger" 
                size="small" 
                variant="outline"
                data-id="{{item.id}}" 
                bind:tap="deleteVoucher"
              >
                删除
              </t-button>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- 充值规则管理 -->
    <view wx:if="{{currentTab === 'recharge'}}" class="tab-content">
      <view class="action-bar">
        <t-button theme="primary" size="medium" icon="add" bind:tap="showCreateRechargeModal">
          创建充值规则
        </t-button>
      </view>

      <scroll-view class="recharge-list" scroll-y="true">
        <t-empty wx:if="{{rechargeRules.length === 0}}" description="暂无充值规则" />

        <view wx:else class="recharge-items">
          <view wx:for="{{rechargeRules}}" wx:key="id" class="recharge-card">
            <view class="card-header">
              <view class="recharge-info">
                <text class="recharge-title">充¥{{formatAmount(item.recharge_amount)}} 送¥{{formatAmount(item.bonus_amount)}}</text>
                <t-tag 
                  theme="{{item.is_active ? 'success' : 'default'}}"
                  size="small"
                >
                  {{getRechargeRuleStatusText(item)}}
                </t-tag>
              </view>
              <text class="bonus-rate">赠送{{calculateBonusRate(item.recharge_amount, item.bonus_amount)}}</text>
            </view>

            <view wx:if="{{item.description}}" class="card-body">
              <text class="description">{{item.description}}</text>
            </view>

            <view class="card-footer">
              <t-button 
                theme="danger" 
                size="small" 
                variant="outline"
                data-id="{{item.id}}" 
                bind:tap="deleteRechargeRule"
              >
                删除
              </t-button>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- 会员设置管理 -->
    <view wx:if="{{currentTab === 'membership'}}" class="tab-content">
      <view class="action-bar">
        <t-button theme="primary" size="medium" icon="edit" bind:tap="showEditMembershipModal">
          编辑设置
        </t-button>
      </view>

      <view wx:if="{{membershipSettings}}" class="membership-settings">
        <t-cell-group title="余额使用场景">
          <t-cell 
            title="{{formatOrderTypes(membershipSettings.balance_usage_scenarios)}}" 
          />
        </t-cell-group>

        <t-cell-group title="赠送金使用场景">
          <t-cell 
            title="{{formatOrderTypes(membershipSettings.bonus_usage_scenarios)}}" 
          />
        </t-cell-group>

        <t-cell-group title="优惠叠加">
          <t-cell 
            title="{{membershipSettings.allow_stacking_discounts ? '允许叠加优惠' : '不允许叠加优惠'}}" 
          />
        </t-cell-group>

        <t-cell-group title="最低充值金额">
          <t-cell 
            title="¥{{formatAmount(membershipSettings.min_recharge_amount)}}" 
          />
        </t-cell-group>
      </view>
    </view>
  </view>

  <!-- 创建优惠券弹窗 -->
  <t-popup 
    visible="{{showVoucherModal}}" 
    placement="bottom" 
    bind:visible-change="closeVoucherModal"
    class="form-popup"
  >
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">创建优惠券</text>
        <t-icon name="close" size="32rpx" bind:tap="closeVoucherModal" />
      </view>

      <scroll-view class="modal-body" scroll-y="true">
        <t-cell-group>
          <t-cell title="优惠券名称">
            <t-input 
              slot="note"
              placeholder="请输入优惠券名称" 
              value="{{voucherForm.name}}"
              data-field="name"
              bind:change="onVoucherFormInput"
            />
          </t-cell>

          <t-cell title="折扣类型">
            <t-radio-group 
              slot="note"
              value="{{voucherForm.discount_type}}"
              data-field="discount_type"
              bind:change="onVoucherFormInput"
            >
              <t-radio wx:for="{{discountTypeOptions}}" wx:key="value" value="{{item.value}}">
                {{item.label}}
              </t-radio>
            </t-radio-group>
          </t-cell>

          <t-cell title="折扣值">
            <t-input 
              slot="note"
              type="number"
              placeholder="立减金额(分)或折扣(10=1折)" 
              value="{{voucherForm.discount_value}}"
              data-field="discount_value"
              bind:change="onVoucherFormInput"
            />
          </t-cell>

          <t-cell title="最低消费(分)">
            <t-input 
              slot="note"
              type="number"
              placeholder="请输入最低消费金额" 
              value="{{voucherForm.min_order_amount}}"
              data-field="min_order_amount"
              bind:change="onVoucherFormInput"
            />
          </t-cell>

          <t-cell title="发行量">
            <t-input 
              slot="note"
              type="number"
              placeholder="请输入发行量" 
              value="{{voucherForm.total_quantity}}"
              data-field="total_quantity"
              bind:change="onVoucherFormInput"
            />
          </t-cell>
        </t-cell-group>
      </scroll-view>

      <view class="modal-footer">
        <t-button theme="light" bind:tap="closeVoucherModal">取消</t-button>
        <t-button theme="primary" bind:tap="createVoucher">创建</t-button>
      </view>
    </view>
  </t-popup>

  <!-- 创建充值规则弹窗 -->
  <t-popup 
    visible="{{showRechargeModal}}" 
    placement="center" 
    bind:visible-change="closeRechargeModal"
    class="form-popup"
  >
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">创建充值规则</text>
        <t-icon name="close" size="32rpx" bind:tap="closeRechargeModal" />
      </view>

      <view class="modal-body">
        <t-cell-group>
          <t-cell title="充值金额(分)">
            <t-input 
              slot="note"
              type="number"
              placeholder="请输入充值金额" 
              value="{{rechargeForm.recharge_amount}}"
              data-field="recharge_amount"
              bind:change="onRechargeFormInput"
            />
          </t-cell>

          <t-cell title="赠送金额(分)">
            <t-input 
              slot="note"
              type="number"
              placeholder="请输入赠送金额" 
              value="{{rechargeForm.bonus_amount}}"
              data-field="bonus_amount"
              bind:change="onRechargeFormInput"
            />
          </t-cell>

          <t-cell title="规则描述">
            <t-input 
              slot="note"
              placeholder="请输入规则描述" 
              value="{{rechargeForm.description}}"
              data-field="description"
              bind:change="onRechargeFormInput"
            />
          </t-cell>
        </t-cell-group>
      </view>

      <view class="modal-footer">
        <t-button theme="light" bind:tap="closeRechargeModal">取消</t-button>
        <t-button theme="primary" bind:tap="createRechargeRule">创建</t-button>
      </view>
    </view>
  </t-popup>

  <!-- 编辑会员设置弹窗 -->
  <t-popup 
    visible="{{showMembershipModal}}" 
    placement="center" 
    bind:visible-change="closeMembershipModal"
    class="form-popup"
  >
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">编辑会员设置</text>
        <t-icon name="close" size="32rpx" bind:tap="closeMembershipModal" />
      </view>

      <view class="modal-body">
        <t-cell-group>
          <t-cell title="最低充值金额(分)">
            <t-input 
              slot="note"
              type="number"
              placeholder="请输入最低充值金额" 
              value="{{membershipForm.min_recharge_amount}}"
            />
          </t-cell>

          <t-cell title="允许叠加优惠">
            <t-switch 
              slot="note"
              value="{{membershipForm.allow_stacking_discounts}}"
            />
          </t-cell>
        </t-cell-group>
      </view>

      <view class="modal-footer">
        <t-button theme="light" bind:tap="closeMembershipModal">取消</t-button>
        <t-button theme="primary" bind:tap="updateMembershipSettings">保存</t-button>
      </view>
    </view>
  </t-popup>
</view>
</match-media>

