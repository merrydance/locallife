<!-- ä¼šå‘˜ç®¡ç†é¡µé¢ - PC-SaaS å¸ƒå±€ -->
<wxs module="utils">
  module.exports = {
    formatAmount: function(fen) {
      return (fen / 100).toFixed(2)
    },
    formatDate: function(dateStr) {
      if (!dateStr) return '-'
      return dateStr.slice(0, 10)
    },
    formatTxType: function(type) {
      var map = {
        'recharge': 'å……å€¼',
        'consume': 'æ¶ˆè´¹',
        'refund': 'é€€æ¬¾',
        'adjustment_credit': 'ä½™é¢å¢åŠ ',
        'adjustment_debit': 'ä½™é¢æ‰£å‡'
      }
      return map[type] || type
    }
  }
</wxs>

<!-- å°å±æç¤º -->
<match-media max-width="1599">
  <view class="desktop-only-notice">
    <view class="notice-box">
      <view class="notice-icon">ğŸ‘¥</view>
      <text class="notice-title">æ­¤åŠŸèƒ½éœ€è¦åœ¨ç”µè„‘ç«¯ä½¿ç”¨</text>
      <text class="notice-desc">è¯·ä½¿ç”¨ 1600px ä»¥ä¸Šåˆ†è¾¨ç‡çš„æ˜¾ç¤ºå™¨è®¿é—®ä¼šå‘˜ç®¡ç†</text>
      <navigator url="/pages/merchant/dashboard/index" class="btn-back">è¿”å›å·¥ä½œå°</navigator>
    </view>
  </view>
</match-media>

<!-- å¤§å±å¸ƒå±€ -->
<match-media min-width="1600">
  <view class="saas-layout">
    <!-- ä¾§è¾¹æ  -->

    <!-- ä¸»åŒºåŸŸ -->
    <view class="main-area" style="margin-left: 0;">
      <!-- é¡¶éƒ¨æ  -->

      <!-- é¡µé¢å†…å®¹ -->
      <view class="page-container">
        <!-- é¡µé¢æ ‡é¢˜æ  -->
        <view class="page-header">
          <view class="page-title">
            <text class="title-icon">ğŸ‘¥</text>
            <text class="title-text">ä¼šå‘˜ç®¡ç†</text>
          </view>
        </view>

        <!-- åŠ è½½çŠ¶æ€ -->
        <view wx:if="{{loading}}" class="loading-state">
          <view class="loading-spinner"></view>
          <text>åŠ è½½ä¸­...</text>
        </view>

        <!-- ä¼šå‘˜åˆ—è¡¨ -->
        <view wx:else class="member-list">
          <!-- ç©ºçŠ¶æ€ -->
          <view wx:if="{{members.length === 0}}" class="empty-state">
            <text class="empty-icon">ğŸ“­</text>
            <text class="empty-text">æš‚æ— ä¼šå‘˜</text>
            <text class="empty-hint">å½“ç”¨æˆ·å……å€¼æˆä¸ºæ‚¨çš„ä¼šå‘˜åï¼Œå°†åœ¨æ­¤æ˜¾ç¤º</text>
          </view>

          <!-- ä¼šå‘˜è¡¨æ ¼ -->
          <view wx:else class="member-table">
            <view class="table-header">
              <text class="col-name">ä¼šå‘˜</text>
              <text class="col-phone">æ‰‹æœºå·</text>
              <text class="col-balance">ä½™é¢</text>
              <text class="col-recharged">ç´¯è®¡å……å€¼</text>
              <text class="col-consumed">ç´¯è®¡æ¶ˆè´¹</text>
              <text class="col-date">åŠ å…¥æ—¶é—´</text>
              <text class="col-action">æ“ä½œ</text>
            </view>
            <view 
              wx:for="{{members}}" 
              wx:key="membership_id" 
              class="table-row"
            >
              <view class="col-name">
                <image wx:if="{{item.avatar_url}}" class="member-avatar" src="{{item.avatar_url}}" mode="aspectFill" />
                <view wx:else class="member-avatar-placeholder">ğŸ‘¤</view>
                <text class="member-name">{{item.full_name || 'åŒ¿åç”¨æˆ·'}}</text>
              </view>
              <text class="col-phone">{{item.phone || '-'}}</text>
              <text class="col-balance balance-value">Â¥{{utils.formatAmount(item.balance)}}</text>
              <text class="col-recharged">Â¥{{utils.formatAmount(item.total_recharged)}}</text>
              <text class="col-consumed">Â¥{{utils.formatAmount(item.total_consumed)}}</text>
              <text class="col-date">{{utils.formatDate(item.created_at)}}</text>
              <view class="col-action">
                <button class="btn-sm btn-primary" data-user-id="{{item.user_id}}" bindtap="onViewMember">è¯¦æƒ…</button>
              </view>
            </view>
          </view>

          <!-- åŠ è½½æ›´å¤š -->
          <view wx:if="{{members.length > 0}}" class="load-more">
            <button wx:if="{{hasMore}}" class="btn-outline" bindtap="onLoadMore">åŠ è½½æ›´å¤š</button>
            <text wx:else class="no-more">æ²¡æœ‰æ›´å¤šäº†</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</match-media>

<!-- ä¼šå‘˜è¯¦æƒ…å¼¹çª— -->
<view wx:if="{{showDetailModal}}" class="modal-mask" bindtap="onCloseDetail">
  <view class="modal-content detail-modal" catchtap>
    <view class="modal-header">
      <text class="modal-title">ä¼šå‘˜è¯¦æƒ…</text>
      <view class="modal-close" bindtap="onCloseDetail">Ã—</view>
    </view>
    
    <view wx:if="{{detailLoading}}" class="modal-loading">
      <view class="loading-spinner"></view>
    </view>
    
    <view wx:elif="{{selectedMember}}" class="modal-body">
      <!-- ä¼šå‘˜ä¿¡æ¯ -->
      <view class="detail-section">
        <view class="detail-row">
          <image wx:if="{{selectedMember.avatar_url}}" class="detail-avatar" src="{{selectedMember.avatar_url}}" mode="aspectFill" />
          <view wx:else class="detail-avatar-placeholder">ğŸ‘¤</view>
          <view class="detail-info">
            <text class="detail-name">{{selectedMember.full_name || 'åŒ¿åç”¨æˆ·'}}</text>
            <text class="detail-phone">{{selectedMember.phone || 'æœªç»‘å®šæ‰‹æœº'}}</text>
          </view>
        </view>
      </view>

      <!-- ä½™é¢ä¿¡æ¯ -->
      <view class="detail-section balance-section">
        <view class="balance-card">
          <text class="balance-label">å½“å‰ä½™é¢</text>
          <text class="balance-amount">Â¥{{utils.formatAmount(selectedMember.balance)}}</text>
        </view>
        <view class="balance-stats">
          <view class="stat-item">
            <text class="stat-label">ç´¯è®¡å……å€¼</text>
            <text class="stat-value">Â¥{{utils.formatAmount(selectedMember.total_recharged)}}</text>
          </view>
          <view class="stat-item">
            <text class="stat-label">ç´¯è®¡æ¶ˆè´¹</text>
            <text class="stat-value">Â¥{{utils.formatAmount(selectedMember.total_consumed)}}</text>
          </view>
        </view>
        <button class="btn-primary btn-adjust" data-user-id="{{selectedMember.user_id}}" bindtap="onOpenAdjust">è°ƒæ•´ä½™é¢</button>
      </view>

      <!-- äº¤æ˜“è®°å½• -->
      <view class="detail-section">
        <text class="section-title">æœ€è¿‘äº¤æ˜“</text>
        <view wx:if="{{selectedMember.transactions.length === 0}}" class="no-transactions">
          æš‚æ— äº¤æ˜“è®°å½•
        </view>
        <view wx:else class="transaction-list">
          <view wx:for="{{selectedMember.transactions}}" wx:key="id" class="transaction-item">
            <view class="tx-left">
              <text class="tx-type">{{utils.formatTxType(item.type)}}</text>
              <text class="tx-notes">{{item.notes || '-'}}</text>
            </view>
            <view class="tx-right">
              <text class="tx-amount {{item.amount >= 0 ? 'positive' : 'negative'}}">
                {{item.amount >= 0 ? '+' : ''}}Â¥{{utils.formatAmount(item.amount)}}
              </text>
              <text class="tx-date">{{utils.formatDate(item.created_at)}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- ä½™é¢è°ƒæ•´å¼¹çª— -->
<view wx:if="{{showAdjustModal}}" class="modal-mask" bindtap="onCloseAdjust">
  <view class="modal-content adjust-modal" catchtap>
    <view class="modal-header">
      <text class="modal-title">è°ƒæ•´ä½™é¢</text>
      <view class="modal-close" bindtap="onCloseAdjust">Ã—</view>
    </view>
    
    <view class="modal-body">
      <!-- è°ƒæ•´ç±»å‹ -->
      <view class="form-group">
        <text class="form-label">è°ƒæ•´ç±»å‹</text>
        <view class="type-selector">
          <view 
            class="type-option {{adjustForm.type === 'add' ? 'active' : ''}}" 
            data-type="add" 
            bindtap="onAdjustTypeChange"
          >
            <text class="type-icon">â•</text>
            <text>å¢åŠ ä½™é¢</text>
          </view>
          <view 
            class="type-option {{adjustForm.type === 'deduct' ? 'active' : ''}}" 
            data-type="deduct" 
            bindtap="onAdjustTypeChange"
          >
            <text class="type-icon">â–</text>
            <text>æ‰£å‡ä½™é¢</text>
          </view>
        </view>
      </view>

      <!-- é‡‘é¢ -->
      <view class="form-group">
        <text class="form-label">é‡‘é¢ï¼ˆå…ƒï¼‰</text>
        <input 
          class="form-input" 
          type="digit" 
          placeholder="è¯·è¾“å…¥é‡‘é¢" 
          value="{{adjustForm.amount}}"
          bindinput="onAmountInput"
        />
      </view>

      <!-- å¤‡æ³¨ -->
      <view class="form-group">
        <text class="form-label">è°ƒæ•´åŸå› </text>
        <textarea 
          class="form-textarea" 
          placeholder="è¯·è¾“å…¥è°ƒæ•´åŸå› ï¼Œå¦‚ï¼šé€€æ¬¾ã€è¡¥å¿ç­‰" 
          value="{{adjustForm.notes}}"
          bindinput="onNotesInput"
        />
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn-cancel" bindtap="onCloseAdjust">å–æ¶ˆ</button>
      <button class="btn-primary" disabled="{{adjusting}}" bindtap="onSubmitAdjust">
        {{adjusting ? 'å¤„ç†ä¸­...' : 'ç¡®è®¤è°ƒæ•´'}}
      </button>
    </view>
  </view>
</view>
