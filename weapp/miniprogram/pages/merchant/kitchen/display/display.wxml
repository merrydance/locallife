<!--KDS后厨显示系统页面-->
<!-- 手机端/小屏引导 -->
<match-media max-width="1279">
  <view class="lds-mobile-guidance lds-root">
    <view class="guidance-box">
      <t-icon name="desktop" size="100px" color="var(--lds-primary)" />
      <view class="lds-text-lg lds-m-b-2">后厨显示系统</view>
      <view class="lds-text-secondary lds-m-b-4">KDS 后厨订单管理系统专为大屏幕设计，请在电脑端使用以获得最佳体验。</view>
      <t-button block theme="primary" variant="outline" shape="round" bindtap="onBack">返回工作台</t-button>
    </view>
  </view>
</match-media>

<!-- PC-Full (>=1600px) - SaaS布局 -->
<match-media min-width="1600">
  <view class="pc-saas-layout">
    <!-- 侧边栏 -->
    <merchant-sidebar 
      current-path="kitchen" 
      collapsed="{{sidebarCollapsed}}"
      bind:collapse="onSidebarCollapse"
    />

    <!-- 主区域 -->
    <view class="saas-main" style="margin-left: {{sidebarCollapsed ? 64 : 200}}px;">
      <!-- 顶部栏 -->
      <merchant-header 
        merchant-name="{{merchantName}}"
        is-open="{{isOpen}}"
        sidebar-width="{{sidebarCollapsed ? 64 : 200}}"
      />

      <!-- KDS主内容 -->
      <view class="saas-kds-content">


  <!-- 加载状态 -->
  <t-loading wx:if="{{loading}}" theme="circular" size="60rpx" text="正在加载..." class="loading-container" />

  <!-- 主要内容 -->
  <view wx:else class="main-content">
    <!-- 顶部工具栏 -->
    <view class="toolbar">
      <view class="toolbar-left">
        <text class="title">后厨订单管理</text>
        <t-tag theme="primary" size="medium">待处理: {{stats.total_pending}}</t-tag>
        <t-tag wx:if="{{stats.orders_behind_schedule > 0}}" theme="danger" size="medium">
          超时: {{stats.orders_behind_schedule}}
        </t-tag>
      </view>
      
      <view class="toolbar-right">
        <t-button 
          theme="{{voiceEnabled ? 'primary' : 'default'}}" 
          size="small" 
          icon="sound"
          bind:tap="toggleVoice"
        >
          {{voiceEnabled ? '语音开' : '语音关'}}
        </t-button>
        
        <t-button 
          theme="{{autoRefresh ? 'primary' : 'default'}}" 
          size="small" 
          icon="refresh"
          bind:tap="toggleAutoRefresh"
        >
          {{autoRefresh ? '自动刷新' : '手动刷新'}}
        </t-button>
        
        <t-button 
          theme="light" 
          size="small" 
          icon="refresh"
          bind:tap="refreshOrders"
        >
          刷新
        </t-button>
      </view>
    </view>

    <!-- 统计信息 -->
    <view class="stats-bar">
      <view class="stat-item">
        <text class="stat-label">平均制作时间</text>
        <text class="stat-value">{{stats.avg_preparation_time}}分钟</text>
      </view>
    </view>

    <!-- 订单看板 -->
    <view class="order-board">
      <!-- 新订单列 -->
      <view class="order-column">
        <view class="column-header new-header">
          <t-icon name="notification" size="32rpx" />
          <text class="column-title">新订单 ({{newOrders.length}})</text>
        </view>
        
        <scroll-view class="column-content" scroll-y="true">
          <t-empty wx:if="{{newOrders.length === 0}}" description="暂无新订单" />
          
          <view 
            wx:for="{{newOrders}}" 
            wx:key="id"
            class="order-card new-order"
            bind:tap="viewOrderDetail"
            data-id="{{item.id}}"
          >
            <view class="card-header">
              <text class="order-no">{{item.order_no}}</text>
              <t-tag theme="warning" size="small">{{item.order_type}}</t-tag>
            </view>
            
            <view wx:if="{{item.table_number}}" class="table-info">
              <t-icon name="location" size="28rpx" />
              <text>桌号: {{item.table_number}}</text>
            </view>
            
            <view class="order-items">
              <view wx:for="{{item.items}}" wx:for-item="dish" wx:key="dish_name" class="dish-item">
                <text class="dish-name">{{dish.dish_name}}</text>
                <text class="dish-quantity">x{{dish.quantity}}</text>
              </view>
            </view>
            
            <view wx:if="{{item.notes}}" class="order-notes">
              <t-icon name="info-circle" size="24rpx" />
              <text>{{item.notes}}</text>
            </view>
            
            <view class="card-footer">
              <text class="order-time">{{formatTime(item.created_at)}}</text>
              <t-button 
                theme="primary" 
                size="small" 
                data-id="{{item.id}}" 
                bind:tap="startPreparing"
                catchtap="stopPropagation"
              >
                开始制作
              </t-button>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- 制作中列 -->
      <view class="order-column">
        <view class="column-header preparing-header">
          <t-icon name="time" size="32rpx" />
          <text class="column-title">制作中 ({{preparingOrders.length}})</text>
        </view>
        
        <scroll-view class="column-content" scroll-y="true">
          <t-empty wx:if="{{preparingOrders.length === 0}}" description="暂无制作中订单" />
          
          <view 
            wx:for="{{preparingOrders}}" 
            wx:key="id"
            class="order-card preparing-order {{isOrderOverdue(item) ? 'overdue' : ''}}"
            bind:tap="viewOrderDetail"
            data-id="{{item.id}}"
          >
            <view class="card-header">
              <text class="order-no">{{item.order_no}}</text>
              <t-tag 
                theme="{{isOrderOverdue(item) ? 'danger' : 'primary'}}" 
                size="small"
              >
                {{getRemainingTime(item)}}
              </t-tag>
            </view>
            
            <view wx:if="{{item.table_number}}" class="table-info">
              <t-icon name="location" size="28rpx" />
              <text>桌号: {{item.table_number}}</text>
            </view>
            
            <view class="order-items">
              <view wx:for="{{item.items}}" wx:for-item="dish" wx:key="dish_name" class="dish-item">
                <text class="dish-name">{{dish.dish_name}}</text>
                <text class="dish-quantity">x{{dish.quantity}}</text>
              </view>
            </view>
            
            <view wx:if="{{item.notes}}" class="order-notes">
              <t-icon name="info-circle" size="24rpx" />
              <text>{{item.notes}}</text>
            </view>
            
            <view class="card-footer">
              <text class="order-time">开始: {{formatTime(item.preparing_started_at)}}</text>
              <t-button 
                theme="success" 
                size="small" 
                data-id="{{item.id}}" 
                bind:tap="markOrderReady"
                catchtap="stopPropagation"
              >
                制作完成
              </t-button>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- 待取餐列 -->
      <view class="order-column">
        <view class="column-header ready-header">
          <t-icon name="check-circle" size="32rpx" />
          <text class="column-title">待取餐 ({{readyOrders.length}})</text>
        </view>
        
        <scroll-view class="column-content" scroll-y="true">
          <t-empty wx:if="{{readyOrders.length === 0}}" description="暂无待取餐订单" />
          
          <view 
            wx:for="{{readyOrders}}" 
            wx:key="id"
            class="order-card ready-order"
            bind:tap="viewOrderDetail"
            data-id="{{item.id}}"
          >
            <view class="card-header">
              <text class="order-no">{{item.order_no}}</text>
              <t-tag theme="success" size="small">已完成</t-tag>
            </view>
            
            <view wx:if="{{item.table_number}}" class="table-info">
              <t-icon name="location" size="28rpx" />
              <text>桌号: {{item.table_number}}</text>
            </view>
            
            <view class="order-items">
              <view wx:for="{{item.items}}" wx:for-item="dish" wx:key="dish_name" class="dish-item">
                <text class="dish-name">{{dish.dish_name}}</text>
                <text class="dish-quantity">x{{dish.quantity}}</text>
              </view>
            </view>
            
            <view class="card-footer">
              <text class="order-time">完成: {{formatTime(item.ready_at)}}</text>
            </view>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>

  <!-- 订单详情弹窗 -->
  <t-popup 
    visible="{{showDetailModal}}" 
    placement="center" 
    bind:visible-change="closeDetailModal"
    class="detail-popup"
  >
    <view wx:if="{{selectedOrder}}" class="modal-content">
      <view class="modal-header">
        <text class="modal-title">订单详情</text>
        <t-icon name="close" size="32rpx" bind:tap="closeDetailModal" />
      </view>
      
      <scroll-view class="modal-body" scroll-y="true">
        <t-cell-group title="订单信息">
          <t-cell title="订单号" note="{{selectedOrder.order_no}}" />
          <t-cell title="订单类型" note="{{selectedOrder.order_type}}" />
          <t-cell title="订单状态" note="{{selectedOrder.status}}" />
          <t-cell wx:if="{{selectedOrder.table_number}}" title="桌号" note="{{selectedOrder.table_number}}" />
          <t-cell wx:if="{{selectedOrder.customer_name}}" title="顾客" note="{{selectedOrder.customer_name}}" />
          <t-cell title="下单时间" note="{{selectedOrder.created_at}}" />
          <t-cell wx:if="{{selectedOrder.preparing_started_at}}" title="开始制作" note="{{selectedOrder.preparing_started_at}}" />
          <t-cell wx:if="{{selectedOrder.ready_at}}" title="制作完成" note="{{selectedOrder.ready_at}}" />
        </t-cell-group>

        <t-cell-group title="商品明细">
          <t-cell 
            wx:for="{{selectedOrder.items}}" 
            wx:key="dish_name"
            title="{{item.dish_name}}"
            note="x{{item.quantity}}"
          >
            <view wx:if="{{item.customizations && item.customizations.length > 0}}" slot="description">
              <text wx:for="{{item.customizations}}" wx:for-item="custom" wx:key="custom">
                {{custom}}
              </text>
            </view>
            <text wx:if="{{item.notes}}" slot="description">备注: {{item.notes}}</text>
          </t-cell>
        </t-cell-group>

        <t-cell-group wx:if="{{selectedOrder.notes}}" title="订单备注">
          <t-cell title="{{selectedOrder.notes}}" />
        </t-cell-group>
      </scroll-view>
    </view>
  </t-popup>
      </view><!-- saas-kds-content -->
    </view><!-- saas-main -->
  </view><!-- pc-saas-layout -->
</match-media>

<!-- 中等屏幕 (1280px - 1599px) - 无侧边栏的原有KDS布局 -->
<match-media min-width="1280" max-width="1599">
  <view class="kds-container">
    <include src="./templates/kds-content.wxml" />
  </view>
</match-media>

