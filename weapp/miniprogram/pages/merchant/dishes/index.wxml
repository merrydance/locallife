<!-- èœå“ç®¡ç† - æ¡Œé¢çº§ SaaS ç•Œé¢ -->

<!-- WXS æ¨¡å— - å¤„ç†æ•°ç»„æ“ä½œ -->
<wxs module="utils">
  module.exports = {
    contains: function(arr, id) {
      if (!arr || !arr.length) return false;
      for (var i = 0; i < arr.length; i++) {
        if (arr[i] === id) return true;
      }
      return false;
    }
  }
</wxs>

<match-media max-width="1599">
  <view class="desktop-only-notice">
    <view class="notice-box">
      <view class="notice-icon">ğŸ–¥ï¸</view>
      <text class="notice-title">æ­¤åŠŸèƒ½éœ€è¦åœ¨ç”µè„‘ç«¯ä½¿ç”¨</text>
      <text class="notice-desc">è¯·ä½¿ç”¨ 1600px ä»¥ä¸Šåˆ†è¾¨ç‡çš„æ˜¾ç¤ºå™¨è®¿é—®èœå“ç®¡ç†</text>
      <button class="btn-back" bindtap="goBack">è¿”å›å·¥ä½œå°</button>
    </view>
  </view>
</match-media>

<match-media min-width="1600">
  <view class="saas-layout">
    <!-- ä¾§è¾¹æ  -->
    <merchant-sidebar 
      current-path="dishes" 
      collapsed="{{sidebarCollapsed}}"
      bind:collapse="onSidebarCollapse"
    />

    <!-- ä¸»åŒºåŸŸ -->
    <view class="main-area" style="margin-left: {{sidebarCollapsed ? 64 : 200}}px;">
      <!-- é¡¶éƒ¨æ  -->
      <merchant-header 
        merchant-name="{{merchantName}}"
        is-open="{{isOpen}}"
        sidebar-width="{{sidebarCollapsed ? 64 : 200}}"
      />

      <!-- é¡µé¢å†…å®¹ -->
      <view class="page-container">
        <!-- å·¦ä¾§åˆ†ç±»å¯¼èˆª -->
        <view class="category-nav">
          <view class="nav-header">
            <text class="nav-title">èœå“åˆ†ç±»</text>
            <view class="btn-add-category" bindtap="onOpenCategoryManager">âš™ï¸</view>
          </view>
          <scroll-view class="nav-list" scroll-y>
            <view 
              wx:for="{{categories}}" 
              wx:key="id" 
              class="nav-item {{activeCategoryId === item.id ? 'active' : ''}}"
              bindtap="onCategoryChange"
              data-id="{{item.id}}"
            >
              <text class="nav-label">{{item.name}}</text>
              <text class="nav-count" wx:if="{{item.dish_count}}">{{item.dish_count}}</text>
            </view>
          </scroll-view>
        </view>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <view class="content-area">
          <!-- å·¥å…·æ  -->
          <view class="toolbar">
            <view class="search-box">
              <input 
                class="search-input" 
                placeholder="æœç´¢èœå“åç§°..." 
                value="{{searchKeyword}}"
                bindinput="onSearch"
              />
            </view>
            <view class="toolbar-actions">
              <button 
                class="btn-secondary {{isMultiSelectMode ? 'active' : ''}}" 
                bindtap="onToggleMultiSelect"
              >
                {{isMultiSelectMode ? 'å–æ¶ˆå¤šé€‰' : 'æ‰¹é‡æ“ä½œ'}}
              </button>
              <button class="btn-primary" bindtap="onAddDish">+ æ·»åŠ èœå“</button>
            </view>
          </view>

          <!-- èœå“åˆ—è¡¨ -->
          <view class="dishes-content">
            <!-- å·¦ä¾§èœå“åˆ—è¡¨ -->
            <view class="dishes-list">
              <view wx:if="{{loading}}" class="loading-state">
                <text>åŠ è½½ä¸­...</text>
              </view>
              <view wx:elif="{{dishes.length === 0}}" class="empty-state">
                <text class="empty-icon">ğŸ½ï¸</text>
                <text class="empty-text">æš‚æ— èœå“</text>
              </view>
              <scroll-view wx:else class="dish-scroll" scroll-y>
                <view 
                  wx:for="{{dishes}}" 
                  wx:key="id" 
                  class="dish-card {{selectedDish.id === item.id ? 'selected' : ''}} {{isMultiSelectMode && utils.contains(selectedDishIds, item.id) ? 'checked' : ''}}"
                  bindtap="onDishTap"
                  data-item="{{item}}"
                  data-id="{{item.id}}"
                >
                  <!-- å¤šé€‰å¤é€‰æ¡† -->
                  <view wx:if="{{isMultiSelectMode}}" class="dish-checkbox">
                    <view class="checkbox {{utils.contains(selectedDishIds, item.id) ? 'checked' : ''}}">
                      <text wx:if="{{utils.contains(selectedDishIds, item.id)}}">âœ“</text>
                    </view>
                  </view>
                  <image 
                    class="dish-image" 
                    src="{{item.image_url || '/assets/images/dish-placeholder.png'}}" 
                    mode="aspectFill"
                  />
                  <view class="dish-info">
                    <view class="dish-name-row">
                      <text class="dish-name">{{item.name}}</text>
                      <view class="dish-status {{item.is_online ? 'online' : 'offline'}}">
                        {{item.is_online ? 'åœ¨å”®' : 'ä¸‹æ¶'}}
                      </view>
                    </view>
                    <view class="dish-meta">
                      <text class="dish-price">Â¥{{item.price / 100}}</text>
                      <text class="dish-category" wx:if="{{item.category_name}}">{{item.category_name}}</text>
                    </view>
                  </view>
                </view>
              </scroll-view>

              <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
              <view wx:if="{{isMultiSelectMode}}" class="batch-toolbar">
                <view class="batch-info">
                  <text>å·²é€‰ {{selectedDishIds.length}} é¡¹</text>
                  <text class="batch-select-all" bindtap="onSelectAll">
                    {{selectedDishIds.length === dishes.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
                  </text>
                </view>
                <view class="batch-actions">
                  <button 
                    class="btn-batch online" 
                    bindtap="onBatchOnline" 
                    disabled="{{selectedDishIds.length === 0}}"
                  >
                    æ‰¹é‡ä¸Šæ¶
                  </button>
                  <button 
                    class="btn-batch offline" 
                    bindtap="onBatchOffline" 
                    disabled="{{selectedDishIds.length === 0}}"
                  >
                    æ‰¹é‡ä¸‹æ¶
                  </button>
                </view>
              </view>
            </view>

            <!-- å³ä¾§ç¼–è¾‘é¢æ¿ -->
            <view class="editor-panel">
              <view wx:if="{{!selectedDish && !isAdding}}" class="editor-placeholder">
                <text class="placeholder-icon">ğŸ‘†</text>
                <text class="placeholder-text">é€‰æ‹©èœå“è¿›è¡Œç¼–è¾‘</text>
              </view>

              <view wx:else class="editor-content">
                <view class="editor-header">
                  <text class="editor-title">{{isAdding ? 'æ·»åŠ èœå“' : 'ç¼–è¾‘èœå“'}}</text>
                  <view class="editor-actions">
                    <button class="btn-cancel" bindtap="onCancelEdit">å–æ¶ˆ</button>
                    <button class="btn-save" bindtap="onSaveDish" disabled="{{saving}}">
                      {{saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}}
                    </button>
                  </view>
                </view>

                <view class="editor-form">
                  <!-- åŸºæœ¬ä¿¡æ¯ -->
                  <view class="form-section">
                    <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
                    
                    <view class="form-group">
                      <label class="form-label">èœå“åç§° <text class="required">*</text></label>
                      <input 
                        class="form-input" 
                        placeholder="è¯·è¾“å…¥èœå“åç§°" 
                        value="{{selectedDish.name}}"
                        data-field="name"
                        bindinput="onFieldChange"
                      />
                    </view>

                    <view class="form-group">
                      <label class="form-label">æ‰€å±åˆ†ç±»</label>
                      <view class="custom-select" bindtap="onToggleCategoryDropdown">
                        <view class="select-value {{selectedDish.category_name ? '' : 'placeholder'}}">
                          {{selectedDish.category_name || 'è¯·é€‰æ‹©åˆ†ç±»'}}
                        </view>
                        <text class="select-arrow {{showCategoryDropdown ? 'open' : ''}}">â–¼</text>
                        <!-- ä¸‹æ‹‰é€‰é¡¹åˆ—è¡¨ -->
                        <view class="select-dropdown {{showCategoryDropdown ? 'visible' : ''}}" catchtap="stopPropagation">
                          <view 
                            class="select-option {{item.id === selectedDish.category_id ? 'selected' : ''}}"
                            wx:for="{{categoryOptions}}"
                            wx:key="id"
                            data-item="{{item}}"
                            catchtap="onSelectCategory"
                          >
                            {{item.name}}
                          </view>
                          <view class="select-option empty" wx:if="{{categoryOptions.length === 0}}">
                            æš‚æ— åˆ†ç±»
                          </view>
                        </view>
                      </view>
                    </view>

                    <view class="form-group">
                      <label class="form-label">èœå“å›¾ç‰‡</label>
                      <view class="image-upload" bindtap="onUploadImage">
                        <image 
                          wx:if="{{selectedDish.image_url_display || selectedDish.image_url}}" 
                          class="upload-preview" 
                          src="{{selectedDish.image_url_display || selectedDish.image_url}}" 
                          mode="aspectFill"
                        />
                        <view wx:else class="upload-placeholder">
                          <text class="upload-icon">ğŸ“·</text>
                          <text class="upload-text">ç‚¹å‡»ä¸Šä¼ </text>
                        </view>
                      </view>
                    </view>

                    <view class="form-group">
                      <label class="form-label">èœå“æè¿°</label>
                      <textarea 
                        class="form-textarea" 
                        placeholder="è¯·è¾“å…¥èœå“æè¿°ï¼ˆé€‰å¡«ï¼‰" 
                        value="{{selectedDish.description}}"
                        data-field="description"
                        bindinput="onFieldChange"
                        maxlength="500"
                      />
                    </view>
                  </view>

                  <!-- ä»·æ ¼è®¾ç½® -->
                  <view class="form-section">
                    <view class="section-title">ä»·æ ¼è®¾ç½®</view>
                    
                    <view class="form-row">
                      <view class="form-group flex-1">
                        <label class="form-label">å”®ä»· (å…ƒ) <text class="required">*</text></label>
                        <input 
                          class="form-input" 
                          type="digit" 
                          placeholder="0.00" 
                          value="{{selectedDish.price ? selectedDish.price / 100 : ''}}"
                          data-field="price"
                          bindinput="onPriceFieldChange"
                        />
                      </view>
                      <view class="form-group flex-1">
                        <label class="form-label">ä¼šå‘˜ä»· (å…ƒ)</label>
                        <input 
                          class="form-input" 
                          type="digit" 
                          placeholder="0.00" 
                          value="{{selectedDish.member_price ? selectedDish.member_price / 100 : ''}}"
                          data-field="member_price"
                          bindinput="onPriceFieldChange"
                        />
                      </view>
                    </view>
                  </view>

                  <!-- å±æ€§æ ‡ç­¾ -->
                  <view class="form-section">
                    <view class="section-header">
                      <view class="section-title">å±æ€§æ ‡ç­¾</view>
                      <view class="section-action" bindtap="onOpenTagManager" data-type="dish">ç®¡ç†</view>
                    </view>
                    <view class="tags-container">
                      <view 
                        wx:for="{{availableTags}}" 
                        wx:key="id" 
                        class="tag-item {{utils.contains(selectedTagIds, item.id) ? 'selected' : ''}}"
                        bindtap="onTagToggle"
                        data-id="{{item.id}}"
                      >
                        <text class="tag-name">{{item.name}}</text>
                        <text class="tag-check" wx:if="{{utils.contains(selectedTagIds, item.id)}}">âœ“</text>
                      </view>
                      <view wx:if="{{availableTags.length === 0}}" class="tags-empty">
                        <text>æš‚æ— å¯ç”¨æ ‡ç­¾</text>
                      </view>
                    </view>
                  </view>

                  <!-- å®šåˆ¶é€‰é¡¹ -->
                  <view class="form-section">
                    <view class="section-header">
                      <view class="section-title">å®šåˆ¶é€‰é¡¹ <text class="section-hint">(é€‰ä¸­å³æ”¯æŒå®šåˆ¶)</text></view>
                      <view class="section-action" bindtap="onOpenTagManager" data-type="customization">ç®¡ç†</view>
                    </view>
                    <view class="tags-container">
                      <view 
                        wx:for="{{customizationTags}}" 
                        wx:key="id" 
                        class="tag-item customization {{utils.contains(selectedCustomizationTagIds, item.id) ? 'selected' : ''}}"
                        bindtap="onCustomizationTagToggle"
                        data-id="{{item.id}}"
                        data-name="{{item.name}}"
                      >
                        <text class="tag-name">{{item.name}}</text>
                        <text class="tag-check" wx:if="{{utils.contains(selectedCustomizationTagIds, item.id)}}">âœ“</text>
                      </view>
                      <view wx:if="{{customizationTags.length === 0}}" class="tags-empty">
                        <text>æš‚æ— å®šåˆ¶æ ‡ç­¾</text>
                      </view>
                    </view>
                    
                    <!-- å·²é€‰å®šåˆ¶é€‰é¡¹åŠåŠ ä»·è®¾ç½® -->
                    <view wx:if="{{selectedCustomizationOptions.length > 0}}" class="selected-customizations">
                      <view class="customization-list-header">å·²é€‰å®šåˆ¶é€‰é¡¹</view>
                      <view 
                        wx:for="{{selectedCustomizationOptions}}" 
                        wx:key="tag_id" 
                        class="customization-option-row"
                      >
                        <text class="option-label">{{item.tag_name}}</text>
                        <view class="option-price-wrapper">
                          <text class="price-prefix">åŠ ä»· Â¥</text>
                          <input 
                            class="price-input-small" 
                            type="digit"
                            placeholder="0"
                            value="{{item.extra_price ? item.extra_price / 100 : ''}}"
                            data-tag-id="{{item.tag_id}}"
                            bindinput="onCustomizationPriceChange"
                          />
                        </view>
                      </view>
                    </view>
                  </view>

                  <!-- çŠ¶æ€è®¾ç½® -->
                  <view class="form-section">
                    <view class="section-title">çŠ¶æ€è®¾ç½®</view>
                    
                    <view class="form-group horizontal">
                      <label class="form-label">ä¸Šæ¶é”€å”®</label>
                      <view 
                        class="toggle {{selectedDish.is_online ? 'on' : ''}}" 
                        bindtap="onToggleOnline"
                      >
                        <view class="toggle-handle"></view>
                      </view>
                    </view>
                  </view>

                  <!-- åˆ é™¤æŒ‰é’® -->
                  <view wx:if="{{!isAdding && selectedDish.id}}" class="form-section">
                    <button class="btn-danger" bindtap="onDeleteDish">åˆ é™¤æ­¤èœå“</button>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</match-media>

<!-- åˆ†ç±»ç®¡ç†å¼¹çª— -->
<view class="modal-mask {{showCategoryManager ? 'visible' : ''}}" bindtap="onCloseCategoryManager"></view>
<view class="modal-panel {{showCategoryManager ? 'visible' : ''}}" catchtap="">
  <view class="modal-header">
    <text class="modal-title">åˆ†ç±»ç®¡ç†</text>
    <view class="modal-close" bindtap="onCloseCategoryManager">âœ•</view>
  </view>
  <view class="modal-body">
    <!-- æ·»åŠ åˆ†ç±» -->
    <view class="add-category-box">
      <input 
        class="form-input" 
        placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°" 
        value="{{newCategoryName}}"
        bindinput="onNewCategoryNameChange"
      />
      <button class="btn-primary" bindtap="onConfirmAddCategory">æ·»åŠ </button>
    </view>
    
    <!-- åˆ†ç±»åˆ—è¡¨ -->
    <view class="category-list">
      <view 
        wx:for="{{categories}}" 
        wx:key="id" 
        wx:if="{{item.id !== 'all'}}"
        class="category-item"
      >
        <text class="category-name">{{item.name}}</text>
        <view class="category-actions">
          <text class="btn-delete" bindtap="onDeleteCategory" data-id="{{item.id}}" data-name="{{item.name}}">åˆ é™¤</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- åˆ†ç±»é€‰æ‹©å¼¹çª— -->
<view class="modal-mask {{showCategorySelector ? 'visible' : ''}}" bindtap="onCloseCategorySelector"></view>
<view class="modal-panel small {{showCategorySelector ? 'visible' : ''}}" catchtap="">
  <view class="modal-header">
    <text class="modal-title">é€‰æ‹©åˆ†ç±»</text>
    <view class="modal-close" bindtap="onCloseCategorySelector">âœ•</view>
  </view>
  <view class="modal-body">
    <view 
      wx:for="{{categories}}" 
      wx:key="id" 
      wx:if="{{item.id !== 'all'}}"
      class="select-item"
      bindtap="onSelectCategory"
      data-id="{{item.id}}"
      data-name="{{item.name}}"
    >
      {{item.name}}
    </view>
  </view>
</view>

<!-- æ ‡ç­¾ç®¡ç†å¼¹çª— -->
<view class="modal-mask {{showTagManager ? 'visible' : ''}}" bindtap="onCloseTagManager"></view>
<view class="modal-panel {{showTagManager ? 'visible' : ''}}" catchtap="">
  <view class="modal-header">
    <text class="modal-title">{{tagManagerType === 'dish' ? 'å±æ€§æ ‡ç­¾ç®¡ç†' : 'å®šåˆ¶æ ‡ç­¾ç®¡ç†'}}</text>
    <view class="modal-close" bindtap="onCloseTagManager">âœ•</view>
  </view>
  <view class="modal-body">
    <view class="add-tag-row">
      <input 
        class="tag-input" 
        placeholder="è¾“å…¥æ–°æ ‡ç­¾åç§°" 
        value="{{newTagName}}"
        bindinput="onNewTagNameInput"
      />
      <button class="btn-primary btn-small" bindtap="onAddTag">æ·»åŠ </button>
    </view>
    <view class="tag-list">
      <view 
        wx:for="{{tagManagerType === 'dish' ? availableTags : customizationTags}}" 
        wx:key="id"
        class="tag-list-item"
      >
        <text class="tag-list-name">{{item.name}}</text>
        <text class="tag-list-delete" bindtap="onDeleteTag" data-id="{{item.id}}" data-name="{{item.name}}">åˆ é™¤</text>
      </view>
      <view wx:if="{{tagManagerType === 'dish' && availableTags.length === 0}}" class="tag-list-empty">
        æš‚æ— æ ‡ç­¾ï¼Œè¯·æ·»åŠ 
      </view>
      <view wx:if="{{tagManagerType === 'customization' && customizationTags.length === 0}}" class="tag-list-empty">
        æš‚æ— æ ‡ç­¾ï¼Œè¯·æ·»åŠ 
      </view>
    </view>
  </view>
</view>
