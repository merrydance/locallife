<!-- æ»¡å‡æ´»åŠ¨ç®¡ç†é¡µé¢ - æ¡Œé¢çº§ SaaS ç•Œé¢ -->
<wxs module="utils">
  module.exports = {
    formatYuan: function(fen) {
      return (fen / 100).toFixed(2)
    },
    formatDate: function(dateStr) {
      if (!dateStr) return '-'
      return dateStr.slice(0, 10)
    },
    getRuleStatus: function(rule) {
      if (!rule.is_active) return 'inactive'
      var now = getDate().getTime()
      var start = getDate(rule.valid_from).getTime()
      var end = getDate(rule.valid_until).getTime()
      if (now < start) return 'pending'
      if (now > end) return 'expired'
      return 'active'
    },
    getRuleStatusText: function(rule) {
      if (!rule.is_active) return 'å·²åœç”¨'
      var now = getDate().getTime()
      var start = getDate(rule.valid_from).getTime()
      var end = getDate(rule.valid_until).getTime()
      if (now < start) return 'å¾…å¼€å§‹'
      if (now > end) return 'å·²ç»“æŸ'
      return 'è¿›è¡Œä¸­'
    }
  }
</wxs>

<!-- å°å±æç¤º -->
<match-media max-width="1599">
  <view class="desktop-only-notice">
    <view class="notice-box">
      <view class="notice-icon">ğŸ“¢</view>
      <text class="notice-title">æ­¤åŠŸèƒ½éœ€è¦åœ¨ç”µè„‘ç«¯ä½¿ç”¨</text>
      <text class="notice-desc">è¯·ä½¿ç”¨ 1600px ä»¥ä¸Šåˆ†è¾¨ç‡çš„æ˜¾ç¤ºå™¨è®¿é—®æ»¡å‡æ´»åŠ¨ç®¡ç†</text>
      <navigator url="/pages/merchant/dashboard/index" class="btn-back">è¿”å›å·¥ä½œå°</navigator>
    </view>
  </view>
</match-media>

<!-- å¤§å±å¸ƒå±€ -->
<match-media min-width="1600">
  <view class="saas-layout">
    <!-- ä¾§è¾¹æ  -->

    <!-- ä¸»åŒºåŸŸ -->
    <view class="main-area" style="margin-left: 0;">
      <!-- é¡¶éƒ¨æ  -->
      <merchant-header 
      />

      <!-- é¡µé¢å†…å®¹ -->
      <view class="page-container">
        <!-- é¡¶éƒ¨æ“ä½œæ  -->
        <view class="page-header">
          <view class="page-title">
            <text class="title-icon">ğŸ“¢</text>
            <text class="title-text">æ»¡å‡æ´»åŠ¨</text>
            <text class="title-count">å…± {{rules.length}} ä¸ª</text>
          </view>
          <button class="btn-primary" bindtap="showCreateModal">+ æ–°å»ºæ´»åŠ¨</button>
        </view>

        <!-- åŠ è½½çŠ¶æ€ -->
        <view wx:if="{{loading}}" class="loading-state">
          <view class="loading-spinner"></view>
          <text>åŠ è½½ä¸­...</text>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view wx:elif="{{rules.length === 0}}" class="empty-state">
          <text class="empty-icon">ğŸ</text>
          <text class="empty-text">æš‚æ— æ»¡å‡æ´»åŠ¨</text>
          <text class="empty-hint">åˆ›å»ºæ»¡å‡æ´»åŠ¨å¸å¼•æ›´å¤šé¡¾å®¢ä¸‹å•</text>
          <button class="btn-primary" bindtap="showCreateModal">åˆ›å»ºç¬¬ä¸€ä¸ªæ´»åŠ¨</button>
        </view>

        <!-- æ´»åŠ¨åˆ—è¡¨ -->
        <view wx:else class="rule-grid">
          <view 
            wx:for="{{rules}}" wx:key="id" 
            class="rule-card {{utils.getRuleStatus(item)}}"
          >
            <!-- å¡ç‰‡å¤´éƒ¨ -->
            <view class="rule-header">
              <view class="rule-amount">
                <text class="amount-prefix">æ»¡</text>
                <text class="amount-value">Â¥{{utils.formatYuan(item.min_order_amount)}}</text>
                <text class="amount-prefix">å‡</text>
                <text class="amount-value discount">Â¥{{utils.formatYuan(item.discount_amount)}}</text>
              </view>
              <view class="rule-status {{utils.getRuleStatus(item)}}">{{utils.getRuleStatusText(item)}}</view>
            </view>

            <!-- å¡ç‰‡å†…å®¹ -->
            <view class="rule-body">
              <text class="rule-name">{{item.name}}</text>
              <text class="rule-desc" wx:if="{{item.description}}">{{item.description}}</text>
              
              <!-- å åŠ è®¾ç½® -->
              <view class="rule-stack-tags">
                <text class="stack-tag {{item.can_stack_with_voucher ? 'enabled' : 'disabled'}}">
                  {{item.can_stack_with_voucher ? 'âœ“' : 'âœ—'}} ä»£é‡‘åˆ¸
                </text>
                <text class="stack-tag {{item.can_stack_with_membership ? 'enabled' : 'disabled'}}">
                  {{item.can_stack_with_membership ? 'âœ“' : 'âœ—'}} ä½™é¢æ”¯ä»˜
                </text>
              </view>
            </view>

            <!-- æœ‰æ•ˆæœŸ -->
            <view class="rule-validity">
              {{utils.formatDate(item.valid_from)}} ~ {{utils.formatDate(item.valid_until)}}
            </view>

            <!-- æ“ä½œæŒ‰é’® -->
            <view class="rule-actions">
              <view class="action-btn" bindtap="handleToggleActive" data-id="{{item.id}}" data-active="{{item.is_active}}">
                {{item.is_active ? 'åœç”¨' : 'å¯ç”¨'}}
              </view>
              <view class="action-btn" bindtap="handleEdit" data-rule="{{item}}">ç¼–è¾‘</view>
              <view class="action-btn danger" catchtap="handleDelete" data-id="{{item.id}}">åˆ é™¤</view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</match-media>

<!-- æ–°å»º/ç¼–è¾‘å¼¹çª— -->
<view class="modal-overlay {{showModal ? 'show' : ''}}" catchtap="hideModal">
  <view class="modal-content" catchtap="onModalContentTap">
    <view class="modal-header">
      <text class="modal-title">{{editingRule ? 'ç¼–è¾‘æ´»åŠ¨' : 'æ–°å»ºæ´»åŠ¨'}}</text>
      <text class="modal-close" bindtap="hideModal">Ã—</text>
    </view>
    <view class="modal-body">
      <!-- æ´»åŠ¨åç§° -->
      <view class="form-group">
        <text class="form-label">æ´»åŠ¨åç§° *</text>
        <input 
          class="form-input" 
          placeholder="ä¾‹å¦‚: å¤æ—¥ç‰¹æƒ æ»¡å‡" 
          value="{{formData.name}}"
          data-field="name"
          bindinput="onInputChange"
        />
      </view>

      <!-- æ´»åŠ¨æè¿° -->
      <view class="form-group">
        <text class="form-label">æ´»åŠ¨æè¿°</text>
        <textarea 
          class="form-textarea" 
          placeholder="å¯é€‰ï¼Œæè¿°æ´»åŠ¨è¯¦æƒ…" 
          value="{{formData.description}}"
          data-field="description"
          bindinput="onInputChange"
        />
      </view>

      <!-- æ»¡å‡é‡‘é¢ -->
      <view class="form-row">
        <view class="form-group half">
          <text class="form-label">æ»¡ï¼ˆå…ƒï¼‰*</text>
          <input 
            class="form-input" 
            type="digit" 
            placeholder="ä¾‹å¦‚: 100" 
            value="{{formData.minOrderAmount}}"
            data-field="minOrderAmount"
            bindinput="onInputChange"
          />
        </view>
        <view class="form-group half">
          <text class="form-label">å‡ï¼ˆå…ƒï¼‰*</text>
          <input 
            class="form-input" 
            type="digit" 
            placeholder="ä¾‹å¦‚: 20" 
            value="{{formData.discountAmount}}"
            data-field="discountAmount"
            bindinput="onInputChange"
          />
        </view>
      </view>

      <!-- æœ‰æ•ˆæœŸ -->
      <view class="form-row">
        <view class="form-group half">
          <text class="form-label">å¼€å§‹æ—¥æœŸ *</text>
          <view 
            class="form-input date-input" 
            bindtap="onOpenCalendar"
            data-field="validFrom"
          >
            <text class="{{formData.validFrom ? '' : 'placeholder'}}">{{formData.validFrom || 'è¯·é€‰æ‹©'}}</text>
            <text class="date-icon">ğŸ“…</text>
          </view>
        </view>
        <view class="form-group half">
          <text class="form-label">ç»“æŸæ—¥æœŸ *</text>
          <view 
            class="form-input date-input" 
            bindtap="onOpenCalendar"
            data-field="validUntil"
          >
            <text class="{{formData.validUntil ? '' : 'placeholder'}}">{{formData.validUntil || 'è¯·é€‰æ‹©'}}</text>
            <text class="date-icon">ğŸ“…</text>
          </view>
        </view>
      </view>

      <!-- å åŠ è®¾ç½® -->
      <view class="form-section-title">å åŠ è®¾ç½®</view>
      <view class="switch-group">
        <view class="switch-item" bindtap="toggleSwitch" data-field="canStackWithVoucher">
          <text class="switch-label">å¯ä¸ä»£é‡‘åˆ¸å åŠ </text>
          <view class="switch-toggle {{formData.canStackWithVoucher ? 'on' : ''}}">
            <view class="switch-handle"></view>
          </view>
        </view>
        <view class="switch-item" bindtap="toggleSwitch" data-field="canStackWithMembership">
          <text class="switch-label">å¯ç”¨ä½™é¢æ”¯ä»˜</text>
          <view class="switch-toggle {{formData.canStackWithMembership ? 'on' : ''}}">
            <view class="switch-handle"></view>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-outline" bindtap="hideModal">å–æ¶ˆ</button>
      <button class="btn-primary" bindtap="handleSubmit" loading="{{submitting}}">
        {{editingRule ? 'ä¿å­˜' : 'åˆ›å»º'}}
      </button>
    </view>
  </view>
</view>

<!-- æ—¥å†é€‰æ‹©å™¨å¼¹çª— -->
<view class="calendar-overlay {{showCalendar ? 'show' : ''}}" catchtap="onCloseCalendar">
  <view class="calendar-popup" catchtap="onCalendarContentTap">
    <view class="calendar-header">
      <view class="calendar-nav" bindtap="onPrevMonth">â€¹</view>
      <text class="calendar-title">{{calendarYear}}å¹´{{calendarMonth}}æœˆ</text>
      <view class="calendar-nav" bindtap="onNextMonth">â€º</view>
    </view>
    <view class="calendar-weekdays">
      <text class="weekday">æ—¥</text>
      <text class="weekday">ä¸€</text>
      <text class="weekday">äºŒ</text>
      <text class="weekday">ä¸‰</text>
      <text class="weekday">å››</text>
      <text class="weekday">äº”</text>
      <text class="weekday">å…­</text>
    </view>
    <view class="calendar-days">
      <view 
        wx:for="{{calendarDays}}" wx:key="index"
        class="day-cell {{item.disabled ? 'disabled' : ''}} {{item.selected ? 'selected' : ''}} {{item.today ? 'today' : ''}} {{!item.currentMonth ? 'other-month' : ''}}"
        bindtap="{{item.disabled ? '' : 'onSelectCalendarDay'}}"
        data-date="{{item.date}}"
      >
        {{item.day}}
      </view>
    </view>
    <view class="calendar-footer">
      <view class="calendar-today-btn" bindtap="onSelectToday">ä»Šå¤©</view>
    </view>
  </view>
</view>
