<custom-navbar title="堂食管理" showBack="{{true}}" bind:navheight="onNavHeight" />

<view class="page-container {{isLargeScreen ? 'large-screen' : ''}}" style="padding-top: {{navBarHeight}}px;">
  <t-loading wx:if="{{loading}}" theme="circular" size="40rpx" class="loading" />

  <view wx:if="{{!loading}}" class="content responsive-container">
    <!-- Mobile: Stacked Layout -->
    <match-media max-width="749">
      <view class="stacked-layout">
        <!-- 桌台状态 -->
        <view class="section">
          <view class="section-title">桌台状态</view>
          <view class="tables-grid">
            <template is="table-card" wx:for="{{tables}}" wx:key="id" data="{{item}}" />
          </view>
        </view>

        <!-- 进行中的会话 -->
        <view class="section">
          <view class="section-title">进行中的会话</view>
          <template is="sessions-list" data="{{sessions}}" />
        </view>
      </view>
    </match-media>

    <!-- Tablet/PC: Dual-Column Layout -->
    <match-media min-width="750">
      <view class="dual-column-layout">
        <!-- Left: Table Status Grid -->
        <view class="left-section">
          <view class="section-header">
            <view class="section-title">桌台管理</view>
            <view class="stats-summary">
              空闲: <text class="available">{{tableStats.available}}</text> /
              使用中: <text class="occupied">{{tableStats.occupied}}</text>
            </view>
          </view>
          <view class="tables-grid pc-grid">
            <template is="table-card" wx:for="{{tables}}" wx:key="id" data="{{item}}" />
          </view>
        </view>

        <!-- Right: Active Sessions List -->
        <view class="right-section">
          <view class="section-header">
            <view class="section-title">当前会话 ({{sessions.length}})</view>
          </view>
          <template is="sessions-list" data="{{sessions}}" />
        </view>
      </view>
    </match-media>
  </view>
</view>

<!-- ========== 模版定义 ========== -->

<template name="table-card">
  <view class="table-card {{item.status === 'OCCUPIED' ? 'occupied' : ''}}">
    <text class="table-name">{{item.name}}</text>
    <text class="table-capacity">{{item.capacity}}人桌</text>
    <t-tag size="small" theme="{{item.status === 'AVAILABLE' ? 'success' : 'warning'}}">
      {{item.status === 'AVAILABLE' ? '空闲' : '使用中'}}
    </t-tag>
    <t-button 
      wx:if="{{item.status === 'AVAILABLE'}}"
      class="action-btn"
      size="small" 
      theme="primary"
      data-id="{{item.id}}"
      bindtap="onOpenTable"
    >
      开台
    </t-button>
  </view>
</template>

<template name="sessions-list">
  <view wx:if="{{sessions.length === 0}}" class="empty">
    <t-empty description="暂无进行中的会话" />
  </view>
  <view wx:else class="sessions-list">
    <view wx:for="{{sessions}}" wx:key="id" class="session-card">
      <view class="session-header">
        <text class="table-name">{{item.table_name}}</text>
        <t-tag size="small" theme="primary">进行中</t-tag>
      </view>
      <view class="session-info">
        <text class="info-text">人数: {{item.customer_count}}</text>
        <text class="info-text">开台时间: {{item.created_at}}</text>
      </view>
      <view class="session-footer">
        <text class="total-price">¥{{item.total_price / 100}}</text>
        <t-button size="small" theme="primary" data-id="{{item.id}}" bindtap="onCheckout">结账</t-button>
      </view>
    </view>
  </view>
</template>
