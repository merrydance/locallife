<!-- ä»£é‡‘åˆ¸ç®¡ç†é¡µé¢ - æ¡Œé¢çº§ SaaS ç•Œé¢ -->
<wxs module="utils">
  module.exports = {
    formatAmount: function(amount) {
      return (amount / 100).toFixed(2)
    },
    formatDate: function(dateStr) {
      if (!dateStr) return '-'
      return dateStr.slice(0, 10)
    },
    hasOrderType: function(types, type) {
      if (!types) return false
      for (var i = 0; i < types.length; i++) {
        if (types[i] === type) return true
      }
      return false
    }
  }
</wxs>

<!-- å°å±æç¤º -->
<match-media max-width="1599">
  <view class="desktop-only-notice">
    <view class="notice-box">
      <view class="notice-icon">ğŸ«</view>
      <text class="notice-title">æ­¤åŠŸèƒ½éœ€è¦åœ¨ç”µè„‘ç«¯ä½¿ç”¨</text>
      <text class="notice-desc">è¯·ä½¿ç”¨ 1600px ä»¥ä¸Šåˆ†è¾¨ç‡çš„æ˜¾ç¤ºå™¨è®¿é—®ä»£é‡‘åˆ¸ç®¡ç†</text>
      <navigator url="/pages/merchant/dashboard/index" class="btn-back">è¿”å›å·¥ä½œå°</navigator>
    </view>
  </view>
</match-media>

<!-- å¤§å±å¸ƒå±€ -->
<match-media min-width="1600">
  <view class="saas-layout">
    <!-- ä¾§è¾¹æ  -->
    <merchant-sidebar 
      current-path="vouchers" 
      collapsed="{{sidebarCollapsed}}"
      bind:collapse="onSidebarCollapse"
    />

    <!-- ä¸»åŒºåŸŸ -->
    <view class="main-area" style="margin-left: {{sidebarCollapsed ? 64 : 200}}px;">
      <!-- é¡¶éƒ¨æ  -->
      <merchant-header 
        sidebar-width="{{sidebarCollapsed ? 64 : 200}}"
      />

      <!-- é¡µé¢å†…å®¹ -->
      <view class="page-container">
        <!-- é¡¶éƒ¨æ“ä½œæ  -->
        <view class="page-header">
          <view class="page-title">
            <text class="title-icon">ğŸ«</text>
            <text class="title-text">ä»£é‡‘åˆ¸ç®¡ç†</text>
            <text class="title-count">å…± {{vouchers.length}} å¼ </text>
          </view>
          <button class="btn-primary" bindtap="onAddVoucher">+ æ–°å»ºä»£é‡‘åˆ¸</button>
        </view>

        <!-- åŠ è½½çŠ¶æ€ -->
        <view wx:if="{{loading}}" class="loading-state">
          <view class="loading-spinner"></view>
          <text>åŠ è½½ä¸­...</text>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view wx:elif="{{vouchers.length === 0}}" class="empty-state">
          <text class="empty-icon">ğŸ“¦</text>
          <text class="empty-text">æš‚æ— ä»£é‡‘åˆ¸</text>
          <text class="empty-hint">ç‚¹å‡»"æ–°å»ºä»£é‡‘åˆ¸"åˆ›å»ºæ‚¨çš„ç¬¬ä¸€å¼ ä»£é‡‘åˆ¸</text>
        </view>

        <!-- ä»£é‡‘åˆ¸åˆ—è¡¨ -->
        <view wx:else class="voucher-grid">
          <view 
            wx:for="{{vouchers}}" wx:key="id" 
            class="voucher-card {{item.is_active ? '' : 'inactive'}}"
          >
            <!-- å¡ç‰‡å¤´éƒ¨ -->
            <view class="voucher-header">
              <view class="voucher-amount">
                <text class="amount-prefix">Â¥</text>
                <text class="amount-value">{{utils.formatAmount(item.amount)}}</text>
              </view>
              <view class="voucher-status {{item.statusClass}}">{{item.statusText}}</view>
            </view>

            <!-- å¡ç‰‡å†…å®¹ -->
            <view class="voucher-body">
              <text class="voucher-name">{{item.name}}</text>
              <text class="voucher-code">åˆ¸ç : {{item.code}}</text>
              <text class="voucher-condition">æ»¡ Â¥{{utils.formatAmount(item.min_order_amount)}} å¯ç”¨</text>
              <view class="voucher-scenes">
                <text class="scene-tag" wx:if="{{utils.hasOrderType(item.allowed_order_types, 'dine_in')}}">å ‚é£Ÿ</text>
                <text class="scene-tag" wx:if="{{utils.hasOrderType(item.allowed_order_types, 'takeout')}}">å¤–å–</text>
                <text class="scene-tag" wx:if="{{utils.hasOrderType(item.allowed_order_types, 'reservation')}}">é¢„è®¢</text>
              </view>
            </view>

            <!-- å¡ç‰‡æ•°æ® -->
            <view class="voucher-stats">
              <view class="stat-item">
                <text class="stat-value">{{item.claimed_quantity}}/{{item.total_quantity}}</text>
                <text class="stat-label">é¢†å–/æ€»é‡</text>
              </view>
              <view class="stat-item">
                <text class="stat-value">{{item.used_quantity}}</text>
                <text class="stat-label">å·²ä½¿ç”¨</text>
              </view>
            </view>

            <!-- æœ‰æ•ˆæœŸ -->
            <view class="voucher-validity">
              {{utils.formatDate(item.valid_from)}} ~ {{utils.formatDate(item.valid_until)}}
            </view>

            <!-- æ“ä½œæŒ‰é’® -->
            <view class="voucher-actions">
              <view class="action-btn" bindtap="onToggleVoucherStatus" data-voucher="{{item}}">
                {{item.is_active ? 'åœç”¨' : 'å¯ç”¨'}}
              </view>
              <view class="action-btn" bindtap="onEditVoucher" data-voucher="{{item}}">ç¼–è¾‘</view>
              <view class="action-btn danger" catchtap="onDeleteVoucher" data-voucher="{{item}}">åˆ é™¤</view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</match-media>

<!-- ä»£é‡‘åˆ¸ç¼–è¾‘å¼¹çª— -->
<view class="modal-overlay {{showModal ? 'show' : ''}}" catchtap="onCloseModal">
  <view class="modal-content" catchtap="onModalContentTap">
    <view class="modal-header">
      <text class="modal-title">{{editingVoucher ? 'ç¼–è¾‘ä»£é‡‘åˆ¸' : 'æ–°å»ºä»£é‡‘åˆ¸'}}</text>
      <text class="modal-close" bindtap="onCloseModal">Ã—</text>
    </view>
    <view class="modal-body">
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <view class="form-section-title">åŸºæœ¬ä¿¡æ¯</view>
      <view class="form-group">
        <text class="form-label">ä»£é‡‘åˆ¸åç§°</text>
        <input 
          class="form-input" 
          placeholder="ä¾‹å¦‚: æ–°äººä¸“äº«åˆ¸" 
          value="{{form.name}}"
          data-field="name"
          bindinput="onFormInput"
        />
      </view>
      <view class="form-row">
        <view class="form-group half">
          <text class="form-label">åˆ¸ç </text>
          <input 
            class="form-input" 
            placeholder="ä¾‹å¦‚: NEW100"
            disabled="{{!!editingVoucher}}"
            value="{{form.code}}"
            data-field="code"
            bindinput="onFormInput"
          />
        </view>
        <view class="form-group half">
          <text class="form-label">å‘è¡Œæ•°é‡</text>
          <input 
            class="form-input" 
            type="number" 
            placeholder="ä¾‹å¦‚: 100" 
            value="{{form.total_quantity}}"
            data-field="total_quantity"
            bindinput="onFormInput"
          />
        </view>
      </view>

      <!-- ä¼˜æƒ è®¾ç½® -->
      <view class="form-section-title">ä¼˜æƒ è®¾ç½®</view>
      <view class="form-row">
        <view class="form-group half">
          <text class="form-label">ä¼˜æƒ é‡‘é¢ (å…ƒ)</text>
          <input 
            class="form-input" 
            type="digit" 
            placeholder="ä¾‹å¦‚: 10" 
            value="{{form.amount}}"
            data-field="amount"
            bindinput="onFormInput"
          />
        </view>
        <view class="form-group half">
          <text class="form-label">æœ€ä½æ¶ˆè´¹ (å…ƒ)</text>
          <input 
            class="form-input" 
            type="digit" 
            placeholder="ä¾‹å¦‚: 50" 
            value="{{form.min_order_amount}}"
            data-field="min_order_amount"
            bindinput="onFormInput"
          />
        </view>
      </view>

      <!-- é€‚ç”¨åœºæ™¯ -->
      <view class="form-section-title">é€‚ç”¨åœºæ™¯</view>
      <view class="scene-selector">
        <view 
          wx:for="{{orderTypeOptions}}" wx:key="value"
          class="scene-chip {{utils.hasOrderType(form.allowed_order_types, item.value) ? 'active' : ''}}"
          bindtap="onOrderTypeToggle"
          data-type="{{item.value}}"
        >
          {{item.label}}
        </view>
      </view>

      <!-- æœ‰æ•ˆæœŸ -->
      <view class="form-section-title">æœ‰æ•ˆæœŸ</view>
      <view class="form-row">
        <view class="form-group half">
          <text class="form-label">å¼€å§‹æ—¥æœŸ</text>
          <view 
            class="form-input date-input" 
            bindtap="onOpenCalendar"
            data-field="valid_from"
          >
            <text class="{{form.valid_from ? '' : 'placeholder'}}">{{form.valid_from || 'è¯·é€‰æ‹©'}}</text>
            <text class="date-icon">ğŸ“…</text>
          </view>
        </view>
        <view class="form-group half">
          <text class="form-label">ç»“æŸæ—¥æœŸ</text>
          <view 
            class="form-input date-input" 
            bindtap="onOpenCalendar"
            data-field="valid_until"
          >
            <text class="{{form.valid_until ? '' : 'placeholder'}}">{{form.valid_until || 'è¯·é€‰æ‹©'}}</text>
            <text class="date-icon">ğŸ“…</text>
          </view>
        </view>
      </view>

      <!-- æè¿° -->
      <view class="form-group">
        <text class="form-label">ä½¿ç”¨è¯´æ˜ (é€‰å¡«)</text>
        <textarea 
          class="form-textarea" 
          placeholder="ä¾‹å¦‚: ä»…é™å ‚é£Ÿè®¢å•ä½¿ç”¨ï¼Œæ¯äººé™ç”¨ä¸€å¼ " 
          value="{{form.description}}"
          data-field="description"
          bindinput="onFormInput"
        />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-outline" bindtap="onCloseModal">å–æ¶ˆ</button>
      <button class="btn-primary" bindtap="onSaveVoucher">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- æ—¥å†é€‰æ‹©å™¨å¼¹çª— -->
<view class="calendar-overlay {{showCalendar ? 'show' : ''}}" catchtap="onCloseCalendar">
  <view class="calendar-popup" catchtap="onCalendarContentTap">
    <view class="calendar-header">
      <view class="calendar-nav" bindtap="onPrevMonth">â€¹</view>
      <text class="calendar-title">{{calendarYear}}å¹´{{calendarMonth}}æœˆ</text>
      <view class="calendar-nav" bindtap="onNextMonth">â€º</view>
    </view>
    <view class="calendar-weekdays">
      <text class="weekday">æ—¥</text>
      <text class="weekday">ä¸€</text>
      <text class="weekday">äºŒ</text>
      <text class="weekday">ä¸‰</text>
      <text class="weekday">å››</text>
      <text class="weekday">äº”</text>
      <text class="weekday">å…­</text>
    </view>
    <view class="calendar-days">
      <view 
        wx:for="{{calendarDays}}" wx:key="index"
        class="day-cell {{item.disabled ? 'disabled' : ''}} {{item.selected ? 'selected' : ''}} {{item.today ? 'today' : ''}} {{!item.currentMonth ? 'other-month' : ''}}"
        bindtap="{{item.disabled ? '' : 'onSelectCalendarDay'}}"
        data-date="{{item.date}}"
      >
        {{item.day}}
      </view>
    </view>
    <view class="calendar-footer">
      <view class="calendar-today-btn" bindtap="onSelectToday">ä»Šå¤©</view>
    </view>
  </view>
</view>
