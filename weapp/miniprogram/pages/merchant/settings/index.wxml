<!-- 设置中心 - 桌面级 SaaS 界面 -->

<match-media max-width="1599">
  <view class="desktop-only-notice">
    <view class="notice-box">
      <view class="notice-icon">🖥️</view>
      <text class="notice-title">此功能需要在电脑端使用</text>
      <text class="notice-desc">请使用 1600px 以上分辨率的显示器访问设置中心</text>
      <button class="btn-back" bindtap="goBack">返回工作台</button>
    </view>
  </view>
</match-media>

<match-media min-width="1600">
  <view class="saas-layout">
    <!-- 侧边栏 -->
    <merchant-sidebar 
      current-path="settings" 
      collapsed="{{sidebarCollapsed}}"
      bind:collapse="onSidebarCollapse"
    />

    <!-- 主区域 -->
    <view class="main-area" style="margin-left: {{sidebarCollapsed ? 64 : 200}}px;">
      <!-- 顶部栏 -->
      <merchant-header 
        merchant-name="{{merchantName}}"
        is-open="{{isOpen}}"
        sidebar-width="{{sidebarCollapsed ? 64 : 200}}"
      />

      <!-- 页面内容 -->
      <view class="page-container">
        <!-- 左侧设置导航 -->
        <view class="settings-nav">
          <view class="nav-header">
            <text class="nav-title">设置</text>
          </view>
          <view class="nav-list">
            <view 
              class="nav-item {{activeTab === 'profile' ? 'active' : ''}}" 
              bindtap="switchTab" 
              data-tab="profile"
            >
              <text class="nav-icon">🏪</text>
              <view class="nav-text">
                <text class="nav-label">店铺信息</text>
                <text class="nav-desc">名称、Logo、地址、联系方式</text>
              </view>
            </view>
            <view 
              class="nav-item {{activeTab === 'devices' ? 'active' : ''}}" 
              bindtap="switchTab" 
              data-tab="devices"
            >
              <text class="nav-icon">🖨️</text>
              <view class="nav-text">
                <text class="nav-label">设备管理</text>
                <text class="nav-desc">打印机配置、KDS、语音播报</text>
              </view>
            </view>
          </view>
        </view>

        <!-- 右侧内容区 -->
        <view class="settings-content">
          <!-- 店铺信息 -->
          <view class="content-panel" wx:if="{{activeTab === 'profile'}}">
            <view class="panel-header">
              <text class="panel-title">店铺信息</text>
              <text class="panel-subtitle">管理店铺的基本信息，更改会立即生效</text>
            </view>
            
            <view class="form-section">
              <view class="form-group">
                <label class="form-label">店铺名称 <text class="required">*</text></label>
                <input 
                  class="form-input" 
                  placeholder="请输入店铺名称" 
                  value="{{merchant.name}}"
                  bindinput="onInput"
                  data-field="name"
                />
              </view>

              <view class="form-group">
                <label class="form-label">店铺 Logo</label>
                <view class="logo-upload">
                  <image 
                    wx:if="{{merchant.logo_url}}" 
                    class="logo-preview" 
                    src="{{merchant.logo_url}}" 
                    mode="aspectFill"
                    bindtap="uploadLogo"
                  />
                  <view wx:else class="logo-placeholder" bindtap="uploadLogo">
                    <text class="upload-icon">📷</text>
                    <text class="upload-text">点击上传</text>
                  </view>
                  <view class="logo-tips">
                    <text>建议尺寸：200x200 像素</text>
                    <text>格式：JPG、PNG</text>
                  </view>
                </view>
              </view>

              <view class="form-group">
                <label class="form-label">店铺描述</label>
                <textarea 
                  class="form-textarea" 
                  placeholder="介绍您的店铺特色..."
                  value="{{merchant.description}}"
                  bindinput="onInput"
                  data-field="description"
                  maxlength="500"
                />
                <text class="char-count">{{descriptionLength}}/500</text>
              </view>

              <view class="form-group">
                <label class="form-label">联系电话 <text class="required">*</text></label>
                <input 
                  class="form-input" 
                  type="number"
                  placeholder="请输入11位手机号" 
                  value="{{merchant.phone}}"
                  bindinput="onInput"
                  data-field="phone"
                  maxlength="11"
                />
              </view>

              <view class="form-group">
                <label class="form-label">店铺地址 <text class="required">*</text></label>
                <view class="address-input">
                  <input 
                    class="form-input flex-1" 
                    placeholder="请输入详细地址" 
                    value="{{merchant.address}}"
                    bindinput="onInput"
                    data-field="address"
                  />
                  <button class="btn-location" bindtap="chooseLocation">📍 定位</button>
                </view>
                <view class="coords" wx:if="{{merchant.latitude && merchant.longitude}}">
                  <text class="coords-text">坐标：{{merchant.latitude}}, {{merchant.longitude}}</text>
                </view>
              </view>
            </view>

            <view class="form-actions">
              <button class="btn-cancel" bindtap="resetProfile">重置</button>
              <button class="btn-save" bindtap="saveProfile" disabled="{{saving}}">
                {{saving ? '保存中...' : '保存更改'}}
              </button>
            </view>
          </view>

          <!-- 设备管理 -->
          <view class="content-panel" wx:if="{{activeTab === 'devices'}}">
            <view class="panel-header">
              <text class="panel-title">设备管理</text>
              <text class="panel-subtitle">管理打印机和订单通知设置</text>
            </view>

            <!-- 打印机列表 -->
            <view class="section">
              <view class="section-header">
                <text class="section-title">打印机 ({{printers.length}})</text>
                <button class="btn-add" bindtap="addPrinter">+ 添加打印机</button>
              </view>
              
              <view class="printer-list" wx:if="{{printers.length > 0}}">
                <view class="printer-card" wx:for="{{printers}}" wx:key="id">
                  <view class="printer-info">
                    <view class="printer-icon">🖨️</view>
                    <view class="printer-detail">
                      <text class="printer-name">{{item.printer_name}}</text>
                      <text class="printer-sn">SN: {{item.printer_sn}}</text>
                      <view class="printer-scenes">
                        <text class="scene-tag" wx:if="{{item.print_takeout}}">外卖</text>
                        <text class="scene-tag" wx:if="{{item.print_dine_in}}">堂食</text>
                        <text class="scene-tag" wx:if="{{item.print_reservation}}">预订</text>
                      </view>
                    </view>
                  </view>
                  <view class="printer-actions">
                    <view class="status-switch {{item.is_active ? 'active' : ''}}" bindtap="togglePrinter" data-id="{{item.id}}">
                      <text>{{item.is_active ? '已启用' : '已禁用'}}</text>
                    </view>
                    <button class="btn-edit" bindtap="editPrinter" data-id="{{item.id}}">编辑</button>
                    <button class="btn-delete" bindtap="deletePrinter" data-id="{{item.id}}">删除</button>
                  </view>
                </view>
              </view>
              
              <view class="empty-state" wx:else>
                <text class="empty-icon">🖨️</text>
                <text class="empty-text">暂无打印机，点击添加</text>
              </view>
            </view>

            <!-- 通知配置 -->
            <view class="section">
              <view class="section-header">
                <text class="section-title">订单通知</text>
              </view>
              
              <view class="config-list">
                <!-- 打印设置 -->
                <view class="config-group">
                  <view class="config-header">
                    <text class="config-title">自动打印</text>
                    <view class="toggle {{displayConfig.enable_print ? 'on' : ''}}" bindtap="toggleConfig" data-field="enable_print">
                      <view class="toggle-handle"></view>
                    </view>
                  </view>
                  <view class="config-options" wx:if="{{displayConfig.enable_print}}">
                    <label class="checkbox-item">
                      <view class="checkbox {{displayConfig.print_takeout ? 'checked' : ''}}" bindtap="toggleConfig" data-field="print_takeout"></view>
                      <text>外卖订单</text>
                    </label>
                    <label class="checkbox-item">
                      <view class="checkbox {{displayConfig.print_dine_in ? 'checked' : ''}}" bindtap="toggleConfig" data-field="print_dine_in"></view>
                      <text>堂食订单</text>
                    </label>
                    <label class="checkbox-item">
                      <view class="checkbox {{displayConfig.print_reservation ? 'checked' : ''}}" bindtap="toggleConfig" data-field="print_reservation"></view>
                      <text>预订订单</text>
                    </label>
                  </view>
                </view>

                <!-- 语音设置 -->
                <view class="config-group">
                  <view class="config-header">
                    <text class="config-title">语音播报</text>
                    <view class="toggle {{displayConfig.enable_voice ? 'on' : ''}}" bindtap="toggleConfig" data-field="enable_voice">
                      <view class="toggle-handle"></view>
                    </view>
                  </view>
                  <view class="config-options" wx:if="{{displayConfig.enable_voice}}">
                    <label class="checkbox-item">
                      <view class="checkbox {{displayConfig.voice_takeout ? 'checked' : ''}}" bindtap="toggleConfig" data-field="voice_takeout"></view>
                      <text>外卖订单</text>
                    </label>
                    <label class="checkbox-item">
                      <view class="checkbox {{displayConfig.voice_dine_in ? 'checked' : ''}}" bindtap="toggleConfig" data-field="voice_dine_in"></view>
                      <text>堂食订单</text>
                    </label>
                  </view>
                </view>

                <!-- KDS 设置 -->
                <view class="config-group">
                  <view class="config-header">
                    <text class="config-title">厨房显示系统 (KDS)</text>
                    <view class="toggle {{displayConfig.enable_kds ? 'on' : ''}}" bindtap="toggleConfig" data-field="enable_kds">
                      <view class="toggle-handle"></view>
                    </view>
                  </view>
                  <view class="config-options" wx:if="{{displayConfig.enable_kds}}">
                    <text class="config-tip">开启后，可在工作台进入 KDS 大屏查看订单</text>
                  </view>
                </view>
              </view>

              <view class="form-actions">
                <button class="btn-save" bindtap="saveDisplayConfig" disabled="{{savingConfig}}">
                  {{savingConfig ? '保存中...' : '保存通知设置'}}
                </button>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 打印机编辑弹窗 -->
  <view class="modal-mask {{showPrinterModal ? 'visible' : ''}}" bindtap="closePrinterModal"></view>
  <view class="modal {{showPrinterModal ? 'visible' : ''}}">
    <view class="modal-header">
      <text class="modal-title">{{editingPrinter.id ? '编辑打印机' : '添加打印机'}}</text>
      <view class="modal-close" bindtap="closePrinterModal">✕</view>
    </view>
    <view class="modal-body">
      <view class="form-group">
        <label class="form-label">打印机名称 <text class="required">*</text></label>
        <input 
          class="form-input" 
          placeholder="例如：前台打印机" 
          value="{{editingPrinter.printer_name}}"
          bindinput="onPrinterInput"
          data-field="printer_name"
        />
      </view>
      <view class="form-group" wx:if="{{!editingPrinter.id}}">
        <label class="form-label">打印机序列号 <text class="required">*</text></label>
        <input 
          class="form-input" 
          placeholder="打印机背面的 SN 码" 
          value="{{editingPrinter.printer_sn}}"
          bindinput="onPrinterInput"
          data-field="printer_sn"
        />
      </view>
      <view class="form-group" wx:if="{{!editingPrinter.id}}">
        <label class="form-label">打印机密钥 <text class="required">*</text></label>
        <input 
          class="form-input" 
          placeholder="打印机绑定的 KEY" 
          value="{{editingPrinter.printer_key}}"
          bindinput="onPrinterInput"
          data-field="printer_key"
        />
      </view>
      <view class="form-group" wx:if="{{!editingPrinter.id}}">
        <label class="form-label">打印机类型 <text class="required">*</text></label>
        <view class="radio-group">
          <view 
            class="radio-item {{editingPrinter.printer_type === 'feieyun' ? 'selected' : ''}}"
            bindtap="selectPrinterType"
            data-type="feieyun"
          >飞鹅云</view>
          <view 
            class="radio-item {{editingPrinter.printer_type === 'yilianyun' ? 'selected' : ''}}"
            bindtap="selectPrinterType"
            data-type="yilianyun"
          >易联云</view>
          <view 
            class="radio-item {{editingPrinter.printer_type === 'other' ? 'selected' : ''}}"
            bindtap="selectPrinterType"
            data-type="other"
          >其他</view>
        </view>
      </view>
      <view class="form-group">
        <label class="form-label">打印场景</label>
        <view class="checkbox-group">
          <label class="checkbox-item">
            <view class="checkbox {{editingPrinter.print_takeout ? 'checked' : ''}}" bindtap="togglePrinterScene" data-field="print_takeout"></view>
            <text>外卖订单</text>
          </label>
          <label class="checkbox-item">
            <view class="checkbox {{editingPrinter.print_dine_in ? 'checked' : ''}}" bindtap="togglePrinterScene" data-field="print_dine_in"></view>
            <text>堂食订单</text>
          </label>
          <label class="checkbox-item">
            <view class="checkbox {{editingPrinter.print_reservation ? 'checked' : ''}}" bindtap="togglePrinterScene" data-field="print_reservation"></view>
            <text>预订订单</text>
          </label>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-cancel" bindtap="closePrinterModal">取消</button>
      <button class="btn-save" bindtap="savePrinter" disabled="{{savingPrinter}}">
        {{savingPrinter ? '保存中...' : '保存'}}
      </button>
    </view>
  </view>
</match-media>
