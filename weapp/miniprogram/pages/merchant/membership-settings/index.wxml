<!-- å‚¨å€¼ç®¡ç†é¡µé¢ - æ¡Œé¢çº§ SaaS ç•Œé¢ -->
<wxs module="utils">
  module.exports = {
    formatAmount: function(amount) {
      return (amount / 100).toFixed(2)
    },
    formatDate: function(dateStr) {
      if (!dateStr) return '-'
      return dateStr.slice(0, 10)
    },
    hasScene: function(scenes, scene) {
      if (!scenes) return false
      for (var i = 0; i < scenes.length; i++) {
        if (scenes[i] === scene) return true
      }
      return false
    }
  }
</wxs>

<!-- å°å±æç¤º -->
<match-media max-width="1599">
  <view class="desktop-only-notice">
    <view class="notice-box">
      <view class="notice-icon">ï¿½</view>
      <text class="notice-title">æ­¤åŠŸèƒ½éœ€è¦åœ¨ç”µè„‘ç«¯ä½¿ç”¨</text>
      <text class="notice-desc">è¯·ä½¿ç”¨ 1600px ä»¥ä¸Šåˆ†è¾¨ç‡çš„æ˜¾ç¤ºå™¨è®¿é—®å‚¨å€¼ç®¡ç†</text>
      <navigator url="/pages/merchant/dashboard/index" class="btn-back">è¿”å›å·¥ä½œå°</navigator>
    </view>
  </view>
</match-media>

<!-- å¤§å±å¸ƒå±€ -->
<match-media min-width="1600">
  <view class="saas-layout">
    <!-- ä¾§è¾¹æ  -->

    <!-- ä¸»åŒºåŸŸ -->
    <view class="main-area" style="margin-left: 0;">
      <!-- é¡¶éƒ¨æ  -->
      <merchant-header 
      />

      <!-- é¡µé¢å†…å®¹ -->
      <view class="page-container">
        <!-- åŠ è½½çŠ¶æ€ -->
        <view wx:if="{{loading}}" class="loading-state">
          <view class="loading-spinner"></view>
          <text>åŠ è½½ä¸­...</text>
        </view>

        <view wx:else class="content-grid">
          <!-- å·¦ä¾§ï¼šä¼šå‘˜è®¾ç½® -->
          <view class="settings-panel">
            <view class="panel-header">
              <text class="panel-title">ğŸ’³ å‚¨å€¼ä½¿ç”¨è®¾ç½®</text>
              <button class="btn-primary btn-sm" bindtap="onSaveSettings" disabled="{{saving}}">
                {{saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜è®¾ç½®'}}
              </button>
            </view>
            
            <view class="panel-body">
              <!-- å‚¨å€¼å¯ç”¨åœºæ™¯ -->
              <view class="form-section">
                <text class="section-title">å‚¨å€¼å¯ç”¨åœºæ™¯</text>
                <text class="section-desc">é€‰æ‹©ä¼šå‘˜å‚¨å€¼ä½™é¢å¯ä»¥ä½¿ç”¨çš„æ¶ˆè´¹åœºæ™¯</text>
                <view class="scene-selector">
                  <view 
                    wx:for="{{sceneOptions}}" wx:key="value"
                    class="scene-chip {{utils.hasScene(settings.balance_usable_scenes, item.value) ? 'active' : ''}}"
                    bindtap="onSceneToggle"
                    data-type="balance"
                    data-scene="{{item.value}}"
                  >
                    {{item.label}}
                  </view>
                </view>
              </view>
            </view>
          </view>

          <!-- å³ä¾§ï¼šå……å€¼è§„åˆ™ -->
          <view class="rules-panel">
            <view class="panel-header">
              <text class="panel-title">ğŸ å……å€¼è§„åˆ™ç®¡ç†</text>
              <button class="btn-primary btn-sm" bindtap="onAddRule">+ æ–°å¢è§„åˆ™</button>
            </view>
            
            <view class="panel-body">
              <!-- è§„åˆ™åˆ—è¡¨ -->
              <view wx:if="{{rechargeRules.length === 0}}" class="empty-state">
                <text class="empty-icon">ğŸ“¦</text>
                <text class="empty-text">æš‚æ— å……å€¼è§„åˆ™</text>
                <text class="empty-hint">ç‚¹å‡»"æ–°å¢è§„åˆ™"åˆ›å»ºå……å€¼é€èµ é‡‘æ´»åŠ¨</text>
              </view>

              <view wx:else class="rules-list">
                <view 
                  wx:for="{{rechargeRules}}" wx:key="id" 
                  class="rule-card {{item.is_active ? '' : 'inactive'}}"
                >
                  <view class="rule-main">
                    <view class="rule-amounts">
                      <text class="recharge-amount">å…… Â¥{{utils.formatAmount(item.recharge_amount)}}</text>
                      <text class="bonus-amount">é€ Â¥{{utils.formatAmount(item.bonus_amount)}}</text>
                    </view>
                    <view class="rule-meta">
                      <text class="rule-date">{{utils.formatDate(item.valid_from)}} ~ {{utils.formatDate(item.valid_until)}}</text>
                      <text class="rule-status {{item.is_active ? 'active' : 'inactive'}}">{{item.is_active ? 'ç”Ÿæ•ˆä¸­' : 'å·²åœç”¨'}}</text>
                    </view>
                  </view>
                  <view class="rule-actions">
                    <view class="action-btn" bindtap="onToggleRuleStatus" data-rule="{{item}}">
                      {{item.is_active ? 'åœç”¨' : 'å¯ç”¨'}}
                    </view>
                    <view class="action-btn" bindtap="onEditRule" data-rule="{{item}}">ç¼–è¾‘</view>
                    <view class="action-btn danger" catchtap="onDeleteRule" data-rule="{{item}}">åˆ é™¤</view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</match-media>

<!-- è§„åˆ™ç¼–è¾‘å¼¹çª— -->
<view class="modal-overlay {{showRuleModal ? 'show' : ''}}" catchtap="onCloseRuleModal">
  <view class="modal-content" catchtap="onModalContentTap">
    <view class="modal-header">
      <text class="modal-title">{{editingRule ? 'ç¼–è¾‘è§„åˆ™' : 'æ–°å¢å……å€¼è§„åˆ™'}}</text>
      <text class="modal-close" bindtap="onCloseRuleModal">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="form-group">
        <text class="form-label">å……å€¼é‡‘é¢ (å…ƒ)</text>
        <input 
          class="form-input" 
          type="digit" 
          placeholder="ä¾‹å¦‚: 100" 
          value="{{ruleForm.recharge_amount}}"
          data-field="recharge_amount"
          bindinput="onRuleFormInput"
        />
      </view>
      <view class="form-group">
        <text class="form-label">èµ é€é‡‘é¢ (å…ƒ)</text>
        <input 
          class="form-input" 
          type="digit" 
          placeholder="ä¾‹å¦‚: 20" 
          value="{{ruleForm.bonus_amount}}"
          data-field="bonus_amount"
          bindinput="onRuleFormInput"
        />
      </view>
      <view class="form-row">
        <view class="form-group half">
          <text class="form-label">å¼€å§‹æ—¥æœŸ</text>
          <view 
            class="form-input date-input" 
            bindtap="onOpenCalendar"
            data-field="valid_from"
          >
            <text class="{{ruleForm.valid_from ? '' : 'placeholder'}}">{{ruleForm.valid_from || 'è¯·é€‰æ‹©'}}</text>
            <text class="date-icon">ğŸ“…</text>
          </view>
        </view>
        <view class="form-group half">
          <text class="form-label">ç»“æŸæ—¥æœŸ</text>
          <view 
            class="form-input date-input" 
            bindtap="onOpenCalendar"
            data-field="valid_until"
          >
            <text class="{{ruleForm.valid_until ? '' : 'placeholder'}}">{{ruleForm.valid_until || 'è¯·é€‰æ‹©'}}</text>
            <text class="date-icon">ğŸ“…</text>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-outline" bindtap="onCloseRuleModal">å–æ¶ˆ</button>
      <button class="btn-primary" bindtap="onSaveRule">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- æ—¥å†é€‰æ‹©å™¨å¼¹çª— -->
<view class="calendar-overlay {{showCalendar ? 'show' : ''}}" catchtap="onCloseCalendar">
  <view class="calendar-popup" catchtap="onCalendarContentTap">
    <view class="calendar-header">
      <view class="calendar-nav" bindtap="onPrevMonth">â€¹</view>
      <text class="calendar-title">{{calendarYear}}å¹´{{calendarMonth}}æœˆ</text>
      <view class="calendar-nav" bindtap="onNextMonth">â€º</view>
    </view>
    <view class="calendar-weekdays">
      <text class="weekday">æ—¥</text>
      <text class="weekday">ä¸€</text>
      <text class="weekday">äºŒ</text>
      <text class="weekday">ä¸‰</text>
      <text class="weekday">å››</text>
      <text class="weekday">äº”</text>
      <text class="weekday">å…­</text>
    </view>
    <view class="calendar-days">
      <view 
        wx:for="{{calendarDays}}" wx:key="index"
        class="day-cell {{item.disabled ? 'disabled' : ''}} {{item.selected ? 'selected' : ''}} {{item.today ? 'today' : ''}} {{!item.currentMonth ? 'other-month' : ''}}"
        bindtap="{{item.disabled ? '' : 'onSelectCalendarDay'}}"
        data-date="{{item.date}}"
      >
        {{item.day}}
      </view>
    </view>
    <view class="calendar-footer">
      <view class="calendar-today-btn" bindtap="onSelectToday">ä»Šå¤©</view>
    </view>
  </view>
</view>
