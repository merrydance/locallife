<!-- è´¢åŠ¡ç®¡ç†é¡µé¢ - PC-SaaS å¸ƒå±€ -->
<wxs module="utils">
  module.exports = {
    formatAmount: function(fen) {
      return (fen / 100).toFixed(2)
    },
    formatStatus: function(status) {
      var map = {
        'pending': 'å¾…å¤„ç†',
        'processing': 'å¤„ç†ä¸­',
        'finished': 'å·²å®Œæˆ',
        'failed': 'å¤±è´¥'
      }
      return map[status] || status
    },
    formatSource: function(source) {
      var map = {
        'takeout': 'å¤–å–',
        'dine_in': 'å ‚é£Ÿ',
        'pickup': 'è‡ªå–'
      }
      return map[source] || source
    },
    formatDate: function(dateStr) {
      if (!dateStr) return '-'
      return dateStr.slice(0, 10)
    }
  }
</wxs>

<!-- å°å±æç¤º -->
<match-media max-width="1599">
  <view class="desktop-only-notice">
    <view class="notice-box">
      <view class="notice-icon">ğŸ’°</view>
      <text class="notice-title">æ­¤åŠŸèƒ½éœ€è¦åœ¨ç”µè„‘ç«¯ä½¿ç”¨</text>
      <text class="notice-desc">è¯·ä½¿ç”¨ 1600px ä»¥ä¸Šåˆ†è¾¨ç‡çš„æ˜¾ç¤ºå™¨è®¿é—®è´¢åŠ¡ç®¡ç†</text>
      <navigator url="/pages/merchant/dashboard/index" class="btn-back">è¿”å›å·¥ä½œå°</navigator>
    </view>
  </view>
</match-media>

<!-- å¤§å±å¸ƒå±€ -->
<match-media min-width="1600">
  <view class="saas-layout">
    <!-- ä¾§è¾¹æ  -->
    <merchant-sidebar 
      current-path="finance" 
      collapsed="{{sidebarCollapsed}}"
      bind:collapse="onSidebarCollapse"
    />

    <!-- ä¸»åŒºåŸŸ -->
    <view class="main-area" style="margin-left: {{sidebarCollapsed ? 64 : 200}}px;">
      <!-- é¡¶éƒ¨æ  -->
      <merchant-header sidebar-width="{{sidebarCollapsed ? 64 : 200}}" />

      <!-- é¡µé¢å†…å®¹ -->
      <view class="page-container">
        <!-- æ ‡é¢˜æ  -->
        <view class="page-header">
          <view class="page-title">
            <text class="title-icon">ğŸ’°</text>
            <text class="title-text">è´¢åŠ¡ç®¡ç†</text>
          </view>
          <!-- æ—¥æœŸèŒƒå›´ -->
          <view class="date-range-picker">
            <view class="range-option {{dateRange === 'week' ? 'active' : ''}}" data-range="week" bindtap="onDateRangeChange">è¿‘7å¤©</view>
            <view class="range-option {{dateRange === 'month' ? 'active' : ''}}" data-range="month" bindtap="onDateRangeChange">è¿‘30å¤©</view>
          </view>
        </view>

        <!-- Tab å¯¼èˆª -->
        <view class="tab-nav">
          <view class="tab-item {{activeTab === 'overview' ? 'active' : ''}}" data-tab="overview" bindtap="onTabChange">æ¦‚è§ˆ</view>
          <view class="tab-item {{activeTab === 'daily' ? 'active' : ''}}" data-tab="daily" bindtap="onTabChange">æ¯æ—¥æ±‡æ€»</view>
          <view class="tab-item {{activeTab === 'orders' ? 'active' : ''}}" data-tab="orders" bindtap="onTabChange">è®¢å•æ˜ç»†</view>
          <view class="tab-item {{activeTab === 'fees' ? 'active' : ''}}" data-tab="fees" bindtap="onTabChange">æœåŠ¡è´¹</view>
          <view class="tab-item {{activeTab === 'promotions' ? 'active' : ''}}" data-tab="promotions" bindtap="onTabChange">æ»¡è¿”æ”¯å‡º</view>
          <view class="tab-item {{activeTab === 'settlements' ? 'active' : ''}}" data-tab="settlements" bindtap="onTabChange">ç»“ç®—è®°å½•</view>
        </view>

        <!-- åŠ è½½çŠ¶æ€ -->
        <view wx:if="{{loading}}" class="loading-state">
          <view class="loading-spinner"></view>
          <text>åŠ è½½ä¸­...</text>
        </view>

        <!-- æ¦‚è§ˆ Tab -->
        <view wx:elif="{{activeTab === 'overview' && overview}}" class="tab-content">
          <view class="overview-grid">
            <view class="overview-card large">
              <text class="card-label">æ€» GMV</text>
              <text class="card-value primary">Â¥{{utils.formatAmount(overview.total_gmv)}}</text>
            </view>
            <view class="overview-card">
              <text class="card-label">å®æ”¶æ”¶å…¥</text>
              <text class="card-value success">Â¥{{utils.formatAmount(overview.total_income)}}</text>
            </view>
            <view class="overview-card">
              <text class="card-label">å‡€æ”¶å…¥</text>
              <text class="card-value">Â¥{{utils.formatAmount(overview.net_income)}}</text>
            </view>
            <view class="overview-card">
              <text class="card-label">å¾…ç»“ç®—</text>
              <text class="card-value warning">Â¥{{utils.formatAmount(overview.pending_income)}}</text>
            </view>
            <view class="overview-card">
              <text class="card-label">å¹³å°æœåŠ¡è´¹</text>
              <text class="card-value danger">Â¥{{utils.formatAmount(overview.total_platform_fee)}}</text>
            </view>
            <view class="overview-card">
              <text class="card-label">è¿è¥å•†æœåŠ¡è´¹</text>
              <text class="card-value danger">Â¥{{utils.formatAmount(overview.total_operator_fee)}}</text>
            </view>
            <view class="overview-card">
              <text class="card-label">æ»¡è¿”æ”¯å‡º</text>
              <text class="card-value danger">Â¥{{utils.formatAmount(overview.total_promotion_exp)}}</text>
            </view>
            <view class="overview-card">
              <text class="card-label">å·²å®Œæˆè®¢å•</text>
              <text class="card-value">{{overview.completed_orders}}</text>
            </view>
          </view>
        </view>

        <!-- æ¯æ—¥æ±‡æ€» Tab -->
        <view wx:elif="{{activeTab === 'daily'}}" class="tab-content">
          <view class="data-table">
            <view class="table-header">
              <text class="col-date">æ—¥æœŸ</text>
              <text class="col-count">è®¢å•æ•°</text>
              <text class="col-gmv">GMV</text>
              <text class="col-income">å•†æˆ·æ”¶å…¥</text>
              <text class="col-fee">æœåŠ¡è´¹</text>
            </view>
            <view wx:if="{{dailyFinance.length === 0}}" class="empty-hint">æš‚æ— æ•°æ®</view>
            <view wx:for="{{dailyFinance}}" wx:key="date" class="table-row">
              <text class="col-date">{{item.date}}</text>
              <text class="col-count">{{item.order_count}}</text>
              <text class="col-gmv">Â¥{{utils.formatAmount(item.total_gmv)}}</text>
              <text class="col-income success">Â¥{{utils.formatAmount(item.merchant_income)}}</text>
              <text class="col-fee danger">Â¥{{utils.formatAmount(item.total_fee)}}</text>
            </view>
          </view>
        </view>

        <!-- è®¢å•æ˜ç»† Tab -->
        <view wx:elif="{{activeTab === 'orders'}}" class="tab-content">
          <view class="data-table">
            <view class="table-header">
              <text class="col-id">ID</text>
              <text class="col-source">æ¥æº</text>
              <text class="col-amount">è®¢å•é‡‘é¢</text>
              <text class="col-fee">æœåŠ¡è´¹</text>
              <text class="col-income">å•†æˆ·æ”¶å…¥</text>
              <text class="col-status">çŠ¶æ€</text>
              <text class="col-time">æ—¶é—´</text>
            </view>
            <view wx:if="{{orders.length === 0}}" class="empty-hint">æš‚æ— æ•°æ®</view>
            <view wx:for="{{orders}}" wx:key="id" class="table-row">
              <text class="col-id">{{item.id}}</text>
              <text class="col-source">{{utils.formatSource(item.order_source)}}</text>
              <text class="col-amount">Â¥{{utils.formatAmount(item.total_amount)}}</text>
              <text class="col-fee danger">Â¥{{utils.formatAmount(item.platform_fee + item.operator_fee)}}</text>
              <text class="col-income success">Â¥{{utils.formatAmount(item.merchant_amount)}}</text>
              <text class="col-status status-{{item.status}}">{{utils.formatStatus(item.status)}}</text>
              <text class="col-time">{{utils.formatDate(item.created_at)}}</text>
            </view>
          </view>
        </view>

        <!-- æœåŠ¡è´¹ Tab -->
        <view wx:elif="{{activeTab === 'fees'}}" class="tab-content">
          <view class="data-table">
            <view class="table-header">
              <text class="col-date">æ—¥æœŸ</text>
              <text class="col-source">æ¥æº</text>
              <text class="col-count">è®¢å•æ•°</text>
              <text class="col-amount">è®¢å•é‡‘é¢</text>
              <text class="col-platform">å¹³å°è´¹</text>
              <text class="col-operator">è¿è¥å•†è´¹</text>
              <text class="col-total">æ€»æœåŠ¡è´¹</text>
            </view>
            <view wx:if="{{serviceFees.length === 0}}" class="empty-hint">æš‚æ— æ•°æ®</view>
            <view wx:for="{{serviceFees}}" wx:key="index" class="table-row">
              <text class="col-date">{{item.date}}</text>
              <text class="col-source">{{utils.formatSource(item.order_source)}}</text>
              <text class="col-count">{{item.order_count}}</text>
              <text class="col-amount">Â¥{{utils.formatAmount(item.total_amount)}}</text>
              <text class="col-platform danger">Â¥{{utils.formatAmount(item.platform_fee)}}</text>
              <text class="col-operator danger">Â¥{{utils.formatAmount(item.operator_fee)}}</text>
              <text class="col-total danger">Â¥{{utils.formatAmount(item.total_fee)}}</text>
            </view>
          </view>
        </view>

        <!-- æ»¡è¿”æ”¯å‡º Tab -->
        <view wx:elif="{{activeTab === 'promotions'}}" class="tab-content">
          <view class="data-table">
            <view class="table-header">
              <text class="col-id">è®¢å•å·</text>
              <text class="col-type">ç±»å‹</text>
              <text class="col-subtotal">å•†å“é‡‘é¢</text>
              <text class="col-delivery">é…é€è´¹</text>
              <text class="col-discount">ä¼˜æƒ é‡‘é¢</text>
              <text class="col-time">æ—¶é—´</text>
            </view>
            <view wx:if="{{promotions.length === 0}}" class="empty-hint">æš‚æ— æ•°æ®</view>
            <view wx:for="{{promotions}}" wx:key="id" class="table-row">
              <text class="col-id">{{item.order_no}}</text>
              <text class="col-type">{{utils.formatSource(item.order_type)}}</text>
              <text class="col-subtotal">Â¥{{utils.formatAmount(item.subtotal)}}</text>
              <text class="col-delivery">Â¥{{utils.formatAmount(item.delivery_fee)}}</text>
              <text class="col-discount danger">Â¥{{utils.formatAmount(item.delivery_fee_discount)}}</text>
              <text class="col-time">{{utils.formatDate(item.created_at)}}</text>
            </view>
          </view>
        </view>

        <!-- ç»“ç®—è®°å½• Tab -->
        <view wx:elif="{{activeTab === 'settlements'}}" class="tab-content">
          <view class="data-table">
            <view class="table-header">
              <text class="col-id">ID</text>
              <text class="col-source">æ¥æº</text>
              <text class="col-amount">è®¢å•é‡‘é¢</text>
              <text class="col-income">ç»“ç®—é‡‘é¢</text>
              <text class="col-status">çŠ¶æ€</text>
              <text class="col-time">æ—¶é—´</text>
            </view>
            <view wx:if="{{settlements.length === 0}}" class="empty-hint">æš‚æ— æ•°æ®</view>
            <view wx:for="{{settlements}}" wx:key="id" class="table-row">
              <text class="col-id">{{item.id}}</text>
              <text class="col-source">{{utils.formatSource(item.order_source)}}</text>
              <text class="col-amount">Â¥{{utils.formatAmount(item.total_amount)}}</text>
              <text class="col-income success">Â¥{{utils.formatAmount(item.merchant_amount)}}</text>
              <text class="col-status status-{{item.status}}">{{utils.formatStatus(item.status)}}</text>
              <text class="col-time">{{utils.formatDate(item.created_at)}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</match-media>
