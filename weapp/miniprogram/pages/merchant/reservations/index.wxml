<!-- å•†æˆ·é¢„è®¢ç®¡ç†é¡µé¢ - PC-SaaS é£æ ¼ -->
<wxs src="./utils.wxs" module="utils" />

<!-- ç§»åŠ¨ç«¯å¯¼èˆª -->
<custom-navbar wx:if="{{!isLargeScreen}}" title="é¢„è®¢ç®¡ç†" showBack="{{true}}" bind:navheight="onNavHeight" />

<view class="page-container {{isLargeScreen ? 'pc-saas-layout' : ''}}" style="{{!isLargeScreen ? 'padding-top:' + navBarHeight + 'px' : ''}}">
  <!-- PC ä¾§è¾¹æ  -->
  <merchant-sidebar wx:if="{{isLargeScreen}}" activeMenu="reservations" />

  <!-- ä¸»å†…å®¹åŒº -->
  <view class="main-content">
    <!-- é¡µé¢æ ‡é¢˜æ  -->
    <view class="page-header">
      <view class="header-left">
        <text class="page-title">é¢„è®¢ç®¡ç†</text>
        <text class="page-subtitle">ç®¡ç†åŒ…é—´é¢„è®¢ã€åˆ°åº—æ ¸é”€</text>
      </view>
      <view class="header-right">
        <button class="btn-primary" bindtap="onShowCreateModal">+ æ–°å»ºé¢„è®¢</button>
      </view>
    </view>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-row" wx:if="{{stats}}">
      <view class="stat-card">
        <text class="stat-value">{{stats.pending_count + stats.paid_count}}</text>
        <text class="stat-label">å¾…å¤„ç†</text>
      </view>
      <view class="stat-card">
        <text class="stat-value">{{stats.confirmed_count}}</text>
        <text class="stat-label">å·²ç¡®è®¤</text>
      </view>
      <view class="stat-card">
        <text class="stat-value">{{stats.checked_in_count || 0}}</text>
        <text class="stat-label">å·²åˆ°åº—</text>
      </view>
      <view class="stat-card">
        <text class="stat-value">{{stats.completed_count}}</text>
        <text class="stat-label">å·²å®Œæˆ</text>
      </view>
      <view class="stat-card warning">
        <text class="stat-value">{{stats.no_show_count}}</text>
        <text class="stat-label">æœªåˆ°åº—</text>
      </view>
    </view>

    <!-- Tab åˆ‡æ¢ -->
    <view class="tabs-container">
      <view class="tab-item {{activeTab === 'today' ? 'active' : ''}}" data-tab="today" bindtap="onTabChange">ä»Šæ—¥</view>
      <view class="tab-item {{activeTab === 'all' ? 'active' : ''}}" data-tab="all" bindtap="onTabChange">å…¨éƒ¨</view>
      <view class="tab-item {{activeTab === 'pending' ? 'active' : ''}}" data-tab="pending" bindtap="onTabChange">å¾…ç¡®è®¤</view>
      <view class="tab-item {{activeTab === 'confirmed' ? 'active' : ''}}" data-tab="confirmed" bindtap="onTabChange">å·²ç¡®è®¤</view>
      <view class="tab-item {{activeTab === 'completed' ? 'active' : ''}}" data-tab="completed" bindtap="onTabChange">å·²å®Œæˆ</view>
    </view>

    <!-- ç­›é€‰æ  -->
    <view class="filter-bar" wx:if="{{activeTab === 'all'}}">
      <picker mode="date" value="{{filterDate}}" bindchange="onDateChange">
        <view class="filter-item">
          <text class="filter-label">æ—¥æœŸ:</text>
          <text class="filter-value">{{filterDate || 'å…¨éƒ¨'}}</text>
          <text class="filter-icon">â–¼</text>
        </view>
      </picker>
      <view class="filter-clear" wx:if="{{filterDate}}" bindtap="onClearDate">æ¸…é™¤ç­›é€‰</view>
    </view>

    <!-- é¢„è®¢åˆ—è¡¨ -->
    <view class="reservations-list">
      <!-- åŠ è½½ä¸­ -->
      <view wx:if="{{loading}}" class="loading-container">
        <view class="loading-spinner"></view>
        <text>åŠ è½½ä¸­...</text>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:elif="{{reservations.length === 0}}" class="empty-state">
        <text class="empty-icon">ğŸ“…</text>
        <text class="empty-text">æš‚æ— é¢„è®¢è®°å½•</text>
        <button class="btn-primary small" bindtap="onShowCreateModal">åˆ›å»ºé¢„è®¢</button>
      </view>

      <!-- é¢„è®¢å¡ç‰‡ -->
      <view wx:else class="reservation-cards">
        <view wx:for="{{reservations}}" wx:key="id" class="reservation-card" data-id="{{item.id}}" bindtap="onViewDetail">
          <!-- å¡ç‰‡å¤´éƒ¨ -->
          <view class="card-header">
            <view class="card-title">
              <text class="table-no">{{item.table_no || 'åŒ…é—´'}}</text>
              <text class="guest-count">{{item.guest_count}}äºº</text>
            </view>
            <view class="status-tag {{utils.getStatusClass(item.status)}}">{{utils.getStatusText(item.status)}}</view>
          </view>

          <!-- å¡ç‰‡å†…å®¹ -->
          <view class="card-body">
            <view class="info-row">
              <text class="info-label">è”ç³»äºº</text>
              <text class="info-value">{{item.contact_name}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">ç”µè¯</text>
              <text class="info-value">{{item.contact_phone}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">æ—¶é—´</text>
              <text class="info-value">{{item.reservation_date}} {{item.reservation_time}}</text>
            </view>
            <view class="info-row" wx:if="{{item.deposit_amount || item.prepaid_amount}}">
              <text class="info-label">é‡‘é¢</text>
              <text class="info-value price">Â¥{{utils.formatAmount(item.deposit_amount || item.prepaid_amount)}}</text>
            </view>
            <view class="info-row" wx:if="{{item.source}}">
              <text class="info-label">æ¥æº</text>
              <text class="info-value">{{utils.getSourceText(item.source)}}</text>
            </view>
          </view>

          <!-- å¡ç‰‡æ“ä½œ -->
          <view class="card-actions" catchtap="">
            <!-- å¾…æ”¯ä»˜çŠ¶æ€ -->
            <block wx:if="{{item.status === 'pending'}}">
              <button class="btn-outline small" data-id="{{item.id}}" catchtap="onCancelReservation">å–æ¶ˆ</button>
            </block>

            <!-- å·²æ”¯ä»˜çŠ¶æ€ -->
            <block wx:elif="{{item.status === 'paid'}}">
              <button class="btn-outline small" data-id="{{item.id}}" catchtap="onCancelReservation">å–æ¶ˆé€€æ¬¾</button>
              <button class="btn-primary small" data-id="{{item.id}}" catchtap="onConfirmReservation">ç¡®è®¤</button>
            </block>

            <!-- å·²ç¡®è®¤çŠ¶æ€ -->
            <block wx:elif="{{item.status === 'confirmed'}}">
              <button class="btn-outline small" data-id="{{item.id}}" catchtap="onMarkNoShow">æœªåˆ°åº—</button>
              <button class="btn-success small" data-id="{{item.id}}" catchtap="onCheckIn">åˆ°åº—ç­¾åˆ°</button>
            </block>

            <!-- å·²ç­¾åˆ°çŠ¶æ€ -->
            <block wx:elif="{{item.status === 'checked_in'}}">
              <button class="btn-outline small" data-id="{{item.id}}" catchtap="onStartCooking">é€šçŸ¥èµ·èœ</button>
              <button class="btn-primary small" data-id="{{item.id}}" catchtap="onCompleteReservation">å®Œæˆ</button>
            </block>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- åˆ›å»ºé¢„è®¢å¼¹çª— -->
<view class="modal-overlay {{showCreateModal ? 'show' : ''}}" catchtap="onCloseCreateModal">
  <view class="modal-content" catchtap="onModalContentTap">
    <view class="modal-header">
      <text class="modal-title">æ–°å»ºé¢„è®¢</text>
      <text class="modal-close" bindtap="onCloseCreateModal">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="form-group">
        <text class="form-label">åŒ…é—´ * ({{tables.length}}ä¸ªå¯é€‰)</text>
        <view class="table-select-list" wx:if="{{tables.length}}">
          <view wx:for="{{tables}}" wx:key="id" 
                class="table-option {{createForm.table_id === item.id ? 'active' : ''}}" 
                data-table="{{item}}" 
                bindtap="onTableOptionTap">
            <text class="table-name">{{item.table_no}}</text>
            <text class="table-info">{{item.capacity}}äºº</text>
          </view>
        </view>
        <view class="no-tables" wx:else>
          <text>æš‚æ— å¯ç”¨åŒ…é—´</text>
        </view>
      </view>

      <view class="form-row">
        <view class="form-group half">
          <text class="form-label">æ—¥æœŸ *</text>
          <input class="form-input" type="text" value="{{createForm.date}}" data-field="date" bindinput="onFormInput" placeholder="YYYY-MM-DD" />
        </view>
        <view class="form-group half">
          <text class="form-label">æ—¶é—´ *</text>
          <input class="form-input" type="text" value="{{createForm.time}}" data-field="time" bindinput="onFormInput" placeholder="HH:MM" />
        </view>
      </view>

      <view class="form-row">
        <view class="form-group half">
          <text class="form-label">äººæ•° *</text>
          <input class="form-input" type="number" value="{{createForm.guest_count}}" data-field="guest_count" bindinput="onGuestCountChange" placeholder="ç”¨é¤äººæ•°" />
        </view>
        <view class="form-group half">
          <text class="form-label">æ¥æº</text>
          <view class="source-buttons">
            <view class="source-btn {{createForm.source === 'phone' ? 'active' : ''}}" data-source="phone" bindtap="onSourceTap">ç”µè¯</view>
            <view class="source-btn {{createForm.source === 'walkin' ? 'active' : ''}}" data-source="walkin" bindtap="onSourceTap">ç°åœº</view>
            <view class="source-btn {{createForm.source === 'merchant' ? 'active' : ''}}" data-source="merchant" bindtap="onSourceTap">ä»£è®¢</view>
          </view>
        </view>
      </view>

      <view class="form-group">
        <text class="form-label">è”ç³»äºº *</text>
        <input class="form-input" value="{{createForm.contact_name}}" data-field="contact_name" bindinput="onFormInput" placeholder="é¡¾å®¢å§“å" />
      </view>

      <view class="form-group">
        <text class="form-label">è”ç³»ç”µè¯ *</text>
        <input class="form-input" type="number" value="{{createForm.contact_phone}}" data-field="contact_phone" bindinput="onFormInput" placeholder="æ‰‹æœºå·ç " />
      </view>

      <view class="form-group">
        <text class="form-label">å¤‡æ³¨</text>
        <textarea class="form-textarea" value="{{createForm.notes}}" data-field="notes" bindinput="onFormInput" placeholder="ç‰¹æ®Šè¦æ±‚ã€å¤‡æ³¨ä¿¡æ¯ç­‰" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-outline" bindtap="onCloseCreateModal">å–æ¶ˆ</button>
      <button class="btn-primary" bindtap="onSubmitCreate">åˆ›å»ºé¢„è®¢</button>
    </view>
  </view>
</view>

<!-- é¢„è®¢è¯¦æƒ…å¼¹çª— -->
<view class="modal-overlay {{showDetailModal ? 'show' : ''}}" catchtap="onCloseDetailModal">
  <view class="modal-content detail-modal" catchtap="onModalContentTap" wx:if="{{selectedReservation}}">
    <view class="modal-header">
      <text class="modal-title">é¢„è®¢è¯¦æƒ…</text>
      <text class="modal-close" bindtap="onCloseDetailModal">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="detail-section">
        <view class="detail-row">
          <text class="detail-label">é¢„è®¢ID</text>
          <text class="detail-value">{{selectedReservation.id}}</text>
        </view>
        <view class="detail-row">
          <text class="detail-label">çŠ¶æ€</text>
          <text class="detail-value status-tag {{utils.getStatusClass(selectedReservation.status)}}">{{utils.getStatusText(selectedReservation.status)}}</text>
        </view>
        <view class="detail-row">
          <text class="detail-label">åŒ…é—´</text>
          <text class="detail-value">{{selectedReservation.table_no}}</text>
        </view>
        <view class="detail-row">
          <text class="detail-label">æ—¶é—´</text>
          <text class="detail-value">{{selectedReservation.reservation_date}} {{selectedReservation.reservation_time}}</text>
        </view>
        <view class="detail-row">
          <text class="detail-label">äººæ•°</text>
          <text class="detail-value">{{selectedReservation.guest_count}}äºº</text>
        </view>
      </view>

      <view class="detail-section">
        <view class="detail-row">
          <text class="detail-label">è”ç³»äºº</text>
          <text class="detail-value">{{selectedReservation.contact_name}}</text>
        </view>
        <view class="detail-row">
          <text class="detail-label">ç”µè¯</text>
          <text class="detail-value">{{selectedReservation.contact_phone}}</text>
        </view>
      </view>

      <view class="detail-section" wx:if="{{selectedReservation.deposit_amount || selectedReservation.prepaid_amount}}">
        <view class="detail-row">
          <text class="detail-label">å®šé‡‘</text>
          <text class="detail-value price">Â¥{{utils.formatAmount(selectedReservation.deposit_amount)}}</text>
        </view>
        <view class="detail-row" wx:if="{{selectedReservation.prepaid_amount}}">
          <text class="detail-label">é¢„ä»˜</text>
          <text class="detail-value price">Â¥{{utils.formatAmount(selectedReservation.prepaid_amount)}}</text>
        </view>
      </view>

      <view class="detail-section" wx:if="{{selectedReservation.notes}}">
        <view class="detail-row">
          <text class="detail-label">å¤‡æ³¨</text>
          <text class="detail-value">{{selectedReservation.notes}}</text>
        </view>
      </view>

      <view class="detail-section">
        <view class="detail-row">
          <text class="detail-label">åˆ›å»ºæ—¶é—´</text>
          <text class="detail-value">{{selectedReservation.created_at}}</text>
        </view>
        <view class="detail-row" wx:if="{{selectedReservation.source}}">
          <text class="detail-label">é¢„è®¢æ¥æº</text>
          <text class="detail-value">{{utils.getSourceText(selectedReservation.source)}}</text>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-outline" bindtap="onCloseDetailModal">å…³é—­</button>
    </view>
  </view>
</view>
