<!-- å•†æˆ·é¢„è®¢ç®¡ç†é¡µé¢ - æ¡Œé¢çº§ SaaS ç•Œé¢ -->
<wxs src="./utils.wxs" module="utils" />

<!-- å°å±æç¤º -->
<match-media max-width="1599">
  <view class="desktop-only-notice">
    <view class="notice-box">
      <view class="notice-icon">ğŸ–¥ï¸</view>
      <text class="notice-title">æ­¤åŠŸèƒ½éœ€è¦åœ¨ç”µè„‘ç«¯ä½¿ç”¨</text>
      <text class="notice-desc">è¯·ä½¿ç”¨ 1600px ä»¥ä¸Šåˆ†è¾¨ç‡çš„æ˜¾ç¤ºå™¨è®¿é—®é¢„è®¢ç®¡ç†</text>
      <navigator url="/pages/merchant/dashboard/index" class="btn-back">è¿”å›å·¥ä½œå°</navigator>
    </view>
  </view>
</match-media>

<!-- å¤§å±å¸ƒå±€ -->
<match-media min-width="1600">
  <view class="saas-layout">
    <!-- ä¾§è¾¹æ  -->
    <merchant-sidebar 
      current-path="reservations" 
      collapsed="{{sidebarCollapsed}}"
      bind:collapse="onSidebarCollapse"
    />

    <!-- ä¸»åŒºåŸŸ -->
    <view class="main-area" style="margin-left: {{sidebarCollapsed ? 64 : 200}}px;">
      <!-- é¡¶éƒ¨æ  -->
      <merchant-header 
        merchant-name="{{merchantName}}"
        sidebar-width="{{sidebarCollapsed ? 64 : 200}}"
      />

      <!-- é¡µé¢å†…å®¹ -->
      <view class="page-container">
        <!-- å·¦ä¾§ï¼šæ—¥å†é€‰æ‹©åŒº -->
        <view class="left-panel">
          <view class="panel-header">
            <text class="panel-title">æ—¥æœŸé€‰æ‹©</text>
          </view>
          <view class="calendar-wrapper">
            <view class="calendar-header">
              <view class="month-nav">
                <view class="nav-arrow" bindtap="onPrevMonth">â€¹</view>
                <text class="month-text">{{currentYear}}å¹´{{currentMonth}}æœˆ</text>
                <view class="nav-arrow" bindtap="onNextMonth">â€º</view>
              </view>
              <view class="today-btn" bindtap="onSelectToday">å›åˆ°ä»Šå¤©</view>
            </view>
            <view class="calendar-grid">
              <view class="weekday-row">
                <text>æ—¥</text><text>ä¸€</text><text>äºŒ</text><text>ä¸‰</text><text>å››</text><text>äº”</text><text>å…­</text>
              </view>
              <view class="days-grid">
                <!-- ç©ºç™½å¡«å…… -->
                <view wx:for="{{emptyDays}}" wx:key="index" class="day-cell empty"></view>
                <!-- æ—¥æœŸ -->
                <view wx:for="{{daysInMonth}}" wx:key="day" 
                      class="day-cell {{item.day === selectedDay && item.month === selectedMonth ? 'active' : ''}} {{item.isToday ? 'today' : ''}} {{item.disabled ? 'disabled' : ''}}"
                      data-date="{{item.fullDate}}"
                      data-disabled="{{item.disabled}}"
                      bindtap="onDateSelect">
                  <text class="day-num">{{item.day}}</text>
                  <view class="day-dot" wx:if="{{item.hasReservations}}"></view>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- å³ä¾§ï¼šæ¡Œå°çŠ¶æ€åŒº -->
        <view class="right-panel">
          <view class="panel-header">
            <view class="header-left">
              <text class="panel-title">{{selectedDateDisplay}} é¢„è®¢æ¦‚è§ˆ</text>
              <view class="stats-tags">
                <view class="stat-tag"><view class="dot pending"></view>å¾…å¤„ç†</view>
                <view class="stat-tag"><view class="dot confirmed"></view>å·²ç¡®è®¤</view>
                <view class="stat-tag"><view class="dot checked_in"></view>å·²åˆ°åº—</view>
              </view>
            </view>
            <view class="header-right"></view>
          </view>

          <!-- æ¡Œå°å¹³é“ºè§†å›¾ -->
          <scroll-view scroll-y class="tables-grid-scroll">
            <view class="tables-grid">
              <view wx:for="{{tableViews}}" wx:key="id" class="table-card" bindtap="onKeyTableTap" data-id="{{item.id}}">
                <view class="table-card-header">
                  <text class="table-name">{{item.table_no}}</text>
                  <text class="table-capacity">{{item.capacity}}äººæ¡Œ</text>
                </view>
                
                <!-- åªæœ‰å½“æœ‰é¢„è®¢æ—¶æ‰æ˜¾ç¤ºåˆ—è¡¨ -->
                <view class="table-reservations" wx:if="{{item.todayReservations && item.todayReservations.length > 0}}">
                  <view wx:for="{{item.todayReservations}}" wx:for-item="res" wx:key="id" 
                        class="mini-res-item {{utils.getStatusClass(res.status)}}"
                        catchtap="onViewDetail" data-id="{{res.id}}">
                    <text class="res-time">{{res.reservation_time}}</text>
                    <text class="res-name">{{res.contact_name}}</text>
                    <text class="res-status">{{utils.getStatusText(res.status)}}</text>
                  </view>
                </view>
                
                <!-- ç©ºé—²çŠ¶æ€ -->
                <view class="table-empty" wx:else>
                  <text class="empty-text">å½“å‰ç©ºé—²</text>
                  <view class="add-icon">+</view>
                </view>
              </view>
            </view>
          </scroll-view>
        </view>
      </view>
    </view>
  </view>
</match-media>

<!-- åˆ›å»ºé¢„è®¢å¼¹çª— -->
<view class="modal-overlay {{showCreateModal ? 'show' : ''}}" catchtap="onCloseCreateModal">
  <view class="modal-content" catchtap="onModalContentTap">
    <view class="modal-header">
      <text class="modal-title">æ–°å»ºé¢„è®¢</text>
      <text class="modal-close" bindtap="onCloseCreateModal">Ã—</text>
    </view>
    <view class="modal-body">
      <!-- å·²é€‰ä¿¡æ¯å±•ç¤º -->
      <view class="selected-info-bar">
        <view class="info-item">
          <text class="label">æ—¥æœŸ</text>
          <text class="value">{{createForm.date}}</text>
        </view>
        <view class="info-item">
          <text class="label">åŒ…é—´</text>
          <text class="value">{{selectedTableName || 'æœªé€‰æ‹©'}}</text>
        </view>
      </view>

      <view class="form-row">
        <view class="form-group half">
          <text class="form-label">æ—¶é—´ *</text>
          <view class="time-select-list">
             <view wx:for="{{timeOptions}}" wx:key="value" 
                   class="time-option {{createForm.time === item.value ? 'active' : ''}} {{item.disabled ? 'disabled' : ''}}" 
                   bindtap="onTimeSelect" 
                   data-time="{{item.value}}"
                   data-disabled="{{item.disabled}}">
               {{item.value}}
             </view>
          </view>
        </view>
        <view class="form-group half">
          <text class="form-label">äººæ•° *</text>
          <view class="count-stepper">
            <view class="stepper-btn" bindtap="onGuestCountDec">-</view>
            <input class="stepper-input" type="number" value="{{createForm.guest_count}}" disabled />
            <view class="stepper-btn" bindtap="onGuestCountInc">+</view>
          </view>
        </view>
      </view>

      <view class="form-group">
        <text class="form-label">æ¥æº</text>
        <view class="source-buttons">
          <view class="source-btn {{createForm.source === 'phone' ? 'active' : ''}}" data-source="phone" bindtap="onSourceTap">ç”µè¯é¢„è®¢</view>
          <view class="source-btn {{createForm.source === 'walkin' ? 'active' : ''}}" data-source="walkin" bindtap="onSourceTap">ç°åœºé¡¾å®¢</view>
          <view class="source-btn {{createForm.source === 'merchant' ? 'active' : ''}}" data-source="merchant" bindtap="onSourceTap">å•†æˆ·ä»£è®¢</view>
        </view>
      </view>

      <view class="form-row">
        <view class="form-group half">
           <text class="form-label">è”ç³»äºº *</text>
           <input class="form-input" value="{{createForm.contact_name}}" data-field="contact_name" bindinput="onFormInput" placeholder="è¯·è¾“å…¥å§“å" />
        </view>
        <view class="form-group half">
           <text class="form-label">ç”µè¯ *</text>
           <input class="form-input" type="number" value="{{createForm.contact_phone}}" data-field="contact_phone" bindinput="onFormInput" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
        </view>
      </view>

      <view class="form-group">
        <text class="form-label">å¤‡æ³¨</text>
        <textarea class="form-textarea" value="{{createForm.notes}}" data-field="notes" bindinput="onFormInput" placeholder="å¤‡æ³¨ä¿¡æ¯..." />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-outline" bindtap="onCloseCreateModal">å–æ¶ˆ</button>
      <button class="btn-primary" bindtap="onSubmitCreate">ç¡®å®šåˆ›å»º</button>
    </view>
  </view>
</view>

<!-- è¯¦æƒ…å¼¹çª— -->
<view class="modal-overlay {{showDetailModal ? 'show' : ''}}" catchtap="onCloseDetailModal">
  <view class="modal-content detail-modal" catchtap="onModalContentTap" wx:if="{{selectedReservation}}">
     <view class="modal-header">
      <text class="modal-title">é¢„è®¢è¯¦æƒ…</text>
      <text class="modal-close" bindtap="onCloseDetailModal">Ã—</text>
    </view>
    <view class="modal-body">
       <view class="detail-row">
          <text class="detail-label">çŠ¶æ€</text>
          <text class="detail-value status-tag {{utils.getStatusClass(selectedReservation.status)}}">{{utils.getStatusText(selectedReservation.status)}}</text>
       </view>
       <view class="detail-row">
          <text class="detail-label">é¡¾å®¢</text>
          <text class="detail-value">{{selectedReservation.contact_name}} ({{selectedReservation.guest_count}}äºº)</text>
       </view>
       <view class="detail-row">
          <text class="detail-label">ç”µè¯</text>
          <text class="detail-value">{{selectedReservation.contact_phone}}</text>
       </view>
       <view class="detail-row">
          <text class="detail-label">æ—¶é—´</text>
          <text class="detail-value">{{selectedReservation.reservation_time}}</text>
       </view>
       <view class="detail-row" wx:if="{{selectedReservation.notes}}">
          <text class="detail-label">å¤‡æ³¨</text>
          <text class="detail-value">{{selectedReservation.notes}}</text>
       </view>
    </view>
    <view class="modal-footer">
      <button class="btn-danger" 
              wx:if="{{selectedReservation.status === 'pending' || selectedReservation.status === 'paid' || selectedReservation.status === 'confirmed'}}" 
              bindtap="onCancelReservation" 
              data-id="{{selectedReservation.id}}">å–æ¶ˆé¢„è®¢</button>
      <button class="btn-primary" 
              wx:if="{{selectedReservation.status === 'confirmed' || selectedReservation.status === 'paid'}}" 
              bindtap="onCheckIn" 
              data-id="{{selectedReservation.id}}">ç­¾åˆ°</button>
      <button class="btn-outline" bindtap="onCloseDetailModal">å…³é—­</button>
    </view>
  </view>
</view>
