<custom-navbar title="{{restaurant.short_name || 'é¤å…è¯¦æƒ…'}}" showBack="{{true}}" bind:navheight="onNavHeight" />

<view class="page-container customer-page-container" style="padding-top: {{navBarHeight}}px; padding-bottom: 120rpx;">
  <t-loading wx:if="{{loading}}" theme="circular" size="40rpx" class="loading" />
  
  <view wx:if="{{!loading && restaurant}}" class="detail-content">
    <!-- å¤´å›¾ -->
    <view class="header-section" style="background-image: url('/assets/happy.jpg')">
      <view class="header-overlay">
        <view class="restaurant-name">{{restaurant.name}}</view>
        <view class="restaurant-meta">
          <text class="address" bindtap="onMapTap">{{restaurant.address}}</text>
          <text class="distance">{{restaurant.distance_meters}}m</text>
        </view>
        <view class="restaurant-service">
          <text class="service-count">æœ¬æœˆä¸º{{restaurant.monthly_served || 2300}}äººæä¾›é¤é¥®æœåŠ¡</text>
          <text class="delivery-time">å¤–å–çº¦20åˆ†é’Ÿå‡ºé¤</text>
        </view>
        <view class="restaurant-tags">
          <t-tag wx:for="{{restaurant.tags}}" wx:key="*this" size="small" theme="light">{{item}}</t-tag>
        </view>
      </view>
    </view>

    <!-- Tabåˆ‡æ¢ -->
    <view class="tabs-section">
      <t-tabs value="{{activeTab}}" bind:change="onTabChange">
        <t-tab-panel label="èœå“" value="dishes" />
        <t-tab-panel label="è¯„ä»·({{reviews.length}})" value="reviews" />
        <t-tab-panel label="å•†å®¶" value="info" />
      </t-tabs>
    </view>

    <!-- èœå“Tab -->
    <view wx:if="{{activeTab === 'dishes'}}" class="dishes-tab">
      <view class="dishes-container">
        <!-- å·¦ä¾§åˆ†ç±» -->
        <scroll-view class="category-sidebar" scroll-y>
          <view 
            wx:for="{{categories}}" 
            wx:key="id"
            class="category-item {{activeCategoryId === item.id ? 'active' : ''}}"
            data-id="{{item.id}}"
            bindtap="onCategoryChange"
          >
            {{item.name}}
          </view>
        </scroll-view>

        <!-- å³ä¾§èœå“åˆ—è¡¨ -->
        <scroll-view class="dishes-list" scroll-y>
          <view wx:for="{{filteredDishes}}" wx:key="id" class="dish-item" data-id="{{item.id}}" bindtap="onDishTap">
            <t-image class="dish-image" src="{{item.image_url}}" mode="aspectFill" />
            <view class="dish-info">
              <text class="dish-name">{{item.name}}</text>
              <view class="dish-tags" wx:if="{{item.tags.length > 0 || item.is_premade}}">
                <t-tag wx:if="{{item.is_premade}}" theme="warning" size="small">é¢„åˆ¶èœ</t-tag>
                <t-tag wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this" size="small" variant="light">{{tag}}</t-tag>
              </view>
              <view class="dish-meta">
                <text class="rating">â­{{item.rating}}</text>
                <text class="sales">æœˆé”€{{item.month_sales}}</text>
              </view>
              <view class="dish-price-row">
                <text class="dish-price">Â¥{{item.price / 100}}</text>
                <text wx:if="{{item.original_price > item.price}}" class="dish-original-price">Â¥{{item.original_price / 100}}</text>
              </view>
            </view>
            <t-button 
              class="add-btn" 
              size="small" 
              icon="add" 
              shape="circle" 
              theme="primary"
              data-id="{{item.id}}"
              catchtap="onAddCart"
            />
          </view>
          <view wx:if="{{filteredDishes.length === 0}}" class="empty-category">
            <text>è¯¥åˆ†ç±»æš‚æ— èœå“</text>
          </view>
        </scroll-view>
      </view>
    </view>

    <!-- è¯„ä»·Tab -->
    <view wx:if="{{activeTab === 'reviews'}}" class="reviews-tab">
      <block wx:if="{{reviews.length > 0}}">
        <view wx:for="{{reviews}}" wx:key="id" class="review-item">
          <view class="review-header">
            <text class="reviewer-name">{{item.user_name}}</text>
            <text class="review-date">{{item.created_at}}</text>
          </view>
          <view class="review-rating">
            <text wx:for="{{[1,2,3,4,5]}}" wx:for-item="star" wx:key="*this" class="star {{item.rating >= star ? 'active' : ''}}">â˜…</text>
          </view>
          <text wx:if="{{item.dish_name}}" class="review-dish">è´­ä¹°äº†: {{item.dish_name}}</text>
          <text class="review-content">{{item.content}}</text>
          <view wx:if="{{item.images.length > 0}}" class="review-images">
            <t-image wx:for="{{item.images}}" wx:for-item="img" wx:key="*this" class="review-image" src="{{img}}" mode="aspectFill" />
          </view>
        </view>
      </block>
      <t-empty wx:else description="æš‚æ— è¯„ä»·" />
    </view>

    <!-- å•†å®¶Tab -->
    <view wx:if="{{activeTab === 'info'}}" class="info-tab">
      <view class="info-section">
        <view class="section-title">å•†å®¶ä»‹ç»</view>
        <text class="info-desc">{{restaurant.description}}</text>
      </view>
      <view class="info-section">
        <view class="section-title">å•†å®¶ä¿¡æ¯</view>
        <view class="info-item">
          <text class="info-label">è¥ä¸šçŠ¶æ€</text>
          <text class="info-value {{restaurant.biz_status === 'OPEN' ? 'open' : 'closed'}}">{{restaurant.biz_status === 'OPEN' ? 'è¥ä¸šä¸­' : 'ä¼‘æ¯ä¸­'}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">è¥ä¸šæ—¶é—´</text>
          <text class="info-value">{{restaurant.business_hours.open}} - {{restaurant.business_hours.close}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">é…é€è´¹</text>
          <text class="info-value">Â¥{{restaurant.delivery_fee / 100}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">é¢„è®¡é€è¾¾</text>
          <text class="info-value">çº¦{{restaurant.delivery_time_minutes}}åˆ†é’Ÿ</text>
        </view>
        <view class="info-item">
          <text class="info-label">æ»¡å‡ä¼˜æƒ </text>
          <text class="info-value highlight">æ»¡Â¥{{restaurant.discount_threshold / 100}}å‡Â¥5</text>
        </view>
        <view class="info-item" bindtap="onCall">
          <text class="info-label">è”ç³»ç”µè¯</text>
          <text class="info-value call">{{restaurant.phone}} â€º</text>
        </view>
        <view class="info-item" bindtap="onMapTap">
          <text class="info-label">å•†å®¶åœ°å€</text>
          <text class="info-value call">{{restaurant.address}} â€º</text>
        </view>
      </view>
      <view class="info-section">
        <view class="section-title">èµ„è´¨ä¿¡æ¯</view>
        <view class="info-item">
          <text class="info-label">è¥ä¸šæ‰§ç…§</text>
          <text class="info-value license">{{restaurant.license_no}}</text>
        </view>
        <view class="license-images">
          <view class="license-item">
            <t-image class="license-image" src="/assets/niumen.jpg" mode="aspectFit" bindtap="onPreviewLicense" data-src="/assets/niumen.jpg" />
            <text class="license-name">è¥ä¸šæ‰§ç…§</text>
          </view>
          <view class="license-item">
            <t-image class="license-image" src="/assets/niumenshian.jpg" mode="aspectFit" bindtap="onPreviewLicense" data-src="/assets/niumenshian.jpg" />
            <text class="license-name">é£Ÿå“ç»è¥è®¸å¯è¯</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- è´­ç‰©è½¦æ  -->
<view wx:if="{{!loading && restaurant && cartCount > 0}}" class="cart-bar">
  <view class="cart-info">
    <text class="cart-count">ğŸ›’ {{cartCount}}ä»¶</text>
    <text class="cart-price">Â¥{{cartPrice / 100}}</text>
  </view>
  <t-button class="checkout-btn" theme="primary" bindtap="onCheckout">å»ç»“ç®—</t-button>
</view>
