<custom-navbar title="èœå“è¯¦æƒ…" showBack="{{true}}" bind:navheight="onNavHeight" />

<view class="page-container" style="padding-top: {{navBarHeight}}px; padding-bottom: 120rpx;">
  <t-loading wx:if="{{loading}}" theme="circular" size="40rpx" class="loading" />
  
  <view wx:if="{{!loading && dish}}" class="detail-content">
    <!-- å›¾ç‰‡è½®æ’­ -->
    <swiper class="image-swiper" indicator-dots indicator-color="rgba(255,255,255,0.5)" indicator-active-color="#fff" bindchange="onImageChange">
      <swiper-item wx:for="{{dish.images}}" wx:key="*this">
        <t-image class="dish-image" src="{{item}}" mode="aspectFill" />
      </swiper-item>
    </swiper>
    <view class="image-indicator">{{currentImageIndex + 1}}/{{dish.images.length}}</view>

    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="info-section">
      <view class="shop-dish-name">{{dish.shop_name}}Â·{{dish.name}}</view>
      <view class="price-row">
        <text class="price">Â¥{{dish.priceDisplay}}</text>
        <text wx:if="{{dish.originalPriceDisplay}}" class="original-price">Â¥{{dish.originalPriceDisplay}}</text>
      </view>
      <view class="tags-row">
        <t-tag wx:if="{{dish.is_premade}}" theme="warning" size="small">é¢„åˆ¶èœ</t-tag>
        <t-tag wx:for="{{dish.attributes}}" wx:key="*this" size="small">{{item}}</t-tag>
      </view>
      <view class="meta-row">
        <text class="sales">æœˆé”€{{dish.month_sales}}</text>
      </view>
      <view class="delivery-row">
        <text class="distance">ğŸ“{{dish.distance_meters}}m</text>
        <text class="delivery-time">ğŸ•é¢„è®¡{{dish.delivery_time_minutes}}åˆ†é’Ÿé€è¾¾</text>
      </view>
    </view>

    <!-- è§„æ ¼é€‰æ‹© -->
    <view class="spec-section" wx:if="{{dish.spec_groups && dish.spec_groups.length > 0}}">
      <view class="spec-group" wx:for="{{dish.spec_groups}}" wx:for-item="group" wx:key="id">
        <view class="section-title">{{group.name}}</view>
        <view class="spec-options">
          <t-tag 
            wx:for="{{group.specs}}" 
            wx:for-item="spec" 
            wx:key="id"
            class="spec-tag {{selectedSpecs[group.id] === spec.id ? 'active' : ''}}"
            variant="{{selectedSpecs[group.id] === spec.id ? 'light' : 'outline'}}"
            theme="{{selectedSpecs[group.id] === spec.id ? 'primary' : 'default'}}"
            data-group-id="{{group.id}}"
            data-spec-id="{{spec.id}}"
            bind:tap="onSpecTap"
          >
            {{spec.name}} <text wx:if="{{spec.priceDiffDisplay}}">+Â¥{{spec.priceDiffDisplay}}</text>
          </t-tag>
        </view>
      </view>
    </view>

    <!-- èœå“è¯¦æƒ… -->
    <view class="description-section">
      <view class="section-title">èœå“è¯¦æƒ…</view>
      <text class="description">{{dish.description}}</text>
    </view>

    <!-- å•†å®¶ä¿¡æ¯ -->
    <view class="shop-section" bindtap="onShopTap">
      <view class="shop-info">
        <text class="shop-name">{{dish.shop_name}}</text>
        <text class="shop-arrow">â€º</text>
      </view>
    </view>

    <!-- è¯„ä»· -->
    <view class="review-section">
      <view class="section-title">è¯„ä»· ({{dish.reviews.length}})</view>
      <view wx:for="{{dish.reviews}}" wx:key="id" class="review-item">
        <view class="review-header">
          <text class="reviewer-name">{{item.user_name}}</text>
          <text class="review-date">{{item.created_at}}</text>
        </view>
        <view class="review-rating">
          <text wx:for="{{[1,2,3,4,5]}}" wx:key="*this" class="star">{{item.rating >= item ? 'â­' : 'â˜†'}}</text>
        </view>
        <text class="review-content">{{item.content}}</text>
        <view wx:if="{{item.images.length > 0}}" class="review-images">
          <t-image wx:for="{{item.images}}" wx:key="*this" class="review-image" src="{{item}}" mode="aspectFill" />
        </view>
      </view>
    </view>
  </view>
</view>

<!-- åº•éƒ¨æ“ä½œæ  -->
<view wx:if="{{!loading && dish}}" class="bottom-bar">
  <view class="quantity-control">
    <t-button size="small" icon="remove" shape="circle" data-type="minus" bindtap="onQuantityChange" />
    <text class="quantity">{{quantity}}</text>
    <t-button size="small" icon="add" shape="circle" theme="primary" data-type="plus" bindtap="onQuantityChange" />
  </view>
  <t-button class="cart-btn" bindtap="onAddToCart">åŠ å…¥è´­ç‰©è½¦</t-button>
  <t-button class="buy-btn" theme="primary" bindtap="onBuyNow">ç«‹å³è´­ä¹°</t-button>
</view>
