<custom-navbar title="å¤–å–" location="{{address}}" bind:locationchange="onLocationChange" />

<!-- Skyline éœ€è¦ç”¨ scroll-view å®ç°é¡µé¢æ»šåŠ¨å’Œä¸‹æ‹‰åˆ·æ–° -->
<scroll-view 
  scroll-y 
  class="page-scroll" 
  style="height: {{scrollViewHeight}}px; margin-top: {{navBarHeight}}px;"
  bindscrolltolower="onReachBottom"
  lower-threshold="200"
  refresher-enabled="{{true}}"
  refresher-triggered="{{refresherTriggered}}"
  bindrefresherrefresh="onRefresh"
  enhanced="{{true}}"
  show-scrollbar="{{false}}"
>
  <!-- æœç´¢æ¡† -->
  <view class="search-section">
    <t-search 
      model:value="{{searchKeyword}}"
      placeholder="æœç´¢èœå“ã€å•†å®¶"
      bind:change="onSearch"
    />
  </view>

  <!-- 3ä¸ªTab -->
  <view class="tabs-section">
    <t-tabs value="{{activeTab}}" bind:change="onTabChange">
      <t-tab-panel label="èœå“åˆ—è¡¨" value="dishes" />
      <t-tab-panel label="é¤å…åˆ—è¡¨" value="restaurants" />
      <t-tab-panel label="å¥—é¤åˆ—è¡¨" value="packages" />
    </t-tabs>
  </view>

  <!-- åˆ†ç±»å¯¼èˆª (æœ‰æ ‡ç­¾æ—¶æ˜¾ç¤ºï¼Œåªæœ‰"å…¨éƒ¨"æ—¶éšè—) -->
  <view wx:if="{{categories.length > 1}}" class="category-section">
    <category-tabs 
      categories="{{categories}}"
      activeId="{{activeCategoryId}}"
      bind:change="onTabCategoryChange"
    />
  </view>

  <!-- ä½ç½®å¼•å¯¼æç¤º -->
  <view wx:if="{{needLocation}}" class="location-guide">
    <view class="location-guide-icon">ğŸ“</view>
    <view class="location-guide-title">éœ€è¦æ‚¨çš„ä½ç½®ä¿¡æ¯</view>
    <view class="location-guide-desc">æœ¬åœ°ç”Ÿæ´»æœåŠ¡ä¾èµ–äºæ‚¨çš„ä½ç½®ï¼Œè¯·å…ˆå®Œæˆå®šä½</view>
    <view class="location-guide-buttons">
      <t-button theme="primary" size="small" bind:tap="onRetryLocation">é‡æ–°å®šä½</t-button>
      <t-button theme="light" size="small" bind:tap="onManualLocation">æ‰‹åŠ¨é€‰æ‹©</t-button>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content-section" wx:if="{{!needLocation}}">
    <!-- èœå“åˆ—è¡¨ -->
    <block wx:if="{{activeTab === 'dishes'}}">
      <!-- éª¨æ¶å± -->
      <block wx:if="{{loading && dishes.length === 0}}">
        <dish-skeleton wx:for="{{[1,2,3,4,5]}}" wx:key="*this" />
      </block>
      
      <!-- çœŸå®æ•°æ® -->
      <dish-card 
        wx:for="{{dishes}}" 
        wx:key="id"
        dish="{{item}}"
        bind:add="onAddCart"
      />
      <t-empty wx:if="{{!loading && dishes.length === 0}}" description="æš‚æ— èœå“" />
      <view wx:if="{{!hasMore && dishes.length > 0}}" class="no-more">æ²¡æœ‰æ›´å¤šäº†</view>
    </block>

    <!-- é¤å…åˆ—è¡¨ -->
    <block wx:if="{{activeTab === 'restaurants'}}">
      <restaurant-card 
        wx:for="{{restaurants}}" 
        wx:key="id"
        restaurant="{{item}}"
      />
      <t-empty wx:if="{{!loading && restaurants.length === 0}}" description="æš‚æ— é¤å…" />
      <view wx:if="{{!hasMore && restaurants.length > 0}}" class="no-more">æ²¡æœ‰æ›´å¤šäº†</view>
    </block>

    <!-- å¥—é¤åˆ—è¡¨ -->
    <block wx:if="{{activeTab === 'packages'}}">
      <view wx:for="{{packages}}" wx:key="id" class="package-card" bindtap="onPackageTap" data-id="{{item.id}}">
        <t-image class="package-image" src="{{item.imageUrl}}" mode="aspectFill" lazy />
        <view class="package-info">
          <!-- ç¬¬1è¡Œ: åº—åÂ·å¥—é¤å -->
          <view class="row-1">
            <text class="shop-dish-name">{{item.merchantName}}Â·{{item.name}}</text>
          </view>
          <!-- ç¬¬2è¡Œ: ä»·æ ¼ | é”€é‡ -->
          <view class="row-2">
            <text class="price">{{item.priceDisplay}}</text>
            <text class="separator">|</text>
            <text class="sales">{{item.salesBadge}}</text>
          </view>
          <!-- ç¬¬3è¡Œ: è·ç¦» + ä¼˜æƒ ç™¾åˆ†æ¯” -->
          <view class="row-3">
            <text class="distance">ğŸ“{{item.distance}}</text>
            <text wx:if="{{item.savingsPercent > 0}}" class="discount">çœ{{item.savingsPercent}}%</text>
          </view>
          <!-- ç¬¬4è¡Œ: é…é€è´¹ -->
          <view wx:if="{{item.deliveryFeeDisplay}}" class="row-4">
            <text class="delivery-fee">{{item.deliveryFeeDisplay}}</text>
          </view>
          <!-- ç¬¬5è¡Œ: æ ‡ç­¾ -->
          <view wx:if="{{item.tags.length > 0}}" class="row-5">
            <t-tag wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this" size="small" variant="light">{{tag}}</t-tag>
          </view>
        </view>
        <!-- åŠ è´­æŒ‰é’® -->
        <t-button class="add-btn" theme="primary" size="small" icon="add" shape="circle" catchtap="onAddComboToCart" data-id="{{item.id}}" data-merchant-id="{{item.merchantId}}" />
      </view>
      <t-empty wx:if="{{!loading && packages.length === 0}}" description="æš‚æ— å¥—é¤" />
      <view wx:if="{{!hasMore && packages.length > 0}}" class="no-more">æ²¡æœ‰æ›´å¤šäº†</view>
    </block>

    <!-- åŠ è½½ä¸­ -->
    <view wx:if="{{loading}}" class="loading-wrapper">
      <t-loading theme="circular" size="40rpx" text="åŠ è½½ä¸­..." />
    </view>
  </view>
  
  <!-- åº•éƒ¨å®‰å…¨åŒºå ä½ (ä»…è´­ç‰©è½¦æ˜¾ç¤ºæ—¶) -->
  <view wx:if="{{activeTab === 'dishes' && cartTotalCount > 0}}" style="height: 120rpx;"></view>
</scroll-view>

<!-- è´­ç‰©è½¦æ  -->
<cart-bar 
  wx:if="{{activeTab === 'dishes' && cartTotalCount > 0}}"
  totalCount="{{cartTotalCount}}"
  totalPrice="{{cartTotalPrice}}"
  bind:checkout="onCheckout"
  bind:toggle="onCheckout"
/>
