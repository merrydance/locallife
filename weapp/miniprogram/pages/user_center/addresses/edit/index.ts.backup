import { createAddress, updateAddress, getAddressDetail, deleteAddress } from '../../../../api/address'

Page({
    data: {
        addressId: '',
        name: '',
        gender: 1, // 1: Male, 0: Female
        mobile: '',
        address: '', // Location name
        complete_address: '', // Detailed part (building/room)
        latitude: 0,
        longitude: 0,
        tag: 'home',
        is_default: false,
        saving: false
    },

    onLoad(options: any) {
        if (options.id) {
            this.setData({ addressId: options.id })
            this.loadAddress(options.id)
            wx.setNavigationBarTitle({ title: '编辑地址' })
        } else {
            wx.setNavigationBarTitle({ title: '新增地址' })
        }
    },

    async loadAddress(id: string) {
        try {
            const detail = await getAddressDetail(id)
            this.setData({
                name: detail.name,
                gender: detail.gender,
                mobile: detail.mobile,
                address: detail.address,
                complete_address: detail.complete_address, // Note: This might need splitting logic if backend stores full string
                latitude: detail.latitude,
                longitude: detail.longitude,
                tag: detail.tag,
                is_default: detail.is_default
            })
        } catch (error) {
            console.error('Load address failed:', error)
            wx.showToast({ title: '加载失败', icon: 'error' })
        }
    },

    onNameChange(e: any) {
        this.setData({ name: e.detail.value })
    },

    onGenderChange(e: any) {
        this.setData({ gender: Number(e.detail.value) })
    },

    onMobileChange(e: any) {
        this.setData({ mobile: e.detail.value })
    },

    onDetailChange(e: any) {
        this.setData({ complete_address: e.detail.value })
    },

    onTagChange(e: any) {
        this.setData({ tag: e.detail.value })
    },

    onDefaultChange(e: any) {
        this.setData({ is_default: e.detail.value })
    },

    onChooseLocation() {
        wx.chooseLocation({
            success: (res) => {
                this.setData({
                    address: res.name || res.address,
                    latitude: res.latitude,
                    longitude: res.longitude
                })
            },
            fail: (err) => {
                console.error('Choose location failed:', err)
                // Maybe show setting modal if auth denied
            }
        })
    },

    async onSave() {
        if (!this.validate()) return

        this.setData({ saving: true })

        const data = {
            name: this.data.name,
            gender: this.data.gender,
            mobile: this.data.mobile,
            address: this.data.address,
            complete_address: this.data.complete_address,
            latitude: this.data.latitude,
            longitude: this.data.longitude,
            tag: this.data.tag,
            is_default: this.data.is_default
        }

        try {
            if (this.data.addressId) {
                await updateAddress(this.data.addressId, data)
            } else {
                await createAddress(data)
            }
            
            wx.showToast({ title: '保存成功', icon: 'success' })
            setTimeout(() => wx.navigateBack(), 1500)
        } catch (error) {
            console.error('Save address failed:', error)
            wx.showToast({ title: '保存失败', icon: 'error' })
        } finally {
            this.setData({ saving: false })
        }
    },

    async onDelete() {
        if (!this.data.addressId) return

        wx.showModal({
            title: '删除地址',
            content: '确认删除此地址?',
            success: async (res) => {
                if (res.confirm) {
                    try {
                        await deleteAddress(this.data.addressId)
                        wx.showToast({ title: '已删除', icon: 'success' })
                        setTimeout(() => wx.navigateBack(), 1500)
                    } catch (error) {
                        console.error('Delete address failed:', error)
                        wx.showToast({ title: '删除失败', icon: 'error' })
                    }
                }
            }
        })
    },

    validate() {
        const { name, mobile, address, complete_address } = this.data
        if (!name.trim()) {
            wx.showToast({ title: '请填写联系人', icon: 'none' })
            return false
        }
        if (!mobile.trim() || mobile.length < 11) {
            wx.showToast({ title: '请填写正确手机号', icon: 'none' })
            return false
        }
        if (!address) {
            wx.showToast({ title: '请选择收货地址', icon: 'none' })
            return false
        }
        if (!complete_address.trim()) {
            wx.showToast({ title: '请填写门牌号', icon: 'none' })
            return false
        }
        return true
    }
})

