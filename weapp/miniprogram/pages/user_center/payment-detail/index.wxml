<custom-navbar title="支付详情" showBack="{{true}}" bind:navheight="onNavHeight" />

<view class="page" style="padding-top: {{navBarHeight}}px;">
  <t-loading wx:if="{{loading}}" theme="circular" size="40rpx" class="loading" />

  <block wx:if="{{!loading && payment}}">
    <!-- 支付状态卡片 -->
    <view class="status-card {{statusClass}}">
      <view class="status-icon">
        <t-icon wx:if="{{payment.status === 'paid'}}" name="check-circle-filled" size="80rpx" color="#1d7a32" />
        <t-icon wx:elif="{{payment.status === 'pending'}}" name="time-filled" size="80rpx" color="#ff9500" />
        <t-icon wx:elif="{{payment.status === 'failed'}}" name="close-circle-filled" size="80rpx" color="#e34d59" />
        <t-icon wx:elif="{{payment.status === 'cancelled'}}" name="info-circle-filled" size="80rpx" color="#999" />
        <t-icon wx:elif="{{payment.status === 'refunded'}}" name="check-circle-filled" size="80rpx" color="#1d63ff" />
      </view>
      <view class="status-text">{{statusText}}</view>
      <view class="amount">{{amountDisplay}}</view>
    </view>

    <!-- 支付信息 -->
    <view class="info-card">
      <view class="card-title">支付信息</view>
      <view class="info-row">
        <text class="label">支付方式</text>
        <text class="value">{{paymentMethodText}}</text>
      </view>
      <view class="info-row">
        <text class="label">订单号</text>
        <text class="value">{{payment.order_id}}</text>
      </view>
      <view class="info-row" wx:if="{{payment.transaction_id}}">
        <text class="label">交易号</text>
        <text class="value">{{payment.transaction_id}}</text>
      </view>
      <view class="info-row">
        <text class="label">创建时间</text>
        <text class="value">{{payment.created_at}}</text>
      </view>
      <view class="info-row" wx:if="{{payment.paid_at}}">
        <text class="label">支付时间</text>
        <text class="value">{{payment.paid_at}}</text>
      </view>
      <view class="info-row" wx:if="{{payment.description}}">
        <text class="label">描述</text>
        <text class="value">{{payment.description}}</text>
      </view>
    </view>

    <!-- 退款信息 -->
    <view class="info-card" wx:if="{{showRefundList && refunds.length > 0}}">
      <view class="card-title">退款记录</view>
      <view 
        class="refund-item" 
        wx:for="{{refunds}}" 
        wx:key="id"
        data-id="{{item.id}}"
        bindtap="onViewRefund"
      >
        <view class="refund-main">
          <view class="refund-amount">{{item._amountDisplay}}</view>
          <view class="refund-status {{item._statusClass}}">{{item._statusText}}</view>
        </view>
        <view class="refund-info">
          <text class="refund-reason">{{item.reason}}</text>
          <text class="refund-time">{{item.created_at}}</text>
        </view>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-bar" wx:if="{{showCloseButton}}">
      <t-button theme="danger" variant="outline" block bindtap="onClosePayment">关闭支付</t-button>
    </view>
  </block>

  <view wx:if="{{!loading && !payment}}" class="empty">
    <t-empty description="未找到支付记录" />
  </view>
</view>
