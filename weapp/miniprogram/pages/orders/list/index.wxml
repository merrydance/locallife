<custom-navbar title="我的订单" showBack="{{true}}" bind:navheight="onNavHeight" />

<view class="page" style="padding-top: {{navBarHeight}}px;">
  <!-- 状态筛选Tab -->
  <t-tabs value="{{currentStatus}}" bind:change="onStatusChange">
    <t-tab-panel wx:for="{{statusTabs}}" wx:key="value" label="{{item.label}}" value="{{item.value}}" />
  </t-tabs>

  <!-- 骨架屏 -->
  <view wx:if="{{loading && orders.length === 0}}" class="skeleton-container">
    <view class="card skeleton" wx:for="{{[1,2,3]}}" wx:key="*this">
      <view class="skeleton-line" style="width: 60%; height: 32rpx; margin-bottom: 12rpx;"></view>
      <view class="skeleton-line" style="width: 40%; height: 24rpx; margin-bottom: 20rpx;"></view>
      <view class="skeleton-line" style="width: 100%; height: 80rpx;"></view>
    </view>
  </view>

  <!-- 空状态 -->
  <view wx:elif="{{orders.length === 0}}" class="empty">
    <t-empty description="暂无订单" />
  </view>

  <!-- 订单列表 -->
  <view wx:else class="order-list">
    <view class="card" wx:for="{{orders}}" wx:key="id">
      <view class="card-header">
        <view>
          <view class="merchant">{{item.merchantName}}</view>
          <view class="order-id">#{{item.orderNo}}</view>
        </view>
        <t-tag variant="light" theme="{{item.statusClass === 'completed' ? 'success' : (item.statusClass === 'cancelled' ? 'default' : 'primary')}}">{{item.statusLabel}}</t-tag>
      </view>

      <view class="highlight" wx:if="{{item.highlight}}">{{item.highlight}}</view>

      <view class="badge-row" wx:if="{{item.badges.length > 0}}">
        <t-tag wx:for="{{item.badges}}" wx:for-item="badge" wx:key="*this" size="small" variant="light">{{badge}}</t-tag>
      </view>

      <view class="preview-list" wx:if="{{item.previewItems.length > 0}}">
        <view class="preview-item" wx:for="{{item.previewItems}}" wx:for-item="preview" wx:key="dishId">
          <image class="item-thumb" src="{{preview.imageUrl}}" mode="aspectFill" />
          <view class="name">{{preview.dishName}}</view>
          <text class="count">×{{preview.quantity}}</text>
        </view>
      </view>

      <view class="meta-row">
        <view class="created">{{item.createTimeDisplay}}</view>
        <view class="total">{{item.totalDisplay}}</view>
      </view>

      <view class="btn-row">
        <t-button wx:if="{{item.canCancel}}" size="small" theme="danger" variant="text" data-id="{{item.id}}" bindtap="onCancelOrder">取消</t-button>
        <t-button wx:if="{{item.canPay}}" size="small" theme="primary" data-id="{{item.id}}" bindtap="onPayOrder">去支付</t-button>
        <t-button size="small" variant="outline" data-id="{{item.id}}" bindtap="onViewOrder">查看详情</t-button>
        <t-button wx:if="{{item.canReorder}}" size="small" theme="primary" variant="ghost" data-id="{{item.id}}" bindtap="onReorder">再次购买</t-button>
      </view>
    </view>

    <!-- 加载状态 -->
    <view class="loading-footer">
      <t-loading wx:if="{{loading}}" theme="circular" size="40rpx" text="加载中..." />
      <view wx:elif="{{!hasMore && orders.length > 0}}" class="no-more">没有更多了</view>
    </view>
  </view>
</view>
