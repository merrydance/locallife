// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: merchant_application.sql

package db

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const approveMerchantApplication = `-- name: ApproveMerchantApplication :one
UPDATE merchant_applications
SET
  status = 'approved',
  reviewed_at = now(),
  updated_at = now()
WHERE id = $1 AND status = 'submitted'
RETURNING id, user_id, merchant_name, business_license_number, business_license_image_url, legal_person_name, legal_person_id_number, legal_person_id_front_url, legal_person_id_back_url, contact_phone, business_address, business_scope, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, longitude, latitude, region_id, food_permit_url, food_permit_ocr, business_license_ocr, id_card_front_ocr, id_card_back_ocr, storefront_images, environment_images
`

// 审核通过商户申请
func (q *Queries) ApproveMerchantApplication(ctx context.Context, id int64) (MerchantApplication, error) {
	row := q.db.QueryRow(ctx, approveMerchantApplication, id)
	var i MerchantApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantName,
		&i.BusinessLicenseNumber,
		&i.BusinessLicenseImageUrl,
		&i.LegalPersonName,
		&i.LegalPersonIDNumber,
		&i.LegalPersonIDFrontUrl,
		&i.LegalPersonIDBackUrl,
		&i.ContactPhone,
		&i.BusinessAddress,
		&i.BusinessScope,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Longitude,
		&i.Latitude,
		&i.RegionID,
		&i.FoodPermitUrl,
		&i.FoodPermitOcr,
		&i.BusinessLicenseOcr,
		&i.IDCardFrontOcr,
		&i.IDCardBackOcr,
		&i.StorefrontImages,
		&i.EnvironmentImages,
	)
	return i, err
}

const checkMerchantAddressExists = `-- name: CheckMerchantAddressExists :one
SELECT EXISTS(
  SELECT 1 FROM merchants 
  WHERE address = $1 AND owner_user_id != $2 AND deleted_at IS NULL
) AS exists
`

type CheckMerchantAddressExistsParams struct {
	Address     string `json:"address"`
	OwnerUserID int64  `json:"owner_user_id"`
}

// 检查地址是否已被其他商户占用（排除指定用户自己的商户）
func (q *Queries) CheckMerchantAddressExists(ctx context.Context, arg CheckMerchantAddressExistsParams) (bool, error) {
	row := q.db.QueryRow(ctx, checkMerchantAddressExists, arg.Address, arg.OwnerUserID)
	var exists bool
	err := row.Scan(&exists)
	return exists, err
}

const countMerchantApplicationsByStatus = `-- name: CountMerchantApplicationsByStatus :one
SELECT COUNT(*) FROM merchant_applications
WHERE status = $1
`

// 统计各状态的申请数量
func (q *Queries) CountMerchantApplicationsByStatus(ctx context.Context, status string) (int64, error) {
	row := q.db.QueryRow(ctx, countMerchantApplicationsByStatus, status)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createMerchantApplicationDraft = `-- name: CreateMerchantApplicationDraft :one

INSERT INTO merchant_applications (
  user_id,
  merchant_name,
  business_license_number,
  business_license_image_url,
  legal_person_name,
  legal_person_id_number,
  legal_person_id_front_url,
  legal_person_id_back_url,
  contact_phone,
  business_address,
  status
) VALUES (
  $1, '', '', '', '', '', '', '', '', '', 'draft'
)
RETURNING id, user_id, merchant_name, business_license_number, business_license_image_url, legal_person_name, legal_person_id_number, legal_person_id_front_url, legal_person_id_back_url, contact_phone, business_address, business_scope, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, longitude, latitude, region_id, food_permit_url, food_permit_ocr, business_license_ocr, id_card_front_ocr, id_card_back_ocr, storefront_images, environment_images
`

// ==================== 商户入驻申请（草稿模式+自动审核） ====================
// 创建商户申请草稿（仅需用户ID）
func (q *Queries) CreateMerchantApplicationDraft(ctx context.Context, userID int64) (MerchantApplication, error) {
	row := q.db.QueryRow(ctx, createMerchantApplicationDraft, userID)
	var i MerchantApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantName,
		&i.BusinessLicenseNumber,
		&i.BusinessLicenseImageUrl,
		&i.LegalPersonName,
		&i.LegalPersonIDNumber,
		&i.LegalPersonIDFrontUrl,
		&i.LegalPersonIDBackUrl,
		&i.ContactPhone,
		&i.BusinessAddress,
		&i.BusinessScope,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Longitude,
		&i.Latitude,
		&i.RegionID,
		&i.FoodPermitUrl,
		&i.FoodPermitOcr,
		&i.BusinessLicenseOcr,
		&i.IDCardFrontOcr,
		&i.IDCardBackOcr,
		&i.StorefrontImages,
		&i.EnvironmentImages,
	)
	return i, err
}

const getMerchantApplicationDraft = `-- name: GetMerchantApplicationDraft :one
SELECT id, user_id, merchant_name, business_license_number, business_license_image_url, legal_person_name, legal_person_id_number, legal_person_id_front_url, legal_person_id_back_url, contact_phone, business_address, business_scope, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, longitude, latitude, region_id, food_permit_url, food_permit_ocr, business_license_ocr, id_card_front_ocr, id_card_back_ocr, storefront_images, environment_images FROM merchant_applications
WHERE user_id = $1 AND status IN ('draft', 'submitted', 'rejected', 'approved')
ORDER BY created_at DESC
LIMIT 1
`

// 获取用户的草稿或可编辑申请（包含所有状态，以便随时编辑）
func (q *Queries) GetMerchantApplicationDraft(ctx context.Context, userID int64) (MerchantApplication, error) {
	row := q.db.QueryRow(ctx, getMerchantApplicationDraft, userID)
	var i MerchantApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantName,
		&i.BusinessLicenseNumber,
		&i.BusinessLicenseImageUrl,
		&i.LegalPersonName,
		&i.LegalPersonIDNumber,
		&i.LegalPersonIDFrontUrl,
		&i.LegalPersonIDBackUrl,
		&i.ContactPhone,
		&i.BusinessAddress,
		&i.BusinessScope,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Longitude,
		&i.Latitude,
		&i.RegionID,
		&i.FoodPermitUrl,
		&i.FoodPermitOcr,
		&i.BusinessLicenseOcr,
		&i.IDCardFrontOcr,
		&i.IDCardBackOcr,
		&i.StorefrontImages,
		&i.EnvironmentImages,
	)
	return i, err
}

const rejectMerchantApplication = `-- name: RejectMerchantApplication :one
UPDATE merchant_applications
SET
  status = 'rejected',
  reject_reason = $2,
  reviewed_at = now(),
  updated_at = now()
WHERE id = $1 AND status = 'submitted'
RETURNING id, user_id, merchant_name, business_license_number, business_license_image_url, legal_person_name, legal_person_id_number, legal_person_id_front_url, legal_person_id_back_url, contact_phone, business_address, business_scope, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, longitude, latitude, region_id, food_permit_url, food_permit_ocr, business_license_ocr, id_card_front_ocr, id_card_back_ocr, storefront_images, environment_images
`

type RejectMerchantApplicationParams struct {
	ID           int64       `json:"id"`
	RejectReason pgtype.Text `json:"reject_reason"`
}

// 拒绝商户申请
func (q *Queries) RejectMerchantApplication(ctx context.Context, arg RejectMerchantApplicationParams) (MerchantApplication, error) {
	row := q.db.QueryRow(ctx, rejectMerchantApplication, arg.ID, arg.RejectReason)
	var i MerchantApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantName,
		&i.BusinessLicenseNumber,
		&i.BusinessLicenseImageUrl,
		&i.LegalPersonName,
		&i.LegalPersonIDNumber,
		&i.LegalPersonIDFrontUrl,
		&i.LegalPersonIDBackUrl,
		&i.ContactPhone,
		&i.BusinessAddress,
		&i.BusinessScope,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Longitude,
		&i.Latitude,
		&i.RegionID,
		&i.FoodPermitUrl,
		&i.FoodPermitOcr,
		&i.BusinessLicenseOcr,
		&i.IDCardFrontOcr,
		&i.IDCardBackOcr,
		&i.StorefrontImages,
		&i.EnvironmentImages,
	)
	return i, err
}

const resetMerchantApplicationToDraft = `-- name: ResetMerchantApplicationToDraft :one
UPDATE merchant_applications
SET
  status = 'draft',
  reject_reason = NULL,
  reviewed_at = NULL,
  reviewed_by = NULL,
  updated_at = now()
WHERE id = $1 AND status IN ('submitted', 'rejected', 'approved')
RETURNING id, user_id, merchant_name, business_license_number, business_license_image_url, legal_person_name, legal_person_id_number, legal_person_id_front_url, legal_person_id_back_url, contact_phone, business_address, business_scope, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, longitude, latitude, region_id, food_permit_url, food_permit_ocr, business_license_ocr, id_card_front_ocr, id_card_back_ocr, storefront_images, environment_images
`

// 重置申请为草稿状态（允许用户重新编辑，支持从待审核、被拒绝或已通过状态重置）
func (q *Queries) ResetMerchantApplicationToDraft(ctx context.Context, id int64) (MerchantApplication, error) {
	row := q.db.QueryRow(ctx, resetMerchantApplicationToDraft, id)
	var i MerchantApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantName,
		&i.BusinessLicenseNumber,
		&i.BusinessLicenseImageUrl,
		&i.LegalPersonName,
		&i.LegalPersonIDNumber,
		&i.LegalPersonIDFrontUrl,
		&i.LegalPersonIDBackUrl,
		&i.ContactPhone,
		&i.BusinessAddress,
		&i.BusinessScope,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Longitude,
		&i.Latitude,
		&i.RegionID,
		&i.FoodPermitUrl,
		&i.FoodPermitOcr,
		&i.BusinessLicenseOcr,
		&i.IDCardFrontOcr,
		&i.IDCardBackOcr,
		&i.StorefrontImages,
		&i.EnvironmentImages,
	)
	return i, err
}

const submitMerchantApplication = `-- name: SubmitMerchantApplication :one
UPDATE merchant_applications
SET
  status = 'submitted',
  reject_reason = NULL,
  reviewed_at = NULL,
  reviewed_by = NULL,
  updated_at = now()
WHERE id = $1 AND status IN ('draft', 'rejected', 'approved')
RETURNING id, user_id, merchant_name, business_license_number, business_license_image_url, legal_person_name, legal_person_id_number, legal_person_id_front_url, legal_person_id_back_url, contact_phone, business_address, business_scope, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, longitude, latitude, region_id, food_permit_url, food_permit_ocr, business_license_ocr, id_card_front_ocr, id_card_back_ocr, storefront_images, environment_images
`

// 提交商户申请（从草稿、被拒绝或已通过状态变为已提交）
func (q *Queries) SubmitMerchantApplication(ctx context.Context, id int64) (MerchantApplication, error) {
	row := q.db.QueryRow(ctx, submitMerchantApplication, id)
	var i MerchantApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantName,
		&i.BusinessLicenseNumber,
		&i.BusinessLicenseImageUrl,
		&i.LegalPersonName,
		&i.LegalPersonIDNumber,
		&i.LegalPersonIDFrontUrl,
		&i.LegalPersonIDBackUrl,
		&i.ContactPhone,
		&i.BusinessAddress,
		&i.BusinessScope,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Longitude,
		&i.Latitude,
		&i.RegionID,
		&i.FoodPermitUrl,
		&i.FoodPermitOcr,
		&i.BusinessLicenseOcr,
		&i.IDCardFrontOcr,
		&i.IDCardBackOcr,
		&i.StorefrontImages,
		&i.EnvironmentImages,
	)
	return i, err
}

const updateMerchantApplicationBasicInfo = `-- name: UpdateMerchantApplicationBasicInfo :one
UPDATE merchant_applications
SET
  merchant_name = COALESCE($2, merchant_name),
  contact_phone = COALESCE($3, contact_phone),
  business_address = COALESCE($4, business_address),
  longitude = COALESCE($5, longitude),
  latitude = COALESCE($6, latitude),
  region_id = COALESCE($7, region_id),
  updated_at = now()
WHERE id = $1 AND status = 'draft'
RETURNING id, user_id, merchant_name, business_license_number, business_license_image_url, legal_person_name, legal_person_id_number, legal_person_id_front_url, legal_person_id_back_url, contact_phone, business_address, business_scope, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, longitude, latitude, region_id, food_permit_url, food_permit_ocr, business_license_ocr, id_card_front_ocr, id_card_back_ocr, storefront_images, environment_images
`

type UpdateMerchantApplicationBasicInfoParams struct {
	ID              int64          `json:"id"`
	MerchantName    pgtype.Text    `json:"merchant_name"`
	ContactPhone    pgtype.Text    `json:"contact_phone"`
	BusinessAddress pgtype.Text    `json:"business_address"`
	Longitude       pgtype.Numeric `json:"longitude"`
	Latitude        pgtype.Numeric `json:"latitude"`
	RegionID        pgtype.Int8    `json:"region_id"`
}

// 更新基础信息（商户名、联系电话、地址、经纬度、区域）
func (q *Queries) UpdateMerchantApplicationBasicInfo(ctx context.Context, arg UpdateMerchantApplicationBasicInfoParams) (MerchantApplication, error) {
	row := q.db.QueryRow(ctx, updateMerchantApplicationBasicInfo,
		arg.ID,
		arg.MerchantName,
		arg.ContactPhone,
		arg.BusinessAddress,
		arg.Longitude,
		arg.Latitude,
		arg.RegionID,
	)
	var i MerchantApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantName,
		&i.BusinessLicenseNumber,
		&i.BusinessLicenseImageUrl,
		&i.LegalPersonName,
		&i.LegalPersonIDNumber,
		&i.LegalPersonIDFrontUrl,
		&i.LegalPersonIDBackUrl,
		&i.ContactPhone,
		&i.BusinessAddress,
		&i.BusinessScope,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Longitude,
		&i.Latitude,
		&i.RegionID,
		&i.FoodPermitUrl,
		&i.FoodPermitOcr,
		&i.BusinessLicenseOcr,
		&i.IDCardFrontOcr,
		&i.IDCardBackOcr,
		&i.StorefrontImages,
		&i.EnvironmentImages,
	)
	return i, err
}

const updateMerchantApplicationBusinessLicense = `-- name: UpdateMerchantApplicationBusinessLicense :one
UPDATE merchant_applications
SET
  business_license_image_url = COALESCE($2, business_license_image_url),
  business_license_number = COALESCE($3, business_license_number),
  business_scope = COALESCE($4, business_scope),
  business_license_ocr = COALESCE($5, business_license_ocr),
  updated_at = now()
WHERE id = $1 AND status = 'draft'
RETURNING id, user_id, merchant_name, business_license_number, business_license_image_url, legal_person_name, legal_person_id_number, legal_person_id_front_url, legal_person_id_back_url, contact_phone, business_address, business_scope, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, longitude, latitude, region_id, food_permit_url, food_permit_ocr, business_license_ocr, id_card_front_ocr, id_card_back_ocr, storefront_images, environment_images
`

type UpdateMerchantApplicationBusinessLicenseParams struct {
	ID                      int64       `json:"id"`
	BusinessLicenseImageUrl pgtype.Text `json:"business_license_image_url"`
	BusinessLicenseNumber   pgtype.Text `json:"business_license_number"`
	BusinessScope           pgtype.Text `json:"business_scope"`
	BusinessLicenseOcr      []byte      `json:"business_license_ocr"`
}

// 更新营业执照信息（图片URL和OCR结果）
func (q *Queries) UpdateMerchantApplicationBusinessLicense(ctx context.Context, arg UpdateMerchantApplicationBusinessLicenseParams) (MerchantApplication, error) {
	row := q.db.QueryRow(ctx, updateMerchantApplicationBusinessLicense,
		arg.ID,
		arg.BusinessLicenseImageUrl,
		arg.BusinessLicenseNumber,
		arg.BusinessScope,
		arg.BusinessLicenseOcr,
	)
	var i MerchantApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantName,
		&i.BusinessLicenseNumber,
		&i.BusinessLicenseImageUrl,
		&i.LegalPersonName,
		&i.LegalPersonIDNumber,
		&i.LegalPersonIDFrontUrl,
		&i.LegalPersonIDBackUrl,
		&i.ContactPhone,
		&i.BusinessAddress,
		&i.BusinessScope,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Longitude,
		&i.Latitude,
		&i.RegionID,
		&i.FoodPermitUrl,
		&i.FoodPermitOcr,
		&i.BusinessLicenseOcr,
		&i.IDCardFrontOcr,
		&i.IDCardBackOcr,
		&i.StorefrontImages,
		&i.EnvironmentImages,
	)
	return i, err
}

const updateMerchantApplicationFoodPermit = `-- name: UpdateMerchantApplicationFoodPermit :one
UPDATE merchant_applications
SET
  food_permit_url = COALESCE($2, food_permit_url),
  food_permit_ocr = COALESCE($3, food_permit_ocr),
  updated_at = now()
WHERE id = $1 AND status = 'draft'
RETURNING id, user_id, merchant_name, business_license_number, business_license_image_url, legal_person_name, legal_person_id_number, legal_person_id_front_url, legal_person_id_back_url, contact_phone, business_address, business_scope, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, longitude, latitude, region_id, food_permit_url, food_permit_ocr, business_license_ocr, id_card_front_ocr, id_card_back_ocr, storefront_images, environment_images
`

type UpdateMerchantApplicationFoodPermitParams struct {
	ID            int64       `json:"id"`
	FoodPermitUrl pgtype.Text `json:"food_permit_url"`
	FoodPermitOcr []byte      `json:"food_permit_ocr"`
}

// 更新食品经营许可证信息（图片URL和OCR结果）
func (q *Queries) UpdateMerchantApplicationFoodPermit(ctx context.Context, arg UpdateMerchantApplicationFoodPermitParams) (MerchantApplication, error) {
	row := q.db.QueryRow(ctx, updateMerchantApplicationFoodPermit, arg.ID, arg.FoodPermitUrl, arg.FoodPermitOcr)
	var i MerchantApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantName,
		&i.BusinessLicenseNumber,
		&i.BusinessLicenseImageUrl,
		&i.LegalPersonName,
		&i.LegalPersonIDNumber,
		&i.LegalPersonIDFrontUrl,
		&i.LegalPersonIDBackUrl,
		&i.ContactPhone,
		&i.BusinessAddress,
		&i.BusinessScope,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Longitude,
		&i.Latitude,
		&i.RegionID,
		&i.FoodPermitUrl,
		&i.FoodPermitOcr,
		&i.BusinessLicenseOcr,
		&i.IDCardFrontOcr,
		&i.IDCardBackOcr,
		&i.StorefrontImages,
		&i.EnvironmentImages,
	)
	return i, err
}

const updateMerchantApplicationIDCardBack = `-- name: UpdateMerchantApplicationIDCardBack :one
UPDATE merchant_applications
SET
  legal_person_id_back_url = COALESCE($2, legal_person_id_back_url),
  id_card_back_ocr = COALESCE($3, id_card_back_ocr),
  updated_at = now()
WHERE id = $1 AND status = 'draft'
RETURNING id, user_id, merchant_name, business_license_number, business_license_image_url, legal_person_name, legal_person_id_number, legal_person_id_front_url, legal_person_id_back_url, contact_phone, business_address, business_scope, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, longitude, latitude, region_id, food_permit_url, food_permit_ocr, business_license_ocr, id_card_front_ocr, id_card_back_ocr, storefront_images, environment_images
`

type UpdateMerchantApplicationIDCardBackParams struct {
	ID                   int64       `json:"id"`
	LegalPersonIDBackUrl pgtype.Text `json:"legal_person_id_back_url"`
	IDCardBackOcr        []byte      `json:"id_card_back_ocr"`
}

// 更新身份证背面信息（图片URL和OCR结果）
func (q *Queries) UpdateMerchantApplicationIDCardBack(ctx context.Context, arg UpdateMerchantApplicationIDCardBackParams) (MerchantApplication, error) {
	row := q.db.QueryRow(ctx, updateMerchantApplicationIDCardBack, arg.ID, arg.LegalPersonIDBackUrl, arg.IDCardBackOcr)
	var i MerchantApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantName,
		&i.BusinessLicenseNumber,
		&i.BusinessLicenseImageUrl,
		&i.LegalPersonName,
		&i.LegalPersonIDNumber,
		&i.LegalPersonIDFrontUrl,
		&i.LegalPersonIDBackUrl,
		&i.ContactPhone,
		&i.BusinessAddress,
		&i.BusinessScope,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Longitude,
		&i.Latitude,
		&i.RegionID,
		&i.FoodPermitUrl,
		&i.FoodPermitOcr,
		&i.BusinessLicenseOcr,
		&i.IDCardFrontOcr,
		&i.IDCardBackOcr,
		&i.StorefrontImages,
		&i.EnvironmentImages,
	)
	return i, err
}

const updateMerchantApplicationIDCardFront = `-- name: UpdateMerchantApplicationIDCardFront :one
UPDATE merchant_applications
SET
  legal_person_id_front_url = COALESCE($2, legal_person_id_front_url),
  legal_person_name = COALESCE($3, legal_person_name),
  legal_person_id_number = COALESCE($4, legal_person_id_number),
  id_card_front_ocr = COALESCE($5, id_card_front_ocr),
  updated_at = now()
WHERE id = $1 AND status = 'draft'
RETURNING id, user_id, merchant_name, business_license_number, business_license_image_url, legal_person_name, legal_person_id_number, legal_person_id_front_url, legal_person_id_back_url, contact_phone, business_address, business_scope, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, longitude, latitude, region_id, food_permit_url, food_permit_ocr, business_license_ocr, id_card_front_ocr, id_card_back_ocr, storefront_images, environment_images
`

type UpdateMerchantApplicationIDCardFrontParams struct {
	ID                    int64       `json:"id"`
	LegalPersonIDFrontUrl pgtype.Text `json:"legal_person_id_front_url"`
	LegalPersonName       pgtype.Text `json:"legal_person_name"`
	LegalPersonIDNumber   pgtype.Text `json:"legal_person_id_number"`
	IDCardFrontOcr        []byte      `json:"id_card_front_ocr"`
}

// 更新身份证正面信息（图片URL和OCR结果）
func (q *Queries) UpdateMerchantApplicationIDCardFront(ctx context.Context, arg UpdateMerchantApplicationIDCardFrontParams) (MerchantApplication, error) {
	row := q.db.QueryRow(ctx, updateMerchantApplicationIDCardFront,
		arg.ID,
		arg.LegalPersonIDFrontUrl,
		arg.LegalPersonName,
		arg.LegalPersonIDNumber,
		arg.IDCardFrontOcr,
	)
	var i MerchantApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantName,
		&i.BusinessLicenseNumber,
		&i.BusinessLicenseImageUrl,
		&i.LegalPersonName,
		&i.LegalPersonIDNumber,
		&i.LegalPersonIDFrontUrl,
		&i.LegalPersonIDBackUrl,
		&i.ContactPhone,
		&i.BusinessAddress,
		&i.BusinessScope,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Longitude,
		&i.Latitude,
		&i.RegionID,
		&i.FoodPermitUrl,
		&i.FoodPermitOcr,
		&i.BusinessLicenseOcr,
		&i.IDCardFrontOcr,
		&i.IDCardBackOcr,
		&i.StorefrontImages,
		&i.EnvironmentImages,
	)
	return i, err
}

const updateMerchantApplicationImages = `-- name: UpdateMerchantApplicationImages :one
UPDATE merchant_applications
SET
  storefront_images = COALESCE($2, storefront_images),
  environment_images = COALESCE($3, environment_images),
  updated_at = now()
WHERE id = $1 AND status = 'draft'
RETURNING id, user_id, merchant_name, business_license_number, business_license_image_url, legal_person_name, legal_person_id_number, legal_person_id_front_url, legal_person_id_back_url, contact_phone, business_address, business_scope, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, longitude, latitude, region_id, food_permit_url, food_permit_ocr, business_license_ocr, id_card_front_ocr, id_card_back_ocr, storefront_images, environment_images
`

type UpdateMerchantApplicationImagesParams struct {
	ID                int64  `json:"id"`
	StorefrontImages  []byte `json:"storefront_images"`
	EnvironmentImages []byte `json:"environment_images"`
}

// 更新门头照和环境照（jsonb数组）
func (q *Queries) UpdateMerchantApplicationImages(ctx context.Context, arg UpdateMerchantApplicationImagesParams) (MerchantApplication, error) {
	row := q.db.QueryRow(ctx, updateMerchantApplicationImages, arg.ID, arg.StorefrontImages, arg.EnvironmentImages)
	var i MerchantApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantName,
		&i.BusinessLicenseNumber,
		&i.BusinessLicenseImageUrl,
		&i.LegalPersonName,
		&i.LegalPersonIDNumber,
		&i.LegalPersonIDFrontUrl,
		&i.LegalPersonIDBackUrl,
		&i.ContactPhone,
		&i.BusinessAddress,
		&i.BusinessScope,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.Longitude,
		&i.Latitude,
		&i.RegionID,
		&i.FoodPermitUrl,
		&i.FoodPermitOcr,
		&i.BusinessLicenseOcr,
		&i.IDCardFrontOcr,
		&i.IDCardBackOcr,
		&i.StorefrontImages,
		&i.EnvironmentImages,
	)
	return i, err
}
