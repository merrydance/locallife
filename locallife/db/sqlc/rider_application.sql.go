// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: rider_application.sql

package db

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const approveRiderApplication = `-- name: ApproveRiderApplication :one
UPDATE rider_applications
SET 
    status = 'approved',
    reviewed_by = $2,
    reviewed_at = now(),
    updated_at = now()
WHERE id = $1 AND status = 'submitted'
RETURNING id, user_id, real_name, phone, id_card_front_url, id_card_back_url, id_card_ocr, health_cert_url, health_cert_ocr, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, submitted_at
`

type ApproveRiderApplicationParams struct {
	ID         int64       `json:"id"`
	ReviewedBy pgtype.Int8 `json:"reviewed_by"`
}

// 审核通过骑手申请
func (q *Queries) ApproveRiderApplication(ctx context.Context, arg ApproveRiderApplicationParams) (RiderApplication, error) {
	row := q.db.QueryRow(ctx, approveRiderApplication, arg.ID, arg.ReviewedBy)
	var i RiderApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.RealName,
		&i.Phone,
		&i.IDCardFrontUrl,
		&i.IDCardBackUrl,
		&i.IDCardOcr,
		&i.HealthCertUrl,
		&i.HealthCertOcr,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.SubmittedAt,
	)
	return i, err
}

const countRiderApplicationsByStatus = `-- name: CountRiderApplicationsByStatus :one
SELECT COUNT(*) FROM rider_applications
WHERE status = $1
`

// 统计各状态的申请数量
func (q *Queries) CountRiderApplicationsByStatus(ctx context.Context, status string) (int64, error) {
	row := q.db.QueryRow(ctx, countRiderApplicationsByStatus, status)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createRiderApplication = `-- name: CreateRiderApplication :one
INSERT INTO rider_applications (
    user_id,
    status
) VALUES (
    $1,
    'draft'
) RETURNING id, user_id, real_name, phone, id_card_front_url, id_card_back_url, id_card_ocr, health_cert_url, health_cert_ocr, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, submitted_at
`

// 创建骑手申请草稿
func (q *Queries) CreateRiderApplication(ctx context.Context, userID int64) (RiderApplication, error) {
	row := q.db.QueryRow(ctx, createRiderApplication, userID)
	var i RiderApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.RealName,
		&i.Phone,
		&i.IDCardFrontUrl,
		&i.IDCardBackUrl,
		&i.IDCardOcr,
		&i.HealthCertUrl,
		&i.HealthCertOcr,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.SubmittedAt,
	)
	return i, err
}

const getRiderApplication = `-- name: GetRiderApplication :one
SELECT id, user_id, real_name, phone, id_card_front_url, id_card_back_url, id_card_ocr, health_cert_url, health_cert_ocr, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, submitted_at FROM rider_applications
WHERE id = $1
`

// 获取骑手申请
func (q *Queries) GetRiderApplication(ctx context.Context, id int64) (RiderApplication, error) {
	row := q.db.QueryRow(ctx, getRiderApplication, id)
	var i RiderApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.RealName,
		&i.Phone,
		&i.IDCardFrontUrl,
		&i.IDCardBackUrl,
		&i.IDCardOcr,
		&i.HealthCertUrl,
		&i.HealthCertOcr,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.SubmittedAt,
	)
	return i, err
}

const getRiderApplicationByUserID = `-- name: GetRiderApplicationByUserID :one
SELECT id, user_id, real_name, phone, id_card_front_url, id_card_back_url, id_card_ocr, health_cert_url, health_cert_ocr, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, submitted_at FROM rider_applications
WHERE user_id = $1
`

// 根据用户ID获取骑手申请
func (q *Queries) GetRiderApplicationByUserID(ctx context.Context, userID int64) (RiderApplication, error) {
	row := q.db.QueryRow(ctx, getRiderApplicationByUserID, userID)
	var i RiderApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.RealName,
		&i.Phone,
		&i.IDCardFrontUrl,
		&i.IDCardBackUrl,
		&i.IDCardOcr,
		&i.HealthCertUrl,
		&i.HealthCertOcr,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.SubmittedAt,
	)
	return i, err
}

const listRiderApplications = `-- name: ListRiderApplications :many
SELECT id, user_id, real_name, phone, id_card_front_url, id_card_back_url, id_card_ocr, health_cert_url, health_cert_ocr, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, submitted_at FROM rider_applications
WHERE 
    ($3::text IS NULL OR status = $3)
ORDER BY 
    CASE WHEN status = 'submitted' THEN 0 ELSE 1 END,
    submitted_at DESC NULLS LAST,
    created_at DESC
LIMIT $1 OFFSET $2
`

type ListRiderApplicationsParams struct {
	Limit  int32       `json:"limit"`
	Offset int32       `json:"offset"`
	Status pgtype.Text `json:"status"`
}

// 列出骑手申请（管理员用）
func (q *Queries) ListRiderApplications(ctx context.Context, arg ListRiderApplicationsParams) ([]RiderApplication, error) {
	rows, err := q.db.Query(ctx, listRiderApplications, arg.Limit, arg.Offset, arg.Status)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []RiderApplication{}
	for rows.Next() {
		var i RiderApplication
		if err := rows.Scan(
			&i.ID,
			&i.UserID,
			&i.RealName,
			&i.Phone,
			&i.IDCardFrontUrl,
			&i.IDCardBackUrl,
			&i.IDCardOcr,
			&i.HealthCertUrl,
			&i.HealthCertOcr,
			&i.Status,
			&i.RejectReason,
			&i.ReviewedBy,
			&i.ReviewedAt,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.SubmittedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const rejectRiderApplication = `-- name: RejectRiderApplication :one
UPDATE rider_applications
SET 
    status = 'rejected',
    reject_reason = $2,
    reviewed_by = $3,
    reviewed_at = now(),
    updated_at = now()
WHERE id = $1 AND status = 'submitted'
RETURNING id, user_id, real_name, phone, id_card_front_url, id_card_back_url, id_card_ocr, health_cert_url, health_cert_ocr, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, submitted_at
`

type RejectRiderApplicationParams struct {
	ID           int64       `json:"id"`
	RejectReason pgtype.Text `json:"reject_reason"`
	ReviewedBy   pgtype.Int8 `json:"reviewed_by"`
}

// 拒绝骑手申请
func (q *Queries) RejectRiderApplication(ctx context.Context, arg RejectRiderApplicationParams) (RiderApplication, error) {
	row := q.db.QueryRow(ctx, rejectRiderApplication, arg.ID, arg.RejectReason, arg.ReviewedBy)
	var i RiderApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.RealName,
		&i.Phone,
		&i.IDCardFrontUrl,
		&i.IDCardBackUrl,
		&i.IDCardOcr,
		&i.HealthCertUrl,
		&i.HealthCertOcr,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.SubmittedAt,
	)
	return i, err
}

const resetRiderApplicationToDraft = `-- name: ResetRiderApplicationToDraft :one
UPDATE rider_applications
SET 
    status = 'draft',
    reject_reason = NULL,
    reviewed_by = NULL,
    reviewed_at = NULL,
    submitted_at = NULL,
    updated_at = now()
WHERE id = $1 AND status = 'rejected'
RETURNING id, user_id, real_name, phone, id_card_front_url, id_card_back_url, id_card_ocr, health_cert_url, health_cert_ocr, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, submitted_at
`

// 重置申请为草稿状态（被拒绝后可重新编辑）
func (q *Queries) ResetRiderApplicationToDraft(ctx context.Context, id int64) (RiderApplication, error) {
	row := q.db.QueryRow(ctx, resetRiderApplicationToDraft, id)
	var i RiderApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.RealName,
		&i.Phone,
		&i.IDCardFrontUrl,
		&i.IDCardBackUrl,
		&i.IDCardOcr,
		&i.HealthCertUrl,
		&i.HealthCertOcr,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.SubmittedAt,
	)
	return i, err
}

const submitRiderApplication = `-- name: SubmitRiderApplication :one
UPDATE rider_applications
SET 
    status = 'submitted',
    submitted_at = now(),
    updated_at = now()
WHERE id = $1 AND status = 'draft'
RETURNING id, user_id, real_name, phone, id_card_front_url, id_card_back_url, id_card_ocr, health_cert_url, health_cert_ocr, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, submitted_at
`

// 提交骑手申请
func (q *Queries) SubmitRiderApplication(ctx context.Context, id int64) (RiderApplication, error) {
	row := q.db.QueryRow(ctx, submitRiderApplication, id)
	var i RiderApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.RealName,
		&i.Phone,
		&i.IDCardFrontUrl,
		&i.IDCardBackUrl,
		&i.IDCardOcr,
		&i.HealthCertUrl,
		&i.HealthCertOcr,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.SubmittedAt,
	)
	return i, err
}

const updateRiderApplicationBasicInfo = `-- name: UpdateRiderApplicationBasicInfo :one
UPDATE rider_applications
SET 
    real_name = COALESCE($2, real_name),
    phone = COALESCE($3, phone),
    updated_at = now()
WHERE id = $1 AND status = 'draft'
RETURNING id, user_id, real_name, phone, id_card_front_url, id_card_back_url, id_card_ocr, health_cert_url, health_cert_ocr, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, submitted_at
`

type UpdateRiderApplicationBasicInfoParams struct {
	ID       int64       `json:"id"`
	RealName pgtype.Text `json:"real_name"`
	Phone    pgtype.Text `json:"phone"`
}

// 更新基础信息（姓名、手机号）
func (q *Queries) UpdateRiderApplicationBasicInfo(ctx context.Context, arg UpdateRiderApplicationBasicInfoParams) (RiderApplication, error) {
	row := q.db.QueryRow(ctx, updateRiderApplicationBasicInfo, arg.ID, arg.RealName, arg.Phone)
	var i RiderApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.RealName,
		&i.Phone,
		&i.IDCardFrontUrl,
		&i.IDCardBackUrl,
		&i.IDCardOcr,
		&i.HealthCertUrl,
		&i.HealthCertOcr,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.SubmittedAt,
	)
	return i, err
}

const updateRiderApplicationHealthCert = `-- name: UpdateRiderApplicationHealthCert :one
UPDATE rider_applications
SET 
    health_cert_url = COALESCE($2, health_cert_url),
    health_cert_ocr = COALESCE($3, health_cert_ocr),
    updated_at = now()
WHERE id = $1 AND status = 'draft'
RETURNING id, user_id, real_name, phone, id_card_front_url, id_card_back_url, id_card_ocr, health_cert_url, health_cert_ocr, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, submitted_at
`

type UpdateRiderApplicationHealthCertParams struct {
	ID            int64       `json:"id"`
	HealthCertUrl pgtype.Text `json:"health_cert_url"`
	HealthCertOcr []byte      `json:"health_cert_ocr"`
}

// 更新健康证信息
func (q *Queries) UpdateRiderApplicationHealthCert(ctx context.Context, arg UpdateRiderApplicationHealthCertParams) (RiderApplication, error) {
	row := q.db.QueryRow(ctx, updateRiderApplicationHealthCert, arg.ID, arg.HealthCertUrl, arg.HealthCertOcr)
	var i RiderApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.RealName,
		&i.Phone,
		&i.IDCardFrontUrl,
		&i.IDCardBackUrl,
		&i.IDCardOcr,
		&i.HealthCertUrl,
		&i.HealthCertOcr,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.SubmittedAt,
	)
	return i, err
}

const updateRiderApplicationIDCard = `-- name: UpdateRiderApplicationIDCard :one
UPDATE rider_applications
SET 
    id_card_front_url = COALESCE($2, id_card_front_url),
    id_card_back_url = COALESCE($3, id_card_back_url),
    id_card_ocr = COALESCE($4, id_card_ocr),
    -- OCR识别出姓名时自动更新real_name
    real_name = COALESCE($5, real_name),
    updated_at = now()
WHERE id = $1 AND status = 'draft'
RETURNING id, user_id, real_name, phone, id_card_front_url, id_card_back_url, id_card_ocr, health_cert_url, health_cert_ocr, status, reject_reason, reviewed_by, reviewed_at, created_at, updated_at, submitted_at
`

type UpdateRiderApplicationIDCardParams struct {
	ID             int64       `json:"id"`
	IDCardFrontUrl pgtype.Text `json:"id_card_front_url"`
	IDCardBackUrl  pgtype.Text `json:"id_card_back_url"`
	IDCardOcr      []byte      `json:"id_card_ocr"`
	RealName       pgtype.Text `json:"real_name"`
}

// 更新身份证信息
func (q *Queries) UpdateRiderApplicationIDCard(ctx context.Context, arg UpdateRiderApplicationIDCardParams) (RiderApplication, error) {
	row := q.db.QueryRow(ctx, updateRiderApplicationIDCard,
		arg.ID,
		arg.IDCardFrontUrl,
		arg.IDCardBackUrl,
		arg.IDCardOcr,
		arg.RealName,
	)
	var i RiderApplication
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.RealName,
		&i.Phone,
		&i.IDCardFrontUrl,
		&i.IDCardBackUrl,
		&i.IDCardOcr,
		&i.HealthCertUrl,
		&i.HealthCertOcr,
		&i.Status,
		&i.RejectReason,
		&i.ReviewedBy,
		&i.ReviewedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.SubmittedAt,
	)
	return i, err
}
