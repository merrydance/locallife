// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: delivery_promotion.sql

package db

import (
	"context"
	"time"

	"github.com/jackc/pgx/v5/pgtype"
)

const createDeliveryPromotion = `-- name: CreateDeliveryPromotion :one
INSERT INTO merchant_delivery_promotions (
  merchant_id,
  name,
  min_order_amount,
  discount_amount,
  valid_from,
  valid_until,
  is_active
) VALUES (
  $1, $2, $3, $4, $5, $6, $7
) RETURNING id, merchant_id, name, min_order_amount, discount_amount, valid_from, valid_until, is_active, created_at, updated_at
`

type CreateDeliveryPromotionParams struct {
	MerchantID     int64     `json:"merchant_id"`
	Name           string    `json:"name"`
	MinOrderAmount int64     `json:"min_order_amount"`
	DiscountAmount int64     `json:"discount_amount"`
	ValidFrom      time.Time `json:"valid_from"`
	ValidUntil     time.Time `json:"valid_until"`
	IsActive       bool      `json:"is_active"`
}

func (q *Queries) CreateDeliveryPromotion(ctx context.Context, arg CreateDeliveryPromotionParams) (MerchantDeliveryPromotion, error) {
	row := q.db.QueryRow(ctx, createDeliveryPromotion,
		arg.MerchantID,
		arg.Name,
		arg.MinOrderAmount,
		arg.DiscountAmount,
		arg.ValidFrom,
		arg.ValidUntil,
		arg.IsActive,
	)
	var i MerchantDeliveryPromotion
	err := row.Scan(
		&i.ID,
		&i.MerchantID,
		&i.Name,
		&i.MinOrderAmount,
		&i.DiscountAmount,
		&i.ValidFrom,
		&i.ValidUntil,
		&i.IsActive,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const deleteDeliveryPromotion = `-- name: DeleteDeliveryPromotion :exec
DELETE FROM merchant_delivery_promotions
WHERE id = $1
`

func (q *Queries) DeleteDeliveryPromotion(ctx context.Context, id int64) error {
	_, err := q.db.Exec(ctx, deleteDeliveryPromotion, id)
	return err
}

const deleteDeliveryPromotionsByMerchant = `-- name: DeleteDeliveryPromotionsByMerchant :exec
DELETE FROM merchant_delivery_promotions
WHERE merchant_id = $1
`

func (q *Queries) DeleteDeliveryPromotionsByMerchant(ctx context.Context, merchantID int64) error {
	_, err := q.db.Exec(ctx, deleteDeliveryPromotionsByMerchant, merchantID)
	return err
}

const getBestDeliveryPromotion = `-- name: GetBestDeliveryPromotion :one
SELECT id, merchant_id, name, min_order_amount, discount_amount, valid_from, valid_until, is_active, created_at, updated_at FROM merchant_delivery_promotions
WHERE merchant_id = $1
  AND is_active = true
  AND valid_from <= now()
  AND valid_until >= now()
  AND min_order_amount <= $2
ORDER BY discount_amount DESC
LIMIT 1
`

type GetBestDeliveryPromotionParams struct {
	MerchantID     int64 `json:"merchant_id"`
	MinOrderAmount int64 `json:"min_order_amount"`
}

// 获取满足订单金额条件的最优促销（减免金额最大的那条）
func (q *Queries) GetBestDeliveryPromotion(ctx context.Context, arg GetBestDeliveryPromotionParams) (MerchantDeliveryPromotion, error) {
	row := q.db.QueryRow(ctx, getBestDeliveryPromotion, arg.MerchantID, arg.MinOrderAmount)
	var i MerchantDeliveryPromotion
	err := row.Scan(
		&i.ID,
		&i.MerchantID,
		&i.Name,
		&i.MinOrderAmount,
		&i.DiscountAmount,
		&i.ValidFrom,
		&i.ValidUntil,
		&i.IsActive,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getDeliveryPromotion = `-- name: GetDeliveryPromotion :one
SELECT id, merchant_id, name, min_order_amount, discount_amount, valid_from, valid_until, is_active, created_at, updated_at FROM merchant_delivery_promotions
WHERE id = $1 LIMIT 1
`

func (q *Queries) GetDeliveryPromotion(ctx context.Context, id int64) (MerchantDeliveryPromotion, error) {
	row := q.db.QueryRow(ctx, getDeliveryPromotion, id)
	var i MerchantDeliveryPromotion
	err := row.Scan(
		&i.ID,
		&i.MerchantID,
		&i.Name,
		&i.MinOrderAmount,
		&i.DiscountAmount,
		&i.ValidFrom,
		&i.ValidUntil,
		&i.IsActive,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const listActiveDeliveryPromotionsByMerchant = `-- name: ListActiveDeliveryPromotionsByMerchant :many
SELECT id, merchant_id, name, min_order_amount, discount_amount, valid_from, valid_until, is_active, created_at, updated_at FROM merchant_delivery_promotions
WHERE merchant_id = $1 
  AND is_active = true
  AND valid_from <= now()
  AND valid_until >= now()
ORDER BY min_order_amount
`

func (q *Queries) ListActiveDeliveryPromotionsByMerchant(ctx context.Context, merchantID int64) ([]MerchantDeliveryPromotion, error) {
	rows, err := q.db.Query(ctx, listActiveDeliveryPromotionsByMerchant, merchantID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []MerchantDeliveryPromotion{}
	for rows.Next() {
		var i MerchantDeliveryPromotion
		if err := rows.Scan(
			&i.ID,
			&i.MerchantID,
			&i.Name,
			&i.MinOrderAmount,
			&i.DiscountAmount,
			&i.ValidFrom,
			&i.ValidUntil,
			&i.IsActive,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listDeliveryPromotionsByMerchant = `-- name: ListDeliveryPromotionsByMerchant :many
SELECT id, merchant_id, name, min_order_amount, discount_amount, valid_from, valid_until, is_active, created_at, updated_at FROM merchant_delivery_promotions
WHERE merchant_id = $1
ORDER BY min_order_amount
`

func (q *Queries) ListDeliveryPromotionsByMerchant(ctx context.Context, merchantID int64) ([]MerchantDeliveryPromotion, error) {
	rows, err := q.db.Query(ctx, listDeliveryPromotionsByMerchant, merchantID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []MerchantDeliveryPromotion{}
	for rows.Next() {
		var i MerchantDeliveryPromotion
		if err := rows.Scan(
			&i.ID,
			&i.MerchantID,
			&i.Name,
			&i.MinOrderAmount,
			&i.DiscountAmount,
			&i.ValidFrom,
			&i.ValidUntil,
			&i.IsActive,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateDeliveryPromotion = `-- name: UpdateDeliveryPromotion :one
UPDATE merchant_delivery_promotions
SET
  name = COALESCE($2, name),
  min_order_amount = COALESCE($3, min_order_amount),
  discount_amount = COALESCE($4, discount_amount),
  valid_from = COALESCE($5, valid_from),
  valid_until = COALESCE($6, valid_until),
  is_active = COALESCE($7, is_active),
  updated_at = now()
WHERE id = $1
RETURNING id, merchant_id, name, min_order_amount, discount_amount, valid_from, valid_until, is_active, created_at, updated_at
`

type UpdateDeliveryPromotionParams struct {
	ID             int64              `json:"id"`
	Name           pgtype.Text        `json:"name"`
	MinOrderAmount pgtype.Int8        `json:"min_order_amount"`
	DiscountAmount pgtype.Int8        `json:"discount_amount"`
	ValidFrom      pgtype.Timestamptz `json:"valid_from"`
	ValidUntil     pgtype.Timestamptz `json:"valid_until"`
	IsActive       pgtype.Bool        `json:"is_active"`
}

func (q *Queries) UpdateDeliveryPromotion(ctx context.Context, arg UpdateDeliveryPromotionParams) (MerchantDeliveryPromotion, error) {
	row := q.db.QueryRow(ctx, updateDeliveryPromotion,
		arg.ID,
		arg.Name,
		arg.MinOrderAmount,
		arg.DiscountAmount,
		arg.ValidFrom,
		arg.ValidUntil,
		arg.IsActive,
	)
	var i MerchantDeliveryPromotion
	err := row.Scan(
		&i.ID,
		&i.MerchantID,
		&i.Name,
		&i.MinOrderAmount,
		&i.DiscountAmount,
		&i.ValidFrom,
		&i.ValidUntil,
		&i.IsActive,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}
