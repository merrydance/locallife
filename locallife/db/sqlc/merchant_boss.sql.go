// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: merchant_boss.sql

package db

import (
	"context"
	"time"

	"github.com/jackc/pgx/v5/pgtype"
)

const checkUserIsBoss = `-- name: CheckUserIsBoss :one
SELECT EXISTS(
    SELECT 1 FROM merchant_bosses
    WHERE user_id = $1 AND merchant_id = $2 AND status = 'active'
)
`

type CheckUserIsBossParams struct {
	UserID     int64 `json:"user_id"`
	MerchantID int64 `json:"merchant_id"`
}

// 检查用户是否是某商户的 Boss
func (q *Queries) CheckUserIsBoss(ctx context.Context, arg CheckUserIsBossParams) (bool, error) {
	row := q.db.QueryRow(ctx, checkUserIsBoss, arg.UserID, arg.MerchantID)
	var exists bool
	err := row.Scan(&exists)
	return exists, err
}

const countMerchantBosses = `-- name: CountMerchantBosses :one
SELECT COUNT(*) FROM merchant_bosses
WHERE merchant_id = $1 AND status = 'active'
`

func (q *Queries) CountMerchantBosses(ctx context.Context, merchantID int64) (int64, error) {
	row := q.db.QueryRow(ctx, countMerchantBosses, merchantID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createMerchantBoss = `-- name: CreateMerchantBoss :one

INSERT INTO merchant_bosses (user_id, merchant_id, status)
VALUES ($1, $2, 'active')
RETURNING id, user_id, merchant_id, status, created_at, updated_at
`

type CreateMerchantBossParams struct {
	UserID     int64 `json:"user_id"`
	MerchantID int64 `json:"merchant_id"`
}

// Boss 店铺认领查询
func (q *Queries) CreateMerchantBoss(ctx context.Context, arg CreateMerchantBossParams) (MerchantBoss, error) {
	row := q.db.QueryRow(ctx, createMerchantBoss, arg.UserID, arg.MerchantID)
	var i MerchantBoss
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantID,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const deleteMerchantBoss = `-- name: DeleteMerchantBoss :exec
DELETE FROM merchant_bosses WHERE id = $1
`

func (q *Queries) DeleteMerchantBoss(ctx context.Context, id int64) error {
	_, err := q.db.Exec(ctx, deleteMerchantBoss, id)
	return err
}

const getMerchantBoss = `-- name: GetMerchantBoss :one
SELECT id, user_id, merchant_id, status, created_at, updated_at FROM merchant_bosses
WHERE user_id = $1 AND merchant_id = $2 AND status = 'active'
`

type GetMerchantBossParams struct {
	UserID     int64 `json:"user_id"`
	MerchantID int64 `json:"merchant_id"`
}

func (q *Queries) GetMerchantBoss(ctx context.Context, arg GetMerchantBossParams) (MerchantBoss, error) {
	row := q.db.QueryRow(ctx, getMerchantBoss, arg.UserID, arg.MerchantID)
	var i MerchantBoss
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantID,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const listBossesByMerchant = `-- name: ListBossesByMerchant :many
SELECT 
    mb.id, mb.user_id, mb.merchant_id, mb.status, mb.created_at, mb.updated_at,
    u.full_name,
    u.avatar_url,
    u.phone
FROM merchant_bosses mb
JOIN users u ON mb.user_id = u.id
WHERE mb.merchant_id = $1
ORDER BY mb.created_at
`

type ListBossesByMerchantRow struct {
	ID         int64              `json:"id"`
	UserID     int64              `json:"user_id"`
	MerchantID int64              `json:"merchant_id"`
	Status     string             `json:"status"`
	CreatedAt  time.Time          `json:"created_at"`
	UpdatedAt  pgtype.Timestamptz `json:"updated_at"`
	FullName   string             `json:"full_name"`
	AvatarUrl  pgtype.Text        `json:"avatar_url"`
	Phone      pgtype.Text        `json:"phone"`
}

// 获取店铺的所有 Boss
func (q *Queries) ListBossesByMerchant(ctx context.Context, merchantID int64) ([]ListBossesByMerchantRow, error) {
	rows, err := q.db.Query(ctx, listBossesByMerchant, merchantID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []ListBossesByMerchantRow{}
	for rows.Next() {
		var i ListBossesByMerchantRow
		if err := rows.Scan(
			&i.ID,
			&i.UserID,
			&i.MerchantID,
			&i.Status,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.FullName,
			&i.AvatarUrl,
			&i.Phone,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listMerchantsByBoss = `-- name: ListMerchantsByBoss :many
SELECT m.id, m.owner_user_id, m.name, m.description, m.logo_url, m.phone, m.address, m.latitude, m.longitude, m.status, m.application_data, m.created_at, m.updated_at, m.version, m.region_id, m.is_open, m.auto_close_at, m.deleted_at, m.pending_owner_bind, m.bind_code, m.bind_code_expires_at, m.boss_bind_code, m.boss_bind_code_expires_at FROM merchants m
JOIN merchant_bosses mb ON m.id = mb.merchant_id
WHERE mb.user_id = $1 AND mb.status = 'active' AND m.deleted_at IS NULL
ORDER BY m.created_at
`

// 获取 Boss 关联的所有店铺
func (q *Queries) ListMerchantsByBoss(ctx context.Context, userID int64) ([]Merchant, error) {
	rows, err := q.db.Query(ctx, listMerchantsByBoss, userID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []Merchant{}
	for rows.Next() {
		var i Merchant
		if err := rows.Scan(
			&i.ID,
			&i.OwnerUserID,
			&i.Name,
			&i.Description,
			&i.LogoUrl,
			&i.Phone,
			&i.Address,
			&i.Latitude,
			&i.Longitude,
			&i.Status,
			&i.ApplicationData,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.Version,
			&i.RegionID,
			&i.IsOpen,
			&i.AutoCloseAt,
			&i.DeletedAt,
			&i.PendingOwnerBind,
			&i.BindCode,
			&i.BindCodeExpiresAt,
			&i.BossBindCode,
			&i.BossBindCodeExpiresAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateMerchantBossStatus = `-- name: UpdateMerchantBossStatus :one
UPDATE merchant_bosses
SET status = $2, updated_at = now()
WHERE id = $1
RETURNING id, user_id, merchant_id, status, created_at, updated_at
`

type UpdateMerchantBossStatusParams struct {
	ID     int64  `json:"id"`
	Status string `json:"status"`
}

func (q *Queries) UpdateMerchantBossStatus(ctx context.Context, arg UpdateMerchantBossStatusParams) (MerchantBoss, error) {
	row := q.db.QueryRow(ctx, updateMerchantBossStatus, arg.ID, arg.Status)
	var i MerchantBoss
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.MerchantID,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}
