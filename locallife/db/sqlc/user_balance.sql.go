// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: user_balance.sql

package db

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const addUserBalance = `-- name: AddUserBalance :one
UPDATE user_balances
SET balance = balance + $2,
    total_income = total_income + $2,
    updated_at = NOW()
WHERE user_id = $1
RETURNING user_id, balance, frozen_balance, total_income, total_expense, total_withdraw, created_at, updated_at
`

type AddUserBalanceParams struct {
	UserID  int64 `json:"user_id"`
	Balance int64 `json:"balance"`
}

// 增加用户余额（入账）
func (q *Queries) AddUserBalance(ctx context.Context, arg AddUserBalanceParams) (UserBalance, error) {
	row := q.db.QueryRow(ctx, addUserBalance, arg.UserID, arg.Balance)
	var i UserBalance
	err := row.Scan(
		&i.UserID,
		&i.Balance,
		&i.FrozenBalance,
		&i.TotalIncome,
		&i.TotalExpense,
		&i.TotalWithdraw,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const confirmUserWithdraw = `-- name: ConfirmUserWithdraw :one
UPDATE user_balances
SET frozen_balance = frozen_balance - $2,
    total_withdraw = total_withdraw + $2,
    updated_at = NOW()
WHERE user_id = $1 AND frozen_balance >= $2
RETURNING user_id, balance, frozen_balance, total_income, total_expense, total_withdraw, created_at, updated_at
`

type ConfirmUserWithdrawParams struct {
	UserID        int64 `json:"user_id"`
	FrozenBalance int64 `json:"frozen_balance"`
}

// 确认提现完成（冻结余额转为已提现）
func (q *Queries) ConfirmUserWithdraw(ctx context.Context, arg ConfirmUserWithdrawParams) (UserBalance, error) {
	row := q.db.QueryRow(ctx, confirmUserWithdraw, arg.UserID, arg.FrozenBalance)
	var i UserBalance
	err := row.Scan(
		&i.UserID,
		&i.Balance,
		&i.FrozenBalance,
		&i.TotalIncome,
		&i.TotalExpense,
		&i.TotalWithdraw,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const countUserBalanceLogs = `-- name: CountUserBalanceLogs :one
SELECT COUNT(*) FROM user_balance_logs
WHERE user_id = $1
`

// 统计用户余额变动日志数量
func (q *Queries) CountUserBalanceLogs(ctx context.Context, userID int64) (int64, error) {
	row := q.db.QueryRow(ctx, countUserBalanceLogs, userID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createUserBalance = `-- name: CreateUserBalance :one
INSERT INTO user_balances (user_id, balance, frozen_balance, total_income, total_expense, total_withdraw)
VALUES ($1, 0, 0, 0, 0, 0)
RETURNING user_id, balance, frozen_balance, total_income, total_expense, total_withdraw, created_at, updated_at
`

// 创建用户余额账户
func (q *Queries) CreateUserBalance(ctx context.Context, userID int64) (UserBalance, error) {
	row := q.db.QueryRow(ctx, createUserBalance, userID)
	var i UserBalance
	err := row.Scan(
		&i.UserID,
		&i.Balance,
		&i.FrozenBalance,
		&i.TotalIncome,
		&i.TotalExpense,
		&i.TotalWithdraw,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const createUserBalanceLog = `-- name: CreateUserBalanceLog :one

INSERT INTO user_balance_logs (
    user_id, type, amount, balance_before, balance_after,
    related_type, related_id, source_type, source_id, remark
) VALUES (
    $1, $2, $3, $4, $5, $6, $7, $8, $9, $10
) RETURNING id, user_id, type, amount, balance_before, balance_after, related_type, related_id, source_type, source_id, remark, created_at
`

type CreateUserBalanceLogParams struct {
	UserID        int64       `json:"user_id"`
	Type          string      `json:"type"`
	Amount        int64       `json:"amount"`
	BalanceBefore int64       `json:"balance_before"`
	BalanceAfter  int64       `json:"balance_after"`
	RelatedType   pgtype.Text `json:"related_type"`
	RelatedID     pgtype.Int8 `json:"related_id"`
	SourceType    pgtype.Text `json:"source_type"`
	SourceID      pgtype.Int8 `json:"source_id"`
	Remark        pgtype.Text `json:"remark"`
}

// ==========================================
// 用户余额日志相关查询
// ==========================================
// 创建余额变动日志
func (q *Queries) CreateUserBalanceLog(ctx context.Context, arg CreateUserBalanceLogParams) (UserBalanceLog, error) {
	row := q.db.QueryRow(ctx, createUserBalanceLog,
		arg.UserID,
		arg.Type,
		arg.Amount,
		arg.BalanceBefore,
		arg.BalanceAfter,
		arg.RelatedType,
		arg.RelatedID,
		arg.SourceType,
		arg.SourceID,
		arg.Remark,
	)
	var i UserBalanceLog
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.Type,
		&i.Amount,
		&i.BalanceBefore,
		&i.BalanceAfter,
		&i.RelatedType,
		&i.RelatedID,
		&i.SourceType,
		&i.SourceID,
		&i.Remark,
		&i.CreatedAt,
	)
	return i, err
}

const deductUserBalance = `-- name: DeductUserBalance :one
UPDATE user_balances
SET balance = balance - $2,
    total_expense = total_expense + $2,
    updated_at = NOW()
WHERE user_id = $1 AND balance >= $2
RETURNING user_id, balance, frozen_balance, total_income, total_expense, total_withdraw, created_at, updated_at
`

type DeductUserBalanceParams struct {
	UserID  int64 `json:"user_id"`
	Balance int64 `json:"balance"`
}

// 扣减用户余额（出账，余额不足会报错）
func (q *Queries) DeductUserBalance(ctx context.Context, arg DeductUserBalanceParams) (UserBalance, error) {
	row := q.db.QueryRow(ctx, deductUserBalance, arg.UserID, arg.Balance)
	var i UserBalance
	err := row.Scan(
		&i.UserID,
		&i.Balance,
		&i.FrozenBalance,
		&i.TotalIncome,
		&i.TotalExpense,
		&i.TotalWithdraw,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const freezeUserBalance = `-- name: FreezeUserBalance :one
UPDATE user_balances
SET balance = balance - $2,
    frozen_balance = frozen_balance + $2,
    updated_at = NOW()
WHERE user_id = $1 AND balance >= $2
RETURNING user_id, balance, frozen_balance, total_income, total_expense, total_withdraw, created_at, updated_at
`

type FreezeUserBalanceParams struct {
	UserID  int64 `json:"user_id"`
	Balance int64 `json:"balance"`
}

// 冻结用户余额（提现申请时）
func (q *Queries) FreezeUserBalance(ctx context.Context, arg FreezeUserBalanceParams) (UserBalance, error) {
	row := q.db.QueryRow(ctx, freezeUserBalance, arg.UserID, arg.Balance)
	var i UserBalance
	err := row.Scan(
		&i.UserID,
		&i.Balance,
		&i.FrozenBalance,
		&i.TotalIncome,
		&i.TotalExpense,
		&i.TotalWithdraw,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getOrCreateUserBalance = `-- name: GetOrCreateUserBalance :one
INSERT INTO user_balances (user_id, balance, frozen_balance, total_income, total_expense, total_withdraw)
VALUES ($1, 0, 0, 0, 0, 0)
ON CONFLICT (user_id) DO UPDATE SET updated_at = NOW()
RETURNING user_id, balance, frozen_balance, total_income, total_expense, total_withdraw, created_at, updated_at
`

// 获取或创建用户余额账户（原子操作）
func (q *Queries) GetOrCreateUserBalance(ctx context.Context, userID int64) (UserBalance, error) {
	row := q.db.QueryRow(ctx, getOrCreateUserBalance, userID)
	var i UserBalance
	err := row.Scan(
		&i.UserID,
		&i.Balance,
		&i.FrozenBalance,
		&i.TotalIncome,
		&i.TotalExpense,
		&i.TotalWithdraw,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getUserBalance = `-- name: GetUserBalance :one

SELECT user_id, balance, frozen_balance, total_income, total_expense, total_withdraw, created_at, updated_at FROM user_balances
WHERE user_id = $1
`

// ==========================================
// 用户余额账户相关查询
// ==========================================
// 获取用户余额（不存在则返回nil）
func (q *Queries) GetUserBalance(ctx context.Context, userID int64) (UserBalance, error) {
	row := q.db.QueryRow(ctx, getUserBalance, userID)
	var i UserBalance
	err := row.Scan(
		&i.UserID,
		&i.Balance,
		&i.FrozenBalance,
		&i.TotalIncome,
		&i.TotalExpense,
		&i.TotalWithdraw,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getUserBalanceForUpdate = `-- name: GetUserBalanceForUpdate :one
SELECT user_id, balance, frozen_balance, total_income, total_expense, total_withdraw, created_at, updated_at FROM user_balances
WHERE user_id = $1
FOR UPDATE
`

// 获取用户余额（加锁，用于更新）
func (q *Queries) GetUserBalanceForUpdate(ctx context.Context, userID int64) (UserBalance, error) {
	row := q.db.QueryRow(ctx, getUserBalanceForUpdate, userID)
	var i UserBalance
	err := row.Scan(
		&i.UserID,
		&i.Balance,
		&i.FrozenBalance,
		&i.TotalIncome,
		&i.TotalExpense,
		&i.TotalWithdraw,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getUserBalanceLogByRelated = `-- name: GetUserBalanceLogByRelated :one
SELECT id, user_id, type, amount, balance_before, balance_after, related_type, related_id, source_type, source_id, remark, created_at FROM user_balance_logs
WHERE related_type = $1 AND related_id = $2
LIMIT 1
`

type GetUserBalanceLogByRelatedParams struct {
	RelatedType pgtype.Text `json:"related_type"`
	RelatedID   pgtype.Int8 `json:"related_id"`
}

// 根据关联信息获取日志（用于幂等检查）
func (q *Queries) GetUserBalanceLogByRelated(ctx context.Context, arg GetUserBalanceLogByRelatedParams) (UserBalanceLog, error) {
	row := q.db.QueryRow(ctx, getUserBalanceLogByRelated, arg.RelatedType, arg.RelatedID)
	var i UserBalanceLog
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.Type,
		&i.Amount,
		&i.BalanceBefore,
		&i.BalanceAfter,
		&i.RelatedType,
		&i.RelatedID,
		&i.SourceType,
		&i.SourceID,
		&i.Remark,
		&i.CreatedAt,
	)
	return i, err
}

const listUserBalanceLogs = `-- name: ListUserBalanceLogs :many
SELECT id, user_id, type, amount, balance_before, balance_after, related_type, related_id, source_type, source_id, remark, created_at FROM user_balance_logs
WHERE user_id = $1
ORDER BY created_at DESC
LIMIT $2 OFFSET $3
`

type ListUserBalanceLogsParams struct {
	UserID int64 `json:"user_id"`
	Limit  int32 `json:"limit"`
	Offset int32 `json:"offset"`
}

// 获取用户余额变动日志
func (q *Queries) ListUserBalanceLogs(ctx context.Context, arg ListUserBalanceLogsParams) ([]UserBalanceLog, error) {
	rows, err := q.db.Query(ctx, listUserBalanceLogs, arg.UserID, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []UserBalanceLog{}
	for rows.Next() {
		var i UserBalanceLog
		if err := rows.Scan(
			&i.ID,
			&i.UserID,
			&i.Type,
			&i.Amount,
			&i.BalanceBefore,
			&i.BalanceAfter,
			&i.RelatedType,
			&i.RelatedID,
			&i.SourceType,
			&i.SourceID,
			&i.Remark,
			&i.CreatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listUserBalanceLogsByType = `-- name: ListUserBalanceLogsByType :many
SELECT id, user_id, type, amount, balance_before, balance_after, related_type, related_id, source_type, source_id, remark, created_at FROM user_balance_logs
WHERE user_id = $1 AND type = $2
ORDER BY created_at DESC
LIMIT $3 OFFSET $4
`

type ListUserBalanceLogsByTypeParams struct {
	UserID int64  `json:"user_id"`
	Type   string `json:"type"`
	Limit  int32  `json:"limit"`
	Offset int32  `json:"offset"`
}

// 按类型获取用户余额变动日志
func (q *Queries) ListUserBalanceLogsByType(ctx context.Context, arg ListUserBalanceLogsByTypeParams) ([]UserBalanceLog, error) {
	rows, err := q.db.Query(ctx, listUserBalanceLogsByType,
		arg.UserID,
		arg.Type,
		arg.Limit,
		arg.Offset,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []UserBalanceLog{}
	for rows.Next() {
		var i UserBalanceLog
		if err := rows.Scan(
			&i.ID,
			&i.UserID,
			&i.Type,
			&i.Amount,
			&i.BalanceBefore,
			&i.BalanceAfter,
			&i.RelatedType,
			&i.RelatedID,
			&i.SourceType,
			&i.SourceID,
			&i.Remark,
			&i.CreatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const unfreezeUserBalance = `-- name: UnfreezeUserBalance :one
UPDATE user_balances
SET balance = balance + $2,
    frozen_balance = frozen_balance - $2,
    updated_at = NOW()
WHERE user_id = $1 AND frozen_balance >= $2
RETURNING user_id, balance, frozen_balance, total_income, total_expense, total_withdraw, created_at, updated_at
`

type UnfreezeUserBalanceParams struct {
	UserID  int64 `json:"user_id"`
	Balance int64 `json:"balance"`
}

// 解冻用户余额（提现失败时）
func (q *Queries) UnfreezeUserBalance(ctx context.Context, arg UnfreezeUserBalanceParams) (UserBalance, error) {
	row := q.db.QueryRow(ctx, unfreezeUserBalance, arg.UserID, arg.Balance)
	var i UserBalance
	err := row.Scan(
		&i.UserID,
		&i.Balance,
		&i.FrozenBalance,
		&i.TotalIncome,
		&i.TotalExpense,
		&i.TotalWithdraw,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}
