// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: operator_region.sql

package db

import (
	"context"
	"time"
)

const addOperatorRegion = `-- name: AddOperatorRegion :one
INSERT INTO operator_regions (
    operator_id,
    region_id,
    status
) VALUES (
    $1, $2, 'active'
) RETURNING id, operator_id, region_id, status, created_at
`

type AddOperatorRegionParams struct {
	OperatorID int64 `json:"operator_id"`
	RegionID   int64 `json:"region_id"`
}

// 为运营商添加管理区域
func (q *Queries) AddOperatorRegion(ctx context.Context, arg AddOperatorRegionParams) (OperatorRegion, error) {
	row := q.db.QueryRow(ctx, addOperatorRegion, arg.OperatorID, arg.RegionID)
	var i OperatorRegion
	err := row.Scan(
		&i.ID,
		&i.OperatorID,
		&i.RegionID,
		&i.Status,
		&i.CreatedAt,
	)
	return i, err
}

const checkOperatorManagesRegion = `-- name: CheckOperatorManagesRegion :one
SELECT EXISTS(
    SELECT 1 FROM operator_regions
    WHERE operator_id = $1 AND region_id = $2 AND status = 'active'
) as manages
`

type CheckOperatorManagesRegionParams struct {
	OperatorID int64 `json:"operator_id"`
	RegionID   int64 `json:"region_id"`
}

// 检查运营商是否管理某区域
func (q *Queries) CheckOperatorManagesRegion(ctx context.Context, arg CheckOperatorManagesRegionParams) (bool, error) {
	row := q.db.QueryRow(ctx, checkOperatorManagesRegion, arg.OperatorID, arg.RegionID)
	var manages bool
	err := row.Scan(&manages)
	return manages, err
}

const countOperatorRegions = `-- name: CountOperatorRegions :one
SELECT COUNT(*) FROM operator_regions
WHERE operator_id = $1 AND status = 'active'
`

// 统计运营商管理的区域数量
func (q *Queries) CountOperatorRegions(ctx context.Context, operatorID int64) (int64, error) {
	row := q.db.QueryRow(ctx, countOperatorRegions, operatorID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const getActiveOperatorByRegion = `-- name: GetActiveOperatorByRegion :one
SELECT o.id, o.user_id, o.region_id, o.name, o.contact_name, o.contact_phone, o.wechat_mch_id, o.commission_rate, o.status, o.created_at, o.updated_at, o.contract_start_date, o.contract_end_date, o.contract_years, o.sub_mch_id FROM operators o
JOIN operator_regions or_t ON o.id = or_t.operator_id
WHERE or_t.region_id = $1 
    AND or_t.status = 'active' 
    AND o.status = 'active'
LIMIT 1
`

// 根据区域获取运营商（通过operator_regions表，支持多区域）
func (q *Queries) GetActiveOperatorByRegion(ctx context.Context, regionID int64) (Operator, error) {
	row := q.db.QueryRow(ctx, getActiveOperatorByRegion, regionID)
	var i Operator
	err := row.Scan(
		&i.ID,
		&i.UserID,
		&i.RegionID,
		&i.Name,
		&i.ContactName,
		&i.ContactPhone,
		&i.WechatMchID,
		&i.CommissionRate,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.ContractStartDate,
		&i.ContractEndDate,
		&i.ContractYears,
		&i.SubMchID,
	)
	return i, err
}

const getOperatorRegion = `-- name: GetOperatorRegion :one
SELECT id, operator_id, region_id, status, created_at FROM operator_regions
WHERE operator_id = $1 AND region_id = $2 LIMIT 1
`

type GetOperatorRegionParams struct {
	OperatorID int64 `json:"operator_id"`
	RegionID   int64 `json:"region_id"`
}

func (q *Queries) GetOperatorRegion(ctx context.Context, arg GetOperatorRegionParams) (OperatorRegion, error) {
	row := q.db.QueryRow(ctx, getOperatorRegion, arg.OperatorID, arg.RegionID)
	var i OperatorRegion
	err := row.Scan(
		&i.ID,
		&i.OperatorID,
		&i.RegionID,
		&i.Status,
		&i.CreatedAt,
	)
	return i, err
}

const listAllOperatorRegions = `-- name: ListAllOperatorRegions :many
SELECT or_t.id, or_t.operator_id, or_t.region_id, or_t.status, or_t.created_at, 
    o.name as operator_name, 
    r.name as region_name, 
    r.code as region_code
FROM operator_regions or_t
JOIN operators o ON or_t.operator_id = o.id
JOIN regions r ON or_t.region_id = r.id
ORDER BY o.id, r.code
LIMIT $1 OFFSET $2
`

type ListAllOperatorRegionsParams struct {
	Limit  int32 `json:"limit"`
	Offset int32 `json:"offset"`
}

type ListAllOperatorRegionsRow struct {
	ID           int64     `json:"id"`
	OperatorID   int64     `json:"operator_id"`
	RegionID     int64     `json:"region_id"`
	Status       string    `json:"status"`
	CreatedAt    time.Time `json:"created_at"`
	OperatorName string    `json:"operator_name"`
	RegionName   string    `json:"region_name"`
	RegionCode   string    `json:"region_code"`
}

// 列出所有运营商区域关系（管理后台用）
func (q *Queries) ListAllOperatorRegions(ctx context.Context, arg ListAllOperatorRegionsParams) ([]ListAllOperatorRegionsRow, error) {
	rows, err := q.db.Query(ctx, listAllOperatorRegions, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []ListAllOperatorRegionsRow{}
	for rows.Next() {
		var i ListAllOperatorRegionsRow
		if err := rows.Scan(
			&i.ID,
			&i.OperatorID,
			&i.RegionID,
			&i.Status,
			&i.CreatedAt,
			&i.OperatorName,
			&i.RegionName,
			&i.RegionCode,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listOperatorRegions = `-- name: ListOperatorRegions :many
SELECT or_t.id, or_t.operator_id, or_t.region_id, or_t.status, or_t.created_at, r.name as region_name, r.code as region_code, r.level as region_level
FROM operator_regions or_t
JOIN regions r ON or_t.region_id = r.id
WHERE or_t.operator_id = $1 AND or_t.status = 'active'
ORDER BY r.code
`

type ListOperatorRegionsRow struct {
	ID          int64     `json:"id"`
	OperatorID  int64     `json:"operator_id"`
	RegionID    int64     `json:"region_id"`
	Status      string    `json:"status"`
	CreatedAt   time.Time `json:"created_at"`
	RegionName  string    `json:"region_name"`
	RegionCode  string    `json:"region_code"`
	RegionLevel int16     `json:"region_level"`
}

// 列出运营商管理的所有区域
func (q *Queries) ListOperatorRegions(ctx context.Context, operatorID int64) ([]ListOperatorRegionsRow, error) {
	rows, err := q.db.Query(ctx, listOperatorRegions, operatorID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []ListOperatorRegionsRow{}
	for rows.Next() {
		var i ListOperatorRegionsRow
		if err := rows.Scan(
			&i.ID,
			&i.OperatorID,
			&i.RegionID,
			&i.Status,
			&i.CreatedAt,
			&i.RegionName,
			&i.RegionCode,
			&i.RegionLevel,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listRegionOperators = `-- name: ListRegionOperators :many
SELECT or_t.id, or_t.operator_id, or_t.region_id, or_t.status, or_t.created_at, o.name as operator_name, o.contact_name, o.contact_phone
FROM operator_regions or_t
JOIN operators o ON or_t.operator_id = o.id
WHERE or_t.region_id = $1 AND or_t.status = 'active' AND o.status = 'active'
`

type ListRegionOperatorsRow struct {
	ID           int64     `json:"id"`
	OperatorID   int64     `json:"operator_id"`
	RegionID     int64     `json:"region_id"`
	Status       string    `json:"status"`
	CreatedAt    time.Time `json:"created_at"`
	OperatorName string    `json:"operator_name"`
	ContactName  string    `json:"contact_name"`
	ContactPhone string    `json:"contact_phone"`
}

// 列出管理某区域的所有运营商
func (q *Queries) ListRegionOperators(ctx context.Context, regionID int64) ([]ListRegionOperatorsRow, error) {
	rows, err := q.db.Query(ctx, listRegionOperators, regionID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []ListRegionOperatorsRow{}
	for rows.Next() {
		var i ListRegionOperatorsRow
		if err := rows.Scan(
			&i.ID,
			&i.OperatorID,
			&i.RegionID,
			&i.Status,
			&i.CreatedAt,
			&i.OperatorName,
			&i.ContactName,
			&i.ContactPhone,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const removeOperatorRegion = `-- name: RemoveOperatorRegion :exec
DELETE FROM operator_regions
WHERE operator_id = $1 AND region_id = $2
`

type RemoveOperatorRegionParams struct {
	OperatorID int64 `json:"operator_id"`
	RegionID   int64 `json:"region_id"`
}

// 移除运营商的管理区域
func (q *Queries) RemoveOperatorRegion(ctx context.Context, arg RemoveOperatorRegionParams) error {
	_, err := q.db.Exec(ctx, removeOperatorRegion, arg.OperatorID, arg.RegionID)
	return err
}

const updateOperatorRegionStatus = `-- name: UpdateOperatorRegionStatus :one
UPDATE operator_regions
SET status = $3
WHERE operator_id = $1 AND region_id = $2
RETURNING id, operator_id, region_id, status, created_at
`

type UpdateOperatorRegionStatusParams struct {
	OperatorID int64  `json:"operator_id"`
	RegionID   int64  `json:"region_id"`
	Status     string `json:"status"`
}

// 更新运营商区域状态（暂停/恢复）
func (q *Queries) UpdateOperatorRegionStatus(ctx context.Context, arg UpdateOperatorRegionStatusParams) (OperatorRegion, error) {
	row := q.db.QueryRow(ctx, updateOperatorRegionStatus, arg.OperatorID, arg.RegionID, arg.Status)
	var i OperatorRegion
	err := row.Scan(
		&i.ID,
		&i.OperatorID,
		&i.RegionID,
		&i.Status,
		&i.CreatedAt,
	)
	return i, err
}
