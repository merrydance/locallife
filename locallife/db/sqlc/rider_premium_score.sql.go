// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: rider_premium_score.sql

package db

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const countRiderPremiumScoreLogs = `-- name: CountRiderPremiumScoreLogs :one
SELECT COUNT(*) FROM rider_premium_score_logs
WHERE rider_id = $1
`

// 统计骑手高值单资格积分变更历史数量
func (q *Queries) CountRiderPremiumScoreLogs(ctx context.Context, riderID int64) (int64, error) {
	row := q.db.QueryRow(ctx, countRiderPremiumScoreLogs, riderID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createRiderPremiumScoreLog = `-- name: CreateRiderPremiumScoreLog :one
INSERT INTO rider_premium_score_logs (
    rider_id,
    change_amount,
    old_score,
    new_score,
    change_type,
    related_order_id,
    related_delivery_id,
    remark
) VALUES (
    $1, $2, $3, $4, $5, $6, $7, $8
) RETURNING id, rider_id, change_amount, old_score, new_score, change_type, related_order_id, related_delivery_id, remark, created_at
`

type CreateRiderPremiumScoreLogParams struct {
	RiderID           int64       `json:"rider_id"`
	ChangeAmount      int16       `json:"change_amount"`
	OldScore          int16       `json:"old_score"`
	NewScore          int16       `json:"new_score"`
	ChangeType        string      `json:"change_type"`
	RelatedOrderID    pgtype.Int8 `json:"related_order_id"`
	RelatedDeliveryID pgtype.Int8 `json:"related_delivery_id"`
	Remark            pgtype.Text `json:"remark"`
}

// 创建高值单资格积分变更日志
func (q *Queries) CreateRiderPremiumScoreLog(ctx context.Context, arg CreateRiderPremiumScoreLogParams) (RiderPremiumScoreLog, error) {
	row := q.db.QueryRow(ctx, createRiderPremiumScoreLog,
		arg.RiderID,
		arg.ChangeAmount,
		arg.OldScore,
		arg.NewScore,
		arg.ChangeType,
		arg.RelatedOrderID,
		arg.RelatedDeliveryID,
		arg.Remark,
	)
	var i RiderPremiumScoreLog
	err := row.Scan(
		&i.ID,
		&i.RiderID,
		&i.ChangeAmount,
		&i.OldScore,
		&i.NewScore,
		&i.ChangeType,
		&i.RelatedOrderID,
		&i.RelatedDeliveryID,
		&i.Remark,
		&i.CreatedAt,
	)
	return i, err
}

const getRiderPremiumScore = `-- name: GetRiderPremiumScore :one

SELECT premium_score FROM rider_profiles
WHERE rider_id = $1
LIMIT 1
`

// =============================================
// 高值单资格积分查询
// =============================================
// 获取骑手高值单资格积分
func (q *Queries) GetRiderPremiumScore(ctx context.Context, riderID int64) (int16, error) {
	row := q.db.QueryRow(ctx, getRiderPremiumScore, riderID)
	var premium_score int16
	err := row.Scan(&premium_score)
	return premium_score, err
}

const getRiderPremiumScoreWithProfile = `-- name: GetRiderPremiumScoreWithProfile :one
SELECT 
    r.id AS rider_id,
    r.real_name,
    rp.premium_score,
    CASE WHEN rp.premium_score >= 0 THEN TRUE ELSE FALSE END AS can_accept_premium_order
FROM riders r
JOIN rider_profiles rp ON r.id = rp.rider_id
WHERE r.id = $1
LIMIT 1
`

type GetRiderPremiumScoreWithProfileRow struct {
	RiderID               int64  `json:"rider_id"`
	RealName              string `json:"real_name"`
	PremiumScore          int16  `json:"premium_score"`
	CanAcceptPremiumOrder bool   `json:"can_accept_premium_order"`
}

// 获取骑手高值单资格积分及基本信息（用于API返回）
func (q *Queries) GetRiderPremiumScoreWithProfile(ctx context.Context, id int64) (GetRiderPremiumScoreWithProfileRow, error) {
	row := q.db.QueryRow(ctx, getRiderPremiumScoreWithProfile, id)
	var i GetRiderPremiumScoreWithProfileRow
	err := row.Scan(
		&i.RiderID,
		&i.RealName,
		&i.PremiumScore,
		&i.CanAcceptPremiumOrder,
	)
	return i, err
}

const listRiderPremiumScoreLogs = `-- name: ListRiderPremiumScoreLogs :many
SELECT id, rider_id, change_amount, old_score, new_score, change_type, related_order_id, related_delivery_id, remark, created_at FROM rider_premium_score_logs
WHERE rider_id = $1
ORDER BY created_at DESC
LIMIT $2 OFFSET $3
`

type ListRiderPremiumScoreLogsParams struct {
	RiderID int64 `json:"rider_id"`
	Limit   int32 `json:"limit"`
	Offset  int32 `json:"offset"`
}

// 查询骑手高值单资格积分变更历史
func (q *Queries) ListRiderPremiumScoreLogs(ctx context.Context, arg ListRiderPremiumScoreLogsParams) ([]RiderPremiumScoreLog, error) {
	rows, err := q.db.Query(ctx, listRiderPremiumScoreLogs, arg.RiderID, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []RiderPremiumScoreLog{}
	for rows.Next() {
		var i RiderPremiumScoreLog
		if err := rows.Scan(
			&i.ID,
			&i.RiderID,
			&i.ChangeAmount,
			&i.OldScore,
			&i.NewScore,
			&i.ChangeType,
			&i.RelatedOrderID,
			&i.RelatedDeliveryID,
			&i.Remark,
			&i.CreatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateRiderPremiumScore = `-- name: UpdateRiderPremiumScore :one
UPDATE rider_profiles
SET premium_score = premium_score + $2,
    updated_at = NOW()
WHERE rider_id = $1
RETURNING premium_score
`

type UpdateRiderPremiumScoreParams struct {
	RiderID      int64 `json:"rider_id"`
	PremiumScore int16 `json:"premium_score"`
}

// 更新骑手高值单资格积分（原子操作）
func (q *Queries) UpdateRiderPremiumScore(ctx context.Context, arg UpdateRiderPremiumScoreParams) (int16, error) {
	row := q.db.QueryRow(ctx, updateRiderPremiumScore, arg.RiderID, arg.PremiumScore)
	var premium_score int16
	err := row.Scan(&premium_score)
	return premium_score, err
}
