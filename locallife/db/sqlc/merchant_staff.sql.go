// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: merchant_staff.sql

package db

import (
	"context"
	"time"

	"github.com/jackc/pgx/v5/pgtype"
)

const checkUserHasMerchantAccess = `-- name: CheckUserHasMerchantAccess :one
SELECT EXISTS(
    SELECT 1 FROM merchant_staff 
    WHERE merchant_id = $1 AND user_id = $2 AND status = 'active'
) AS has_access
`

type CheckUserHasMerchantAccessParams struct {
	MerchantID int64 `json:"merchant_id"`
	UserID     int64 `json:"user_id"`
}

func (q *Queries) CheckUserHasMerchantAccess(ctx context.Context, arg CheckUserHasMerchantAccessParams) (bool, error) {
	row := q.db.QueryRow(ctx, checkUserHasMerchantAccess, arg.MerchantID, arg.UserID)
	var has_access bool
	err := row.Scan(&has_access)
	return has_access, err
}

const countMerchantStaff = `-- name: CountMerchantStaff :one
SELECT COUNT(*) FROM merchant_staff 
WHERE merchant_id = $1 AND status = 'active'
`

func (q *Queries) CountMerchantStaff(ctx context.Context, merchantID int64) (int64, error) {
	row := q.db.QueryRow(ctx, countMerchantStaff, merchantID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createMerchantStaff = `-- name: CreateMerchantStaff :one

INSERT INTO merchant_staff (merchant_id, user_id, role, status, invited_by)
VALUES ($1, $2, $3, $4, $5) RETURNING id, merchant_id, user_id, role, status, invited_by, created_at, updated_at
`

type CreateMerchantStaffParams struct {
	MerchantID int64       `json:"merchant_id"`
	UserID     int64       `json:"user_id"`
	Role       string      `json:"role"`
	Status     string      `json:"status"`
	InvitedBy  pgtype.Int8 `json:"invited_by"`
}

// 商户员工管理查询
func (q *Queries) CreateMerchantStaff(ctx context.Context, arg CreateMerchantStaffParams) (MerchantStaff, error) {
	row := q.db.QueryRow(ctx, createMerchantStaff,
		arg.MerchantID,
		arg.UserID,
		arg.Role,
		arg.Status,
		arg.InvitedBy,
	)
	var i MerchantStaff
	err := row.Scan(
		&i.ID,
		&i.MerchantID,
		&i.UserID,
		&i.Role,
		&i.Status,
		&i.InvitedBy,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const deleteMerchantStaff = `-- name: DeleteMerchantStaff :exec
DELETE FROM merchant_staff WHERE id = $1
`

// 硬删除（仅用于特殊情况）
func (q *Queries) DeleteMerchantStaff(ctx context.Context, id int64) error {
	_, err := q.db.Exec(ctx, deleteMerchantStaff, id)
	return err
}

const deleteMerchantStaffByMerchant = `-- name: DeleteMerchantStaffByMerchant :exec
DELETE FROM merchant_staff WHERE merchant_id = $1
`

func (q *Queries) DeleteMerchantStaffByMerchant(ctx context.Context, merchantID int64) error {
	_, err := q.db.Exec(ctx, deleteMerchantStaffByMerchant, merchantID)
	return err
}

const getMerchantStaff = `-- name: GetMerchantStaff :one
SELECT id, merchant_id, user_id, role, status, invited_by, created_at, updated_at FROM merchant_staff
WHERE merchant_id = $1 AND user_id = $2
`

type GetMerchantStaffParams struct {
	MerchantID int64 `json:"merchant_id"`
	UserID     int64 `json:"user_id"`
}

func (q *Queries) GetMerchantStaff(ctx context.Context, arg GetMerchantStaffParams) (MerchantStaff, error) {
	row := q.db.QueryRow(ctx, getMerchantStaff, arg.MerchantID, arg.UserID)
	var i MerchantStaff
	err := row.Scan(
		&i.ID,
		&i.MerchantID,
		&i.UserID,
		&i.Role,
		&i.Status,
		&i.InvitedBy,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getMerchantStaffByID = `-- name: GetMerchantStaffByID :one
SELECT id, merchant_id, user_id, role, status, invited_by, created_at, updated_at FROM merchant_staff
WHERE id = $1
`

func (q *Queries) GetMerchantStaffByID(ctx context.Context, id int64) (MerchantStaff, error) {
	row := q.db.QueryRow(ctx, getMerchantStaffByID, id)
	var i MerchantStaff
	err := row.Scan(
		&i.ID,
		&i.MerchantID,
		&i.UserID,
		&i.Role,
		&i.Status,
		&i.InvitedBy,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getUserMerchantRole = `-- name: GetUserMerchantRole :one
SELECT role FROM merchant_staff 
WHERE merchant_id = $1 AND user_id = $2 AND status = 'active'
`

type GetUserMerchantRoleParams struct {
	MerchantID int64 `json:"merchant_id"`
	UserID     int64 `json:"user_id"`
}

func (q *Queries) GetUserMerchantRole(ctx context.Context, arg GetUserMerchantRoleParams) (string, error) {
	row := q.db.QueryRow(ctx, getUserMerchantRole, arg.MerchantID, arg.UserID)
	var role string
	err := row.Scan(&role)
	return role, err
}

const listMerchantStaffByMerchant = `-- name: ListMerchantStaffByMerchant :many
SELECT 
    ms.id, ms.merchant_id, ms.user_id, ms.role, ms.status, ms.invited_by, ms.created_at, ms.updated_at,
    u.full_name,
    u.avatar_url
FROM merchant_staff ms
JOIN users u ON ms.user_id = u.id
WHERE ms.merchant_id = $1
ORDER BY 
    CASE ms.status 
        WHEN 'active' THEN 1 
        WHEN 'disabled' THEN 2 
    END,
    CASE ms.role 
        WHEN 'owner' THEN 1 
        WHEN 'manager' THEN 2 
        WHEN 'chef' THEN 3 
        WHEN 'cashier' THEN 4 
        WHEN 'pending' THEN 5
    END
`

type ListMerchantStaffByMerchantRow struct {
	ID         int64              `json:"id"`
	MerchantID int64              `json:"merchant_id"`
	UserID     int64              `json:"user_id"`
	Role       string             `json:"role"`
	Status     string             `json:"status"`
	InvitedBy  pgtype.Int8        `json:"invited_by"`
	CreatedAt  time.Time          `json:"created_at"`
	UpdatedAt  pgtype.Timestamptz `json:"updated_at"`
	FullName   string             `json:"full_name"`
	AvatarUrl  pgtype.Text        `json:"avatar_url"`
}

// 显示所有员工，包括离职员工（软删除），按状态和角色排序
func (q *Queries) ListMerchantStaffByMerchant(ctx context.Context, merchantID int64) ([]ListMerchantStaffByMerchantRow, error) {
	rows, err := q.db.Query(ctx, listMerchantStaffByMerchant, merchantID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []ListMerchantStaffByMerchantRow{}
	for rows.Next() {
		var i ListMerchantStaffByMerchantRow
		if err := rows.Scan(
			&i.ID,
			&i.MerchantID,
			&i.UserID,
			&i.Role,
			&i.Status,
			&i.InvitedBy,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.FullName,
			&i.AvatarUrl,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listMerchantsByStaff = `-- name: ListMerchantsByStaff :many
SELECT m.id, m.owner_user_id, m.name, m.description, m.logo_url, m.phone, m.address, m.latitude, m.longitude, m.status, m.application_data, m.created_at, m.updated_at, m.version, m.region_id, m.is_open, m.auto_close_at, m.deleted_at, m.pending_owner_bind, m.bind_code, m.bind_code_expires_at FROM merchants m
JOIN merchant_staff ms ON m.id = ms.merchant_id
WHERE ms.user_id = $1 AND ms.status = 'active'
ORDER BY m.created_at
`

func (q *Queries) ListMerchantsByStaff(ctx context.Context, userID int64) ([]Merchant, error) {
	rows, err := q.db.Query(ctx, listMerchantsByStaff, userID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []Merchant{}
	for rows.Next() {
		var i Merchant
		if err := rows.Scan(
			&i.ID,
			&i.OwnerUserID,
			&i.Name,
			&i.Description,
			&i.LogoUrl,
			&i.Phone,
			&i.Address,
			&i.Latitude,
			&i.Longitude,
			&i.Status,
			&i.ApplicationData,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.Version,
			&i.RegionID,
			&i.IsOpen,
			&i.AutoCloseAt,
			&i.DeletedAt,
			&i.PendingOwnerBind,
			&i.BindCode,
			&i.BindCodeExpiresAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const softDeleteMerchantStaff = `-- name: SoftDeleteMerchantStaff :one
UPDATE merchant_staff 
SET status = 'disabled', updated_at = now()
WHERE id = $1
RETURNING id, merchant_id, user_id, role, status, invited_by, created_at, updated_at
`

// 软删除员工（设置 status='disabled'），保留历史记录
func (q *Queries) SoftDeleteMerchantStaff(ctx context.Context, id int64) (MerchantStaff, error) {
	row := q.db.QueryRow(ctx, softDeleteMerchantStaff, id)
	var i MerchantStaff
	err := row.Scan(
		&i.ID,
		&i.MerchantID,
		&i.UserID,
		&i.Role,
		&i.Status,
		&i.InvitedBy,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const updateMerchantStaffRole = `-- name: UpdateMerchantStaffRole :one
UPDATE merchant_staff 
SET role = $2, status = 'active', updated_at = now()
WHERE id = $1
RETURNING id, merchant_id, user_id, role, status, invited_by, created_at, updated_at
`

type UpdateMerchantStaffRoleParams struct {
	ID   int64  `json:"id"`
	Role string `json:"role"`
}

// 更新角色时同时激活员工（从 pending 变为 active）
func (q *Queries) UpdateMerchantStaffRole(ctx context.Context, arg UpdateMerchantStaffRoleParams) (MerchantStaff, error) {
	row := q.db.QueryRow(ctx, updateMerchantStaffRole, arg.ID, arg.Role)
	var i MerchantStaff
	err := row.Scan(
		&i.ID,
		&i.MerchantID,
		&i.UserID,
		&i.Role,
		&i.Status,
		&i.InvitedBy,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const updateMerchantStaffStatus = `-- name: UpdateMerchantStaffStatus :one
UPDATE merchant_staff 
SET status = $2, updated_at = now()
WHERE id = $1
RETURNING id, merchant_id, user_id, role, status, invited_by, created_at, updated_at
`

type UpdateMerchantStaffStatusParams struct {
	ID     int64  `json:"id"`
	Status string `json:"status"`
}

func (q *Queries) UpdateMerchantStaffStatus(ctx context.Context, arg UpdateMerchantStaffStatusParams) (MerchantStaff, error) {
	row := q.db.QueryRow(ctx, updateMerchantStaffStatus, arg.ID, arg.Status)
	var i MerchantStaff
	err := row.Scan(
		&i.ID,
		&i.MerchantID,
		&i.UserID,
		&i.Role,
		&i.Status,
		&i.InvitedBy,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}
