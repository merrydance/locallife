// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: delivery_pool.sql

package db

import (
	"context"
	"time"

	"github.com/jackc/pgx/v5/pgtype"
)

const addToDeliveryPool = `-- name: AddToDeliveryPool :one
INSERT INTO delivery_pool (
    order_id,
    merchant_id,
    pickup_longitude,
    pickup_latitude,
    delivery_longitude,
    delivery_latitude,
    distance,
    delivery_fee,
    expected_pickup_at,
    expires_at,
    priority
) VALUES (
    $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11
) RETURNING id, order_id, merchant_id, pickup_longitude, pickup_latitude, delivery_longitude, delivery_latitude, distance, delivery_fee, expected_pickup_at, expires_at, priority, created_at
`

type AddToDeliveryPoolParams struct {
	OrderID           int64          `json:"order_id"`
	MerchantID        int64          `json:"merchant_id"`
	PickupLongitude   pgtype.Numeric `json:"pickup_longitude"`
	PickupLatitude    pgtype.Numeric `json:"pickup_latitude"`
	DeliveryLongitude pgtype.Numeric `json:"delivery_longitude"`
	DeliveryLatitude  pgtype.Numeric `json:"delivery_latitude"`
	Distance          int32          `json:"distance"`
	DeliveryFee       int64          `json:"delivery_fee"`
	ExpectedPickupAt  time.Time      `json:"expected_pickup_at"`
	ExpiresAt         time.Time      `json:"expires_at"`
	Priority          int32          `json:"priority"`
}

func (q *Queries) AddToDeliveryPool(ctx context.Context, arg AddToDeliveryPoolParams) (DeliveryPool, error) {
	row := q.db.QueryRow(ctx, addToDeliveryPool,
		arg.OrderID,
		arg.MerchantID,
		arg.PickupLongitude,
		arg.PickupLatitude,
		arg.DeliveryLongitude,
		arg.DeliveryLatitude,
		arg.Distance,
		arg.DeliveryFee,
		arg.ExpectedPickupAt,
		arg.ExpiresAt,
		arg.Priority,
	)
	var i DeliveryPool
	err := row.Scan(
		&i.ID,
		&i.OrderID,
		&i.MerchantID,
		&i.PickupLongitude,
		&i.PickupLatitude,
		&i.DeliveryLongitude,
		&i.DeliveryLatitude,
		&i.Distance,
		&i.DeliveryFee,
		&i.ExpectedPickupAt,
		&i.ExpiresAt,
		&i.Priority,
		&i.CreatedAt,
	)
	return i, err
}

const countDeliveryPool = `-- name: CountDeliveryPool :one
SELECT COUNT(*) FROM delivery_pool
`

func (q *Queries) CountDeliveryPool(ctx context.Context) (int64, error) {
	row := q.db.QueryRow(ctx, countDeliveryPool)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const getDeliveryPoolByOrderID = `-- name: GetDeliveryPoolByOrderID :one
SELECT id, order_id, merchant_id, pickup_longitude, pickup_latitude, delivery_longitude, delivery_latitude, distance, delivery_fee, expected_pickup_at, expires_at, priority, created_at FROM delivery_pool
WHERE order_id = $1 LIMIT 1
`

func (q *Queries) GetDeliveryPoolByOrderID(ctx context.Context, orderID int64) (DeliveryPool, error) {
	row := q.db.QueryRow(ctx, getDeliveryPoolByOrderID, orderID)
	var i DeliveryPool
	err := row.Scan(
		&i.ID,
		&i.OrderID,
		&i.MerchantID,
		&i.PickupLongitude,
		&i.PickupLatitude,
		&i.DeliveryLongitude,
		&i.DeliveryLatitude,
		&i.Distance,
		&i.DeliveryFee,
		&i.ExpectedPickupAt,
		&i.ExpiresAt,
		&i.Priority,
		&i.CreatedAt,
	)
	return i, err
}

const getDeliveryPoolItem = `-- name: GetDeliveryPoolItem :one
SELECT id, order_id, merchant_id, pickup_longitude, pickup_latitude, delivery_longitude, delivery_latitude, distance, delivery_fee, expected_pickup_at, expires_at, priority, created_at FROM delivery_pool
WHERE id = $1 LIMIT 1
`

func (q *Queries) GetDeliveryPoolItem(ctx context.Context, id int64) (DeliveryPool, error) {
	row := q.db.QueryRow(ctx, getDeliveryPoolItem, id)
	var i DeliveryPool
	err := row.Scan(
		&i.ID,
		&i.OrderID,
		&i.MerchantID,
		&i.PickupLongitude,
		&i.PickupLatitude,
		&i.DeliveryLongitude,
		&i.DeliveryLatitude,
		&i.Distance,
		&i.DeliveryFee,
		&i.ExpectedPickupAt,
		&i.ExpiresAt,
		&i.Priority,
		&i.CreatedAt,
	)
	return i, err
}

const getDeliveryPoolItemForUpdate = `-- name: GetDeliveryPoolItemForUpdate :one
SELECT id, order_id, merchant_id, pickup_longitude, pickup_latitude, delivery_longitude, delivery_latitude, distance, delivery_fee, expected_pickup_at, expires_at, priority, created_at FROM delivery_pool
WHERE id = $1 LIMIT 1
FOR UPDATE
`

func (q *Queries) GetDeliveryPoolItemForUpdate(ctx context.Context, id int64) (DeliveryPool, error) {
	row := q.db.QueryRow(ctx, getDeliveryPoolItemForUpdate, id)
	var i DeliveryPool
	err := row.Scan(
		&i.ID,
		&i.OrderID,
		&i.MerchantID,
		&i.PickupLongitude,
		&i.PickupLatitude,
		&i.DeliveryLongitude,
		&i.DeliveryLatitude,
		&i.Distance,
		&i.DeliveryFee,
		&i.ExpectedPickupAt,
		&i.ExpiresAt,
		&i.Priority,
		&i.CreatedAt,
	)
	return i, err
}

const listDeliveryPool = `-- name: ListDeliveryPool :many
SELECT id, order_id, merchant_id, pickup_longitude, pickup_latitude, delivery_longitude, delivery_latitude, distance, delivery_fee, expected_pickup_at, expires_at, priority, created_at,
    (priority + EXTRACT(EPOCH FROM (now() - created_at)) / 600)::int AS effective_priority
FROM delivery_pool
ORDER BY effective_priority DESC, created_at ASC
LIMIT $1 OFFSET $2
`

type ListDeliveryPoolParams struct {
	Limit  int32 `json:"limit"`
	Offset int32 `json:"offset"`
}

type ListDeliveryPoolRow struct {
	ID                int64          `json:"id"`
	OrderID           int64          `json:"order_id"`
	MerchantID        int64          `json:"merchant_id"`
	PickupLongitude   pgtype.Numeric `json:"pickup_longitude"`
	PickupLatitude    pgtype.Numeric `json:"pickup_latitude"`
	DeliveryLongitude pgtype.Numeric `json:"delivery_longitude"`
	DeliveryLatitude  pgtype.Numeric `json:"delivery_latitude"`
	Distance          int32          `json:"distance"`
	DeliveryFee       int64          `json:"delivery_fee"`
	ExpectedPickupAt  time.Time      `json:"expected_pickup_at"`
	ExpiresAt         time.Time      `json:"expires_at"`
	Priority          int32          `json:"priority"`
	CreatedAt         time.Time      `json:"created_at"`
	EffectivePriority int32          `json:"effective_priority"`
}

// 列出所有待接单的配送池订单
// 外卖订单始终可见直到被接单或取消
// 动态优先级 = 基础优先级 + 等待时间加成（每等待10分钟加1级）
func (q *Queries) ListDeliveryPool(ctx context.Context, arg ListDeliveryPoolParams) ([]ListDeliveryPoolRow, error) {
	rows, err := q.db.Query(ctx, listDeliveryPool, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []ListDeliveryPoolRow{}
	for rows.Next() {
		var i ListDeliveryPoolRow
		if err := rows.Scan(
			&i.ID,
			&i.OrderID,
			&i.MerchantID,
			&i.PickupLongitude,
			&i.PickupLatitude,
			&i.DeliveryLongitude,
			&i.DeliveryLatitude,
			&i.Distance,
			&i.DeliveryFee,
			&i.ExpectedPickupAt,
			&i.ExpiresAt,
			&i.Priority,
			&i.CreatedAt,
			&i.EffectivePriority,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listDeliveryPoolNearby = `-- name: ListDeliveryPoolNearby :many
SELECT id, order_id, merchant_id, pickup_longitude, pickup_latitude, delivery_longitude, delivery_latitude, distance, delivery_fee, expected_pickup_at, expires_at, priority, created_at, 
    (6371000 * acos(cos(radians($1::float8)) * cos(radians(pickup_latitude)) * 
    cos(radians(pickup_longitude) - radians($2::float8)) + 
    sin(radians($1::float8)) * sin(radians(pickup_latitude))))::int AS distance_to_rider,
    (priority + EXTRACT(EPOCH FROM (now() - created_at)) / 600)::int AS effective_priority
FROM delivery_pool
WHERE (6371000 * acos(cos(radians($1::float8)) * cos(radians(pickup_latitude)) * 
        cos(radians(pickup_longitude) - radians($2::float8)) + 
        sin(radians($1::float8)) * sin(radians(pickup_latitude)))) < $3::float8
ORDER BY distance_to_rider ASC
LIMIT $4::int
`

type ListDeliveryPoolNearbyParams struct {
	RiderLat    float64 `json:"rider_lat"`
	RiderLng    float64 `json:"rider_lng"`
	MaxDistance float64 `json:"max_distance"`
	ResultLimit int32   `json:"result_limit"`
}

type ListDeliveryPoolNearbyRow struct {
	ID                int64          `json:"id"`
	OrderID           int64          `json:"order_id"`
	MerchantID        int64          `json:"merchant_id"`
	PickupLongitude   pgtype.Numeric `json:"pickup_longitude"`
	PickupLatitude    pgtype.Numeric `json:"pickup_latitude"`
	DeliveryLongitude pgtype.Numeric `json:"delivery_longitude"`
	DeliveryLatitude  pgtype.Numeric `json:"delivery_latitude"`
	Distance          int32          `json:"distance"`
	DeliveryFee       int64          `json:"delivery_fee"`
	ExpectedPickupAt  time.Time      `json:"expected_pickup_at"`
	ExpiresAt         time.Time      `json:"expires_at"`
	Priority          int32          `json:"priority"`
	CreatedAt         time.Time      `json:"created_at"`
	DistanceToRider   int32          `json:"distance_to_rider"`
	EffectivePriority int32          `json:"effective_priority"`
}

// 按骑手位置获取附近的可接订单
// 动态优先级：等待越久优先级越高
func (q *Queries) ListDeliveryPoolNearby(ctx context.Context, arg ListDeliveryPoolNearbyParams) ([]ListDeliveryPoolNearbyRow, error) {
	rows, err := q.db.Query(ctx, listDeliveryPoolNearby,
		arg.RiderLat,
		arg.RiderLng,
		arg.MaxDistance,
		arg.ResultLimit,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []ListDeliveryPoolNearbyRow{}
	for rows.Next() {
		var i ListDeliveryPoolNearbyRow
		if err := rows.Scan(
			&i.ID,
			&i.OrderID,
			&i.MerchantID,
			&i.PickupLongitude,
			&i.PickupLatitude,
			&i.DeliveryLongitude,
			&i.DeliveryLatitude,
			&i.Distance,
			&i.DeliveryFee,
			&i.ExpectedPickupAt,
			&i.ExpiresAt,
			&i.Priority,
			&i.CreatedAt,
			&i.DistanceToRider,
			&i.EffectivePriority,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listDeliveryPoolNearbyByRegion = `-- name: ListDeliveryPoolNearbyByRegion :many
SELECT dp.id, dp.order_id, dp.merchant_id, dp.pickup_longitude, dp.pickup_latitude, dp.delivery_longitude, dp.delivery_latitude, dp.distance, dp.delivery_fee, dp.expected_pickup_at, dp.expires_at, dp.priority, dp.created_at, 
    (6371000 * acos(cos(radians($1::float8)) * cos(radians(dp.pickup_latitude)) * 
    cos(radians(dp.pickup_longitude) - radians($2::float8)) + 
    sin(radians($1::float8)) * sin(radians(dp.pickup_latitude))))::int AS distance_to_rider,
    (dp.priority + EXTRACT(EPOCH FROM (now() - dp.created_at)) / 600)::int AS effective_priority
FROM delivery_pool dp
JOIN merchants m ON dp.merchant_id = m.id
WHERE m.region_id = $3::bigint
    AND (6371000 * acos(cos(radians($1::float8)) * cos(radians(dp.pickup_latitude)) * 
        cos(radians(dp.pickup_longitude) - radians($2::float8)) + 
        sin(radians($1::float8)) * sin(radians(dp.pickup_latitude)))) < $4::float8
ORDER BY distance_to_rider ASC
LIMIT $5::int
`

type ListDeliveryPoolNearbyByRegionParams struct {
	RiderLat    float64 `json:"rider_lat"`
	RiderLng    float64 `json:"rider_lng"`
	RegionID    int64   `json:"region_id"`
	MaxDistance float64 `json:"max_distance"`
	ResultLimit int32   `json:"result_limit"`
}

type ListDeliveryPoolNearbyByRegionRow struct {
	ID                int64          `json:"id"`
	OrderID           int64          `json:"order_id"`
	MerchantID        int64          `json:"merchant_id"`
	PickupLongitude   pgtype.Numeric `json:"pickup_longitude"`
	PickupLatitude    pgtype.Numeric `json:"pickup_latitude"`
	DeliveryLongitude pgtype.Numeric `json:"delivery_longitude"`
	DeliveryLatitude  pgtype.Numeric `json:"delivery_latitude"`
	Distance          int32          `json:"distance"`
	DeliveryFee       int64          `json:"delivery_fee"`
	ExpectedPickupAt  time.Time      `json:"expected_pickup_at"`
	ExpiresAt         time.Time      `json:"expires_at"`
	Priority          int32          `json:"priority"`
	CreatedAt         time.Time      `json:"created_at"`
	DistanceToRider   int32          `json:"distance_to_rider"`
	EffectivePriority int32          `json:"effective_priority"`
}

// 按区域过滤的骑手可接订单列表，实现多租户隔离
// 骑手只能看到其所属区域内商户的订单
// 距离越近排名越靠前，同时返回动态优先级供前端展示
func (q *Queries) ListDeliveryPoolNearbyByRegion(ctx context.Context, arg ListDeliveryPoolNearbyByRegionParams) ([]ListDeliveryPoolNearbyByRegionRow, error) {
	rows, err := q.db.Query(ctx, listDeliveryPoolNearbyByRegion,
		arg.RiderLat,
		arg.RiderLng,
		arg.RegionID,
		arg.MaxDistance,
		arg.ResultLimit,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []ListDeliveryPoolNearbyByRegionRow{}
	for rows.Next() {
		var i ListDeliveryPoolNearbyByRegionRow
		if err := rows.Scan(
			&i.ID,
			&i.OrderID,
			&i.MerchantID,
			&i.PickupLongitude,
			&i.PickupLatitude,
			&i.DeliveryLongitude,
			&i.DeliveryLatitude,
			&i.Distance,
			&i.DeliveryFee,
			&i.ExpectedPickupAt,
			&i.ExpiresAt,
			&i.Priority,
			&i.CreatedAt,
			&i.DistanceToRider,
			&i.EffectivePriority,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const removeExpiredFromDeliveryPool = `-- name: RemoveExpiredFromDeliveryPool :exec
DELETE FROM delivery_pool
WHERE expires_at < now()
`

// 清理已过期订单池项（用于订单取消等情况，expires_at不再用于可见性过滤）
func (q *Queries) RemoveExpiredFromDeliveryPool(ctx context.Context) error {
	_, err := q.db.Exec(ctx, removeExpiredFromDeliveryPool)
	return err
}

const removeFromDeliveryPool = `-- name: RemoveFromDeliveryPool :exec
DELETE FROM delivery_pool
WHERE order_id = $1
`

func (q *Queries) RemoveFromDeliveryPool(ctx context.Context, orderID int64) error {
	_, err := q.db.Exec(ctx, removeFromDeliveryPool, orderID)
	return err
}
