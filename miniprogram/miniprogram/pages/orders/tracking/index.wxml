<custom-navbar title="配送追踪" showBack="{{true}}" bind:navheight="onNavHeight" />

<view class="page" style="padding-top: {{navBarHeight}}px;">
  <!-- 加载中 -->
  <t-loading wx:if="{{loading}}" theme="circular" size="40rpx" class="loading" />

  <block wx:if="{{!loading && delivery}}">
    <!-- 地图 -->
    <view class="hero-card">
      <map
        id="routeMap"
        class="hero-map"
        longitude="{{mapCenter.longitude}}"
        latitude="{{mapCenter.latitude}}"
        scale="{{scale}}"
        markers="{{markers}}"
        polyline="{{polyline}}"
        include-points="{{includePoints}}"
        show-location
        enable-3D
        enable-zoom
        enable-scroll
      />
    </view>

    <!-- 配送状态 -->
    <view class="status-card">
      <view class="status-main">
        <t-icon name="delivery" size="48rpx" color="#1d63ff" />
        <view class="status-text">{{deliveryStatusText}}</view>
      </view>
      <view class="eta">预计 {{estimatedDeliveryTime}} 送达</view>
    </view>

    <!-- 骑手信息 -->
    <view class="rider-card" wx:if="{{riderPhone}}">
      <view class="rider-info">
        <image class="avatar" src="/assets/rider.png" mode="aspectFill" />
        <view>
          <view class="rider-name">{{riderName}}</view>
          <view class="rider-desc">{{riderPhoneDisplay}}</view>
        </view>
      </view>
      <view class="rider-actions">
        <button class="primary" bindtap="onCallRider">联系骑手</button>
      </view>
    </view>

    <!-- 配送进度 -->
    <view class="progress-card">
      <view class="card-title">配送进度</view>
      <view class="progress-list">
        <view 
          wx:for="{{progress}}" 
          wx:key="title" 
          class="progress-item {{item.done ? 'done' : ''}} {{item.active ? 'active' : ''}}"
        >
          <view class="progress-dot"></view>
          <view class="progress-line" wx:if="{{index < progress.length - 1}}"></view>
          <view class="progress-content">
            <view class="progress-title">{{item.title}}</view>
            <view class="progress-time" wx:if="{{item.time}}">{{item.time}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 配送地址 -->
    <view class="address-card">
      <view class="address-row">
        <view class="address-icon merchant"></view>
        <view class="address-info">
          <view class="address-label">取餐地址</view>
          <view class="address-text">{{delivery.pickup_address}}</view>
        </view>
      </view>
      <view class="address-row">
        <view class="address-icon customer"></view>
        <view class="address-info">
          <view class="address-label">送餐地址</view>
          <view class="address-text">{{delivery.delivery_address}}</view>
        </view>
      </view>
    </view>

    <!-- 刷新按钮 -->
    <view class="refresh-btn" bindtap="onRefresh">
      <t-icon name="refresh" size="32rpx" />
      <text>刷新位置</text>
    </view>
  </block>

  <!-- 无配送信息 -->
  <view wx:if="{{!loading && !delivery}}" class="empty">
    <t-empty description="暂无配送信息" />
  </view>
</view>
