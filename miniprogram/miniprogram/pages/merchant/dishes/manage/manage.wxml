<!--å•†æˆ·èœå“ç®¡ç†é¡µé¢-->
<view class="dish-manage-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">æ­£åœ¨åŠ è½½èœå“...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else class="main-content">
    <!-- æœç´¢å’Œç­›é€‰æ  -->
    <view class="search-filter-bar">
      <view class="search-box">
        <input 
          class="search-input" 
          placeholder="æœç´¢èœå“åç§°..." 
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
        />
        <text class="search-icon">ğŸ”</text>
      </view>
      
      <picker class="filter-picker" bindchange="onFilterChange" value="{{filterStatus}}" range-key="label" range="{{[{value:'all',label:'å…¨éƒ¨'},{value:'available',label:'å·²ä¸Šæ¶'},{value:'unavailable',label:'å·²ä¸‹æ¶'}]}}">
        <view class="filter-btn">
          <text class="filter-text">ç­›é€‰</text>
          <text class="filter-arrow">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- åˆ†ç±»å¯¼èˆª -->
    <scroll-view class="category-nav" scroll-x="true">
      <view class="category-list">
        <view 
          wx:for="{{categories}}" 
          wx:key="id"
          class="category-item {{currentCategoryId === item.id ? 'active' : ''}}"
          data-id="{{item.id}}"
          bindtap="switchCategory"
        >
          <text class="category-name">{{item.name}}</text>
        </view>
      </view>
    </scroll-view>

    <!-- æ“ä½œæ  -->
    <view class="action-bar">
      <view class="left-actions">
        <button class="action-btn primary" bindtap="addDish">
          <text class="btn-icon">+</text>
          <text class="btn-text">æ·»åŠ èœå“</text>
        </button>
        
        <button class="action-btn {{selectionMode ? 'active' : ''}}" bindtap="toggleSelectionMode">
          <text class="btn-icon">â˜‘</text>
          <text class="btn-text">{{selectionMode ? 'å–æ¶ˆé€‰æ‹©' : 'æ‰¹é‡æ“ä½œ'}}</text>
        </button>
      </view>
      
      <view wx:if="{{selectionMode}}" class="batch-actions">
        <button class="batch-btn" data-operation="enable" bindtap="batchOperation">ä¸Šæ¶</button>
        <button class="batch-btn" data-operation="disable" bindtap="batchOperation">ä¸‹æ¶</button>
        <button class="batch-btn danger" data-operation="delete" bindtap="batchOperation">åˆ é™¤</button>
      </view>
    </view>

    <!-- å…¨é€‰æ  -->
    <view wx:if="{{selectionMode}}" class="select-all-bar">
      <view class="select-all-checkbox" bindtap="toggleSelectAll">
        <text class="checkbox {{selectedDishes.length === dishes.length && dishes.length > 0 ? 'checked' : ''}}">{{selectedDishes.length === dishes.length && dishes.length > 0 ? 'â˜‘' : 'â˜'}}</text>
        <text class="select-text">å…¨é€‰ ({{selectedDishes.length}}/{{dishes.length}})</text>
      </view>
    </view>

    <!-- èœå“åˆ—è¡¨ -->
    <scroll-view class="dish-list" scroll-y="true" refresher-enabled="{{true}}" refresher-triggered="{{refreshing}}" bindrefresherrefresh="refreshData">
      <view wx:if="{{dishes.length === 0}}" class="empty-state">
        <image class="empty-icon" src="/assets/icons/empty-dish.png" mode="aspectFit"></image>
        <text class="empty-text">æš‚æ— èœå“</text>
        <button class="empty-action" bindtap="addDish">æ·»åŠ ç¬¬ä¸€ä¸ªèœå“</button>
      </view>
      
      <view wx:else class="dish-items">
        <view 
          wx:for="{{dishes}}" 
          wx:key="id"
          class="dish-item {{selectionMode ? 'selection-mode' : ''}}"
        >
          <!-- é€‰æ‹©æ¡† -->
          <view wx:if="{{selectionMode}}" class="selection-checkbox" data-id="{{item.id}}" bindtap="toggleDishSelection">
            <text class="checkbox {{selectedDishes.indexOf(item.id) > -1 ? 'checked' : ''}}">{{selectedDishes.indexOf(item.id) > -1 ? 'â˜‘' : 'â˜'}}</text>
          </view>
          
          <!-- èœå“ä¿¡æ¯ -->
          <view class="dish-content">
            <image class="dish-image" src="{{item.image_url}}" mode="aspectFill"></image>
            
            <view class="dish-info">
              <view class="dish-header">
                <text class="dish-name">{{item.name}}</text>
                <view class="dish-status">
                  <text class="status-badge {{item.is_available ? 'available' : 'unavailable'}}">
                    {{item.is_available ? 'å·²ä¸Šæ¶' : 'å·²ä¸‹æ¶'}}
                  </text>
                </view>
              </view>
              
              <text class="dish-description">{{item.description}}</text>
              
              <view class="dish-stats">
                <text class="dish-category">{{item.category_name}}</text>
                <text class="dish-sales">æœˆå”®{{item.sales_count}}</text>
                <text class="dish-rating">â­{{item.rating}}</text>
              </view>
              
              <view class="dish-price-row">
                <view class="price-info">
                  <text class="current-price">Â¥{{item.price}}</text>
                  <text wx:if="{{item.original_price && item.original_price > item.price}}" class="original-price">Â¥{{item.original_price}}</text>
                </view>
                
                <view wx:if="{{item.inventory_count !== undefined}}" class="inventory-info">
                  <text class="inventory-label">åº“å­˜:</text>
                  <text class="inventory-count">{{item.inventory_count}}</text>
                </view>
              </view>
            </view>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <view wx:if="{{!selectionMode}}" class="dish-actions">
              <button class="action-icon-btn" data-id="{{item.id}}" bindtap="editDish">
                <text class="action-icon">âœï¸</text>
              </button>
              
              <button class="action-icon-btn" data-id="{{item.id}}" bindtap="manageInventory">
                <text class="action-icon">ğŸ“¦</text>
              </button>
              
              <button 
                class="action-icon-btn" 
                data-id="{{item.id}}" 
                data-available="{{item.is_available}}"
                bindtap="toggleDishStatus"
              >
                <text class="action-icon">{{item.is_available ? 'â¬‡ï¸' : 'â¬†ï¸'}}</text>
              </button>
              
              <button class="action-icon-btn danger" data-id="{{item.id}}" bindtap="deleteDish">
                <text class="action-icon">ğŸ—‘ï¸</text>
              </button>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- ç¼–è¾‘èœå“å¼¹çª— -->
  <view wx:if="{{showEditModal}}" class="modal-overlay">
    <view class="modal-content edit-modal">
      <view class="modal-header">
        <text class="modal-title">{{editingDish ? 'ç¼–è¾‘èœå“' : 'æ·»åŠ èœå“'}}</text>
        <button class="modal-close" bindtap="closeEditModal">Ã—</button>
      </view>
      
      <scroll-view class="modal-body" scroll-y="true">
        <!-- èœå“å›¾ç‰‡ -->
        <view class="form-group">
          <text class="form-label">èœå“å›¾ç‰‡ *</text>
          <view class="image-upload" bindtap="chooseImage">
            <image wx:if="{{editForm.image_url}}" class="upload-preview" src="{{editForm.image_url}}" mode="aspectFill"></image>
            <view wx:else class="upload-placeholder">
              <text class="upload-icon">ğŸ“·</text>
              <text class="upload-text">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</text>
            </view>
          </view>
        </view>
        
        <!-- èœå“åç§° -->
        <view class="form-group">
          <text class="form-label">èœå“åç§° *</text>
          <input 
            class="form-input" 
            placeholder="è¯·è¾“å…¥èœå“åç§°"
            value="{{editForm.name}}"
            data-field="name"
            bindinput="onFormInput"
          />
        </view>
        
        <!-- èœå“æè¿° -->
        <view class="form-group">
          <text class="form-label">èœå“æè¿°</text>
          <textarea 
            class="form-textarea" 
            placeholder="è¯·è¾“å…¥èœå“æè¿°"
            value="{{editForm.description}}"
            data-field="description"
            bindinput="onFormInput"
          ></textarea>
        </view>
        
        <!-- åˆ†ç±»é€‰æ‹© -->
        <view class="form-group">
          <text class="form-label">èœå“åˆ†ç±» *</text>
          <picker class="form-picker" bindchange="onCategoryChange" value="{{editForm.category_id}}" range="{{categories.slice(1)}}" range-key="name" range-value="id">
            <view class="picker-display">
              <text class="picker-text">{{editForm.category_name || 'è¯·é€‰æ‹©åˆ†ç±»'}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
        
        <!-- ä»·æ ¼è®¾ç½® -->
        <view class="form-row">
          <view class="form-group half">
            <text class="form-label">ç°ä»· *</text>
            <input 
              class="form-input" 
              type="digit"
              placeholder="0.00"
              value="{{editForm.price}}"
              data-field="price"
              bindinput="onFormInput"
            />
          </view>
          
          <view class="form-group half">
            <text class="form-label">åŸä»·</text>
            <input 
              class="form-input" 
              type="digit"
              placeholder="0.00"
              value="{{editForm.original_price}}"
              data-field="original_price"
              bindinput="onFormInput"
            />
          </view>
        </view>
      </scroll-view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeEditModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="saveDish">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- åº“å­˜ç®¡ç†å¼¹çª— -->
  <view wx:if="{{showInventoryModal}}" class="modal-overlay">
    <view class="modal-content inventory-modal">
      <view class="modal-header">
        <text class="modal-title">åº“å­˜ç®¡ç†</text>
        <button class="modal-close" bindtap="closeInventoryModal">Ã—</button>
      </view>
      
      <view class="modal-body">
        <view class="inventory-info">
          <text class="dish-name">{{inventoryForm.dish_name}}</text>
          <text class="current-inventory">å½“å‰åº“å­˜: {{inventoryForm.current_count}}</text>
        </view>
        
        <view class="form-group">
          <text class="form-label">è°ƒæ•´æ•°é‡ *</text>
          <input 
            class="form-input" 
            type="number"
            placeholder="æ­£æ•°ä¸ºå¢åŠ ï¼Œè´Ÿæ•°ä¸ºå‡å°‘"
            value="{{inventoryForm.adjustment}}"
            data-field="adjustment"
            bindinput="onInventoryInput"
          />
        </view>
        
        <view class="form-group">
          <text class="form-label">è°ƒæ•´åŸå›  *</text>
          <textarea 
            class="form-textarea" 
            placeholder="è¯·è¾“å…¥è°ƒæ•´åŸå› "
            value="{{inventoryForm.reason}}"
            data-field="reason"
            bindinput="onInventoryInput"
          ></textarea>
        </view>
        
        <view class="inventory-preview">
          <text class="preview-label">è°ƒæ•´ååº“å­˜:</text>
          <text class="preview-value">{{inventoryForm.current_count + inventoryForm.adjustment}}</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeInventoryModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="saveInventoryAdjustment">ç¡®è®¤è°ƒæ•´</button>
      </view>
    </view>
  </view>
</view>