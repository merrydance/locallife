<!-- å¥—é¤ç®¡ç† - æ¡Œé¢çº§ SaaS ç•Œé¢ï¼ˆä¸¤æ å¸ƒå±€ï¼‰ -->

<!-- WXS æ¨¡å— - å¤„ç†æ•°ç»„æ“ä½œ -->
<wxs module="utils">
  module.exports = {
    contains: function(arr, id) {
      if (!arr || !arr.length) return false;
      for (var i = 0; i < arr.length; i++) {
        if (arr[i] === id) return true;
      }
      return false;
    }
  }
</wxs>

<match-media max-width="1599">
  <view class="desktop-only-notice">
    <view class="notice-box">
      <view class="notice-icon">ğŸ–¥ï¸</view>
      <text class="notice-title">æ­¤åŠŸèƒ½éœ€è¦åœ¨ç”µè„‘ç«¯ä½¿ç”¨</text>
      <text class="notice-desc">è¯·ä½¿ç”¨ 1600px ä»¥ä¸Šåˆ†è¾¨ç‡çš„æ˜¾ç¤ºå™¨è®¿é—®å¥—é¤ç®¡ç†</text>
      <button class="btn-back" bindtap="goBack">è¿”å›å·¥ä½œå°</button>
    </view>
  </view>
</match-media>

<match-media min-width="1600">
  <view class="saas-layout">
    <!-- ä¾§è¾¹æ  -->

    <!-- ä¸»åŒºåŸŸ -->
    <view class="main-area" style="margin-left: 0;">
      <!-- é¡¶éƒ¨æ  -->
      <merchant-header 
        merchant-name="{{merchantName}}"
        is-open="{{isOpen}}"
      />

      <!-- é¡µé¢å†…å®¹ - ä¸¤æ å¸ƒå±€ -->
      <view class="page-container combo-page">
        <!-- å·¦ä¾§å¥—é¤åˆ—è¡¨åŒº -->
        <view class="combo-list-panel">
          <!-- å·¥å…·æ  -->
          <view class="panel-header">
            <text class="panel-title">å¥—é¤åˆ—è¡¨ ({{combos.length}})</text>
            <button class="btn-add" bindtap="onAddCombo">+ æ·»åŠ å¥—é¤</button>
          </view>

          <!-- æœç´¢æ¡† -->
          <view class="search-bar">
            <input 
              class="search-input" 
              placeholder="æœç´¢å¥—é¤åç§°..." 
              value="{{searchKeyword}}"
              bindinput="onSearch"
            />
          </view>

          <!-- åˆ—è¡¨ -->
          <view class="combo-list-scroll">
            <view wx:if="{{loading}}" class="loading-state">
              <text>åŠ è½½ä¸­...</text>
            </view>
            <view wx:elif="{{filteredCombos.length === 0}}" class="empty-state">
              <text class="empty-icon">ğŸ“¦</text>
              <text class="empty-text">æš‚æ— å¥—é¤</text>
              <text class="empty-hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªå¥—é¤</text>
            </view>
            <view wx:else class="combo-cards">
              <view 
                wx:for="{{filteredCombos}}" 
                wx:key="id" 
                class="combo-card {{selectedCombo.id === item.id ? 'selected' : ''}}"
                bindtap="onSelectCombo"
                data-item="{{item}}"
              >
                <view class="combo-card-main">
                  <view class="combo-name-row">
                    <text class="combo-name">{{item.name}}</text>
                    <view class="combo-status {{item.is_online ? 'online' : 'offline'}}">
                      {{item.is_online ? 'åœ¨å”®' : 'ä¸‹æ¶'}}
                    </view>
                  </view>
                  <view class="combo-meta">
                    <text class="combo-price">Â¥{{item.comboPriceDisplay}}</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- å³ä¾§ç¼–è¾‘é¢æ¿ -->
        <view class="editor-panel">
          <view wx:if="{{!selectedCombo && !isAdding}}" class="editor-placeholder">
            <text class="placeholder-icon">ğŸ‘†</text>
            <text class="placeholder-text">é€‰æ‹©å¥—é¤è¿›è¡Œç¼–è¾‘</text>
          </view>

          <view wx:else class="editor-content">
            <view class="editor-header">
              <text class="editor-title">{{isAdding ? 'æ·»åŠ å¥—é¤' : 'ç¼–è¾‘å¥—é¤'}}</text>
              <view class="editor-actions">
                <button class="btn-cancel" bindtap="onCancelEdit">å–æ¶ˆ</button>
                <button class="btn-save" bindtap="onSaveCombo" disabled="{{saving}}">
                  {{saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}}
                </button>
              </view>
            </view>

            <view class="editor-form">
              <!-- åŸºæœ¬ä¿¡æ¯ -->
              <view class="form-section">
                <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
                
                <view class="form-group">
                  <label class="form-label">å¥—é¤åç§° <text class="required">*</text></label>
                  <input 
                    class="form-input" 
                    placeholder="è¯·è¾“å…¥å¥—é¤åç§°" 
                    value="{{selectedCombo.name}}"
                    data-field="name"
                    bindinput="onFieldChange"
                  />
                </view>

                <view class="form-group">
                  <label class="form-label">å¥—é¤æè¿°</label>
                  <textarea 
                    class="form-textarea" 
                    placeholder="è¯·è¾“å…¥å¥—é¤æè¿°ï¼ˆé€‰å¡«ï¼‰" 
                    value="{{selectedCombo.description}}"
                    data-field="description"
                    bindinput="onFieldChange"
                    maxlength="500"
                  />
                </view>
              </view>

              <!-- ä»·æ ¼è®¾ç½® -->
              <view class="form-section">
                <view class="section-title">ä»·æ ¼è®¾ç½®</view>
                
                <view class="form-row">
                  <view class="form-group flex-1">
                    <label class="form-label">å¥—é¤ä»·æ ¼ (å…ƒ) <text class="required">*</text></label>
                    <input 
                      class="form-input" 
                      type="digit" 
                      placeholder="0.00" 
                      value="{{selectedCombo.combo_price ? selectedCombo.combo_price / 100 : ''}}"
                      data-field="combo_price"
                      bindinput="onPriceFieldChange"
                    />
                  </view>
                  <view class="form-group flex-1">
                    <label class="form-label">åŸä»·å‚è€ƒ (å…ƒ)</label>
                    <input 
                      class="form-input" 
                      type="digit" 
                      placeholder="è‡ªåŠ¨è®¡ç®—"
                      value="{{originalPrice}}"
                      disabled
                    />
                  </view>
                </view>
              </view>

              <!-- çŠ¶æ€è®¾ç½® -->
              <view class="form-section">
                <view class="section-title">çŠ¶æ€è®¾ç½®</view>
                
                <view class="form-group horizontal">
                  <label class="form-label">ä¸Šæ¶é”€å”®</label>
                  <view 
                    class="toggle {{selectedCombo.is_online ? 'on' : ''}}" 
                    bindtap="onToggleOnline"
                  >
                    <view class="toggle-handle"></view>
                  </view>
                </view>
              </view>

              <!-- å±æ€§æ ‡ç­¾ -->
              <view class="form-section">
                <view class="section-title">å±æ€§æ ‡ç­¾</view>
                <view class="tags-container">
                  <view 
                    wx:for="{{availableTags}}" 
                    wx:key="id" 
                    class="tag-item {{utils.contains(selectedTagIds, item.id) ? 'selected' : ''}}"
                    bindtap="onTagToggle"
                    data-id="{{item.id}}"
                  >
                    <text class="tag-name">{{item.name}}</text>
                    <text class="tag-check" wx:if="{{utils.contains(selectedTagIds, item.id)}}">âœ“</text>
                  </view>
                  <view wx:if="{{availableTags.length === 0}}" class="tags-empty">
                    <text>æš‚æ— å¯ç”¨æ ‡ç­¾</text>
                  </view>
                </view>
              </view>

              <!-- å¥—é¤å†…èœå“ -->
              <view class="form-section">
                <view class="section-title-row">
                  <view class="section-title" style="margin-bottom: 0;">å¥—é¤å†…èœå“</view>
                  <button class="btn-add-dish" bindtap="onOpenDishPicker">+ æ·»åŠ èœå“</button>
                </view>
                
                <view class="combo-dishes-list">
                  <view wx:if="{{!selectedCombo.dishes || selectedCombo.dishes.length === 0}}" class="empty-dishes">
                    <text class="empty-dishes-text">æš‚æœªæ·»åŠ èœå“ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </text>
                  </view>
                  <view 
                    wx:for="{{selectedCombo.dishes}}" 
                    wx:key="dish_id" 
                    class="combo-dish-item"
                  >
                    <view class="combo-dish-info">
                      <text class="combo-dish-name">{{item.dish_name}}</text>
                      <text class="combo-dish-qty">x{{item.quantity || 1}}</text>
                      <text class="combo-dish-price">Â¥{{item.dishPriceDisplay}}</text>
                    </view>
                    <view class="combo-dish-remove" bindtap="onRemoveDish" data-id="{{item.dish_id}}">âœ•</view>
                  </view>
                </view>
              </view>

              <!-- åˆ é™¤æŒ‰é’® -->
              <view wx:if="{{!isAdding && selectedCombo.id}}" class="form-section">
                <button class="btn-danger" bindtap="onDeleteCombo">åˆ é™¤æ­¤å¥—é¤</button>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</match-media>

<!-- èœå“é€‰æ‹©å¼¹çª— -->
<view class="modal-mask {{showDishPicker ? 'visible' : ''}}" bindtap="onCloseDishPicker"></view>
<view class="modal-panel dish-picker-panel {{showDishPicker ? 'visible' : ''}}" catchtap="">
  <view class="modal-header">
    <text class="modal-title">é€‰æ‹©èœå“ <text wx:if="{{pickerDishCount > 0}}" class="selected-count">(å·²é€‰ {{pickerDishCount}} ä¸ª)</text></text>
    <view class="modal-close" bindtap="onCloseDishPicker">âœ•</view>
  </view>
  <view class="modal-body">
    <!-- æœç´¢æ¡† -->
    <view class="picker-search">
      <input 
        class="form-input" 
        placeholder="æœç´¢èœå“åç§°..." 
        value="{{dishSearchKeyword}}"
        bindinput="onDishSearch"
      />
    </view>
    
    <!-- èœå“åˆ—è¡¨ -->
    <view class="picker-dish-list">
      <view 
        wx:for="{{filteredDishes}}" 
        wx:key="id" 
        class="picker-dish-item {{item.quantity > 0 ? 'selected' : ''}}"
      >
        <view class="picker-dish-info" bindtap="onToggleDish" data-item="{{item}}">
          <text class="picker-dish-name">{{item.name}}</text>
          <text class="picker-dish-price">Â¥{{item.priceDisplay}}</text>
        </view>
        <!-- æ•°é‡é€‰æ‹©å™¨ -->
        <view class="quantity-control">
          <view 
            class="qty-btn {{item.quantity > 0 ? '' : 'disabled'}}" 
            catchtap="onDecreaseDishQty" 
            data-id="{{item.id}}"
          >âˆ’</view>
          <text class="qty-value">{{item.quantity || 0}}</text>
          <view 
            class="qty-btn" 
            catchtap="onIncreaseDishQty" 
            data-id="{{item.id}}"
          >+</view>
        </view>
      </view>
      <view wx:if="{{filteredDishes.length === 0}}" class="picker-empty">
        <text>æš‚æ— å¯é€‰èœå“</text>
      </view>
    </view>
  </view>
  <view class="modal-footer">
    <button class="btn-cancel" bindtap="onCloseDishPicker">å–æ¶ˆ</button>
    <button class="btn-primary" bindtap="onConfirmDishSelection" disabled="{{pickerDishCount === 0}}">
      ç¡®è®¤æ·»åŠ  ({{pickerDishCount}})
    </button>
  </view>
</view>
