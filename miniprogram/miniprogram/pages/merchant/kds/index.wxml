<!--
  KDS å¨æˆ¿æ˜¾ç¤ºç³»ç»Ÿ - å…¨å±ä¸‰æ çœ‹æ¿
  ä¸“ä¸ºå¤§å±è®¾è®¡ï¼Œé«˜å¯¹æ¯”åº¦ï¼Œå¤§å­—ä½“
-->
<view class="kds-container">
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <view class="kds-header">
    <view class="header-left">
      <text class="kds-title">ğŸ³ å¨æˆ¿æ˜¾ç¤ºç³»ç»Ÿ</text>
      <view class="status-indicator {{connected ? 'online' : 'offline'}}">
        <view class="status-dot"></view>
        <text>{{connected ? 'å·²è¿æ¥' : 'ç¦»çº¿'}}</text>
      </view>
    </view>

    <view class="header-center">
      <view class="stats-row">
        <view class="stat-badge new">å¾…åˆ¶ä½œ {{stats.new_count || 0}}</view>
        <view class="stat-badge preparing">åˆ¶ä½œä¸­ {{stats.preparing_count || 0}}</view>
        <view class="stat-badge ready">å¾…å–é¤ {{stats.ready_count || 0}}</view>
        <view class="stat-badge completed">ä»Šæ—¥å®Œæˆ {{stats.completed_today_count || 0}}</view>
      </view>
    </view>

    <view class="header-right">
      <text class="current-time">{{currentTime}}</text>
      <view class="header-actions">
        <view class="action-btn {{voiceEnabled ? 'active' : ''}}" bindtap="onToggleVoice">
          <text>ğŸ”Š</text>
        </view>
        <view class="action-btn {{autoRefresh ? 'active' : ''}}" bindtap="onToggleAutoRefresh">
          <text>ğŸ”„</text>
        </view>
        <view class="action-btn" bindtap="onRefresh">
          <text>åˆ·æ–°</text>
        </view>
        <view class="action-btn exit" bindtap="onExit">
          <text>é€€å‡º</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-overlay">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸‰æ çœ‹æ¿ -->
  <view class="kanban-board" wx:else>
    <!-- æ–°è®¢å•åˆ— -->
    <view class="kanban-column new-column">
      <view class="column-header">
        <view class="column-indicator new"></view>
        <text class="column-title">æ–°è®¢å•</text>
        <text class="column-count">{{newOrders.length}}</text>
      </view>
      
      <scroll-view class="column-content" scroll-y enhanced show-scrollbar="{{false}}">
        <view wx:if="{{newOrders.length === 0}}" class="empty-state">
          <text class="empty-icon">ğŸ“­</text>
          <text class="empty-text">æš‚æ— æ–°è®¢å•</text>
        </view>

        <view 
          wx:for="{{newOrders}}" 
          wx:key="id" 
          class="order-card new-card {{item.is_urged ? 'urged' : ''}}"
          data-order="{{item}}"
          bindtap="onViewOrder"
        >
          <view class="card-top">
            <text class="order-no">#{{item.order_no}}</text>
            <view class="order-type-badge">{{item.order_type_text}}</view>
          </view>

          <view class="card-table" wx:if="{{item.table_no}}">
            <text class="table-label">æ¡Œå·</text>
            <text class="table-no">{{item.table_no}}</text>
          </view>

          <view class="card-items">
            <view wx:for="{{item.items}}" wx:for-item="dish" wx:key="id" class="dish-row">
              <text class="dish-name">{{dish.name}}</text>
              <text class="dish-qty">Ã—{{dish.quantity}}</text>
            </view>
          </view>

          <view class="card-notes" wx:if="{{item.notes}}">
            <text class="notes-icon">ğŸ“</text>
            <text class="notes-text">{{item.notes}}</text>
          </view>

          <view class="card-bottom">
            <text class="order-time">{{item.paid_time || item.created_time}}</text>
            <text class="wait-time">ç­‰å¾… {{item.waiting_minutes}}åˆ†</text>
          </view>

          <view class="card-action" catchtap="onStartPreparing" data-id="{{item.id}}">
            <text>å¼€å§‹åˆ¶ä½œ</text>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- åˆ¶ä½œä¸­åˆ— -->
    <view class="kanban-column preparing-column">
      <view class="column-header">
        <view class="column-indicator preparing"></view>
        <text class="column-title">åˆ¶ä½œä¸­</text>
        <text class="column-count">{{preparingOrders.length}}</text>
      </view>

      <scroll-view class="column-content" scroll-y enhanced show-scrollbar="{{false}}">
        <view wx:if="{{preparingOrders.length === 0}}" class="empty-state">
          <text class="empty-icon">ğŸ³</text>
          <text class="empty-text">æš‚æ— åˆ¶ä½œä¸­è®¢å•</text>
        </view>

        <view 
          wx:for="{{preparingOrders}}" 
          wx:key="id" 
          class="order-card preparing-card {{item.is_urged ? 'urged' : ''}}"
          data-order="{{item}}"
          bindtap="onViewOrder"
        >
          <view class="card-top">
            <text class="order-no">#{{item.order_no}}</text>
            <view class="order-type-badge">{{item.order_type_text}}</view>
          </view>

          <view class="card-table" wx:if="{{item.table_no}}">
            <text class="table-label">æ¡Œå·</text>
            <text class="table-no">{{item.table_no}}</text>
          </view>

          <view class="card-items">
            <view wx:for="{{item.items}}" wx:for-item="dish" wx:key="id" class="dish-row">
              <text class="dish-name">{{dish.name}}</text>
              <text class="dish-qty">Ã—{{dish.quantity}}</text>
            </view>
          </view>

          <view class="card-notes" wx:if="{{item.notes}}">
            <text class="notes-icon">ğŸ“</text>
            <text class="notes-text">{{item.notes}}</text>
          </view>

          <view class="card-bottom">
            <text class="order-time">å¼€å§‹: {{item.paid_time}}</text>
            <text class="wait-time urgent">{{item.waiting_minutes}}åˆ†</text>
          </view>

          <view class="card-action ready-action" catchtap="onMarkReady" data-id="{{item.id}}">
            <text>âœ“ åˆ¶ä½œå®Œæˆ</text>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- å¾…å–é¤åˆ— -->
    <view class="kanban-column ready-column">
      <view class="column-header">
        <view class="column-indicator ready"></view>
        <text class="column-title">å¾…å–é¤</text>
        <text class="column-count">{{readyOrders.length}}</text>
      </view>

      <scroll-view class="column-content" scroll-y enhanced show-scrollbar="{{false}}">
        <view wx:if="{{readyOrders.length === 0}}" class="empty-state">
          <text class="empty-icon">âœ…</text>
          <text class="empty-text">æš‚æ— å¾…å–é¤è®¢å•</text>
        </view>

        <view 
          wx:for="{{readyOrders}}" 
          wx:key="id" 
          class="order-card ready-card"
          data-order="{{item}}"
          bindtap="onViewOrder"
        >
          <view class="card-top">
            <text class="order-no">#{{item.order_no}}</text>
            <view class="order-type-badge">{{item.order_type_text}}</view>
          </view>

          <view class="card-table" wx:if="{{item.table_no}}">
            <text class="table-label">æ¡Œå·</text>
            <text class="table-no">{{item.table_no}}</text>
          </view>

          <view class="card-items">
            <view wx:for="{{item.items}}" wx:for-item="dish" wx:key="id" class="dish-row">
              <text class="dish-name">{{dish.name}}</text>
              <text class="dish-qty">Ã—{{dish.quantity}}</text>
            </view>
          </view>

          <view class="card-bottom">
            <text class="order-time">å®Œæˆ</text>
            <view class="ready-badge">å·²å‡ºé¤</view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- è®¢å•è¯¦æƒ…å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showOrderDetail}}" catchtap="onCloseDetail">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">è®¢å•è¯¦æƒ…</text>
        <view class="modal-close" bindtap="onCloseDetail">âœ•</view>
      </view>

      <view class="modal-body" wx:if="{{selectedOrder}}">
        <view class="detail-section">
          <view class="detail-row">
            <text class="detail-label">è®¢å•å·</text>
            <text class="detail-value">{{selectedOrder.order_no}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">è®¢å•ç±»å‹</text>
            <text class="detail-value">{{selectedOrder.order_type_text}}</text>
          </view>
          <view class="detail-row" wx:if="{{selectedOrder.table_no}}">
            <text class="detail-label">æ¡Œå·</text>
            <text class="detail-value highlight">{{selectedOrder.table_no}}</text>
          </view>
          <view class="detail-row" wx:if="{{selectedOrder.pickup_number}}">
            <text class="detail-label">å–é¤å·</text>
            <text class="detail-value highlight">{{selectedOrder.pickup_number}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">ä¸‹å•æ—¶é—´</text>
            <text class="detail-value">{{selectedOrder.created_time}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">ç­‰å¾…æ—¶é—´</text>
            <text class="detail-value">{{selectedOrder.waiting_minutes}} åˆ†é’Ÿ</text>
          </view>
        </view>

        <view class="detail-section">
          <text class="section-title">å•†å“æ˜ç»†</text>
          <view class="item-list">
            <view wx:for="{{selectedOrder.items}}" wx:key="id" class="item-row">
              <view class="item-info">
                <text class="item-name">{{item.name}}</text>
                <text class="item-qty">Ã—{{item.quantity}}</text>
              </view>
              <view class="item-customs" wx:if="{{item.customizations && item.customizations.length > 0}}">
                <text wx:for="{{item.customizations}}" wx:for-item="c" wx:key="option_name" class="custom-tag">
                  {{c.option_name}}
                </text>
              </view>
            </view>
          </view>
        </view>

        <view class="detail-section" wx:if="{{selectedOrder.notes}}">
          <text class="section-title">è®¢å•å¤‡æ³¨</text>
          <view class="notes-box">{{selectedOrder.notes}}</view>
        </view>
      </view>
    </view>
  </view>
</view>
