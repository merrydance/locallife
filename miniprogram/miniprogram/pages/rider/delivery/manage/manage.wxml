<!--骑手配送管理页面-->
<view class="delivery-container">
  <!-- 加载状态 -->
  <t-loading wx:if="{{loading}}" theme="circular" size="40rpx" text="正在加载..." class="loading-container" />

  <!-- 主要内容 -->
  <view wx:else class="main-content">
    <!-- 骑手状态栏 -->
    <view wx:if="{{riderStatus}}" class="status-bar">
      <view class="status-info">
        <view class="status-badge" style="background: {{getRiderStatusColor(riderStatus.status)}}">
          {{formatRiderStatus(riderStatus.status)}}
        </view>
        <text class="status-text">今日配送: {{riderStatus.today_deliveries}}单</text>
        <text class="status-text">今日收入: ¥{{formatAmount(riderStatus.today_earnings)}}</text>
      </view>
      <t-button 
        theme="{{isOnline ? 'danger' : 'success'}}" 
        size="small" 
        bind:tap="toggleOnlineStatus"
      >
        {{isOnline ? '下线' : '上线'}}
      </t-button>
    </view>

    <!-- Tab导航 -->
    <t-tabs value="{{currentTab}}" bind:change="onTabChange" class="delivery-tabs">
      <t-tab-panel label="可接任务" value="available" />
      <t-tab-panel label="当前任务" value="active" />
      <t-tab-panel label="历史记录" value="history" />
    </t-tabs>

    <!-- 可接任务Tab -->
    <scroll-view wx:if="{{currentTab === 'available'}}" class="tab-content" scroll-y="true">
      <t-empty wx:if="{{availableTasks.length === 0}}" description="暂无可接任务" />

      <view wx:else class="task-list">
        <block wx:for="{{availableTasks}}" wx:key="delivery_id">
            <delivery-task-card 
                task="{{item}}" 
                type="available"
                bind:grab="grabOrder"
            />
        </block>
      </view>
    </scroll-view>

    <!-- 当前任务Tab -->
    <scroll-view wx:if="{{currentTab === 'active'}}" class="tab-content" scroll-y="true">
      <t-empty wx:if="{{activeTasks.length === 0}}" description="暂无进行中的任务" />

      <view wx:else class="task-list">
        <block wx:for="{{activeTasks}}" wx:key="delivery_id">
             <delivery-task-card 
                task="{{item}}" 
                type="active"
                bind:pickup="startPickup"
                bind:confirmPickup="confirmPickup"
                bind:deliver="startDelivery"
                bind:confirmDeliver="confirmDelivery"
                bind:exception="showExceptionDialog"
            />
        </block>
      </view>
    </scroll-view>

    <!-- 历史记录Tab -->
    <scroll-view wx:if="{{currentTab === 'history'}}" class="tab-content" scroll-y="true">
      <t-empty wx:if="{{historyTasks.length === 0}}" description="暂无历史记录" />

      <view wx:else class="task-list">
         <block wx:for="{{historyTasks}}" wx:key="delivery_id">
             <delivery-task-card 
                task="{{item}}" 
                type="history"
            />
        </block>
      </view>
    </scroll-view>
  </view>

  <!-- 异常上报弹窗 -->
  <t-popup 
    visible="{{showExceptionModal}}" 
    placement="center" 
    bind:visible-change="closeExceptionModal"
    class="exception-popup"
  >
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">上报异常</text>
        <t-icon name="close" size="32rpx" bind:tap="closeExceptionModal" />
      </view>

      <view class="modal-body">
        <t-cell-group>
          <t-cell title="异常类型">
            <t-input 
              slot="note"
              placeholder="请输入异常类型" 
              value="{{exceptionForm.exception_type}}"
            />
          </t-cell>

          <t-cell title="异常描述">
            <t-textarea 
              slot="note"
              placeholder="请详细描述异常情况" 
              value="{{exceptionForm.description}}"
              maxlength="200"
            />
          </t-cell>
        </t-cell-group>
      </view>

      <view class="modal-footer">
        <t-button theme="light" bind:tap="closeExceptionModal">取消</t-button>
        <t-button theme="primary" bind:tap="reportException">提交</t-button>
      </view>
    </view>
  </t-popup>
</view>
